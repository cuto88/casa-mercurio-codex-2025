# 2_vmc — Logica VMC Casa Mercurio

## Obiettivi
- Garantire ricambio aria continuo con priorità su sicurezza, comfort igrometrico e efficienza energetica.
- Coordinare VMC e climatizzatori (zone giorno/notte) rispettando gli hook core.

## Sensori e attuatori
- **Umidità bagno**: `sensor.umidita_bagno` (trigger boost locale).
- **UR interne**: `sensor.ur_in_media`, `sensor.umidita_interna_min` (anti-secco), `sensor.ur_out` per ΔUR.
- **Temperature**: `sensor.t_in_media`, `sensor.t_out`.
- **Umidità assoluta**: `sensor.ah_in`, `sensor.ah_out` per free-cooling/hook AC.
- **Velocità/attuatori VMC**: `switch.vmc_vel_0` … `switch.vmc_vel_3`, indice velocità `sensor.vmc_vel_index`.
- **Hook e manuale**: `binary_sensor.vmc_failsafe_sensors_bad`, `input_boolean.vmc_manual`, `input_select.vmc_manual_speed`, `timer.vmc_manual_timeout`.

## Collegamenti ai core rules
- Priorità P0–P4, lock min_on/min_off e max_run: **core/regole_core_logiche.md → sezione "VMC — Priorità, lock e schemi"**.
- Free-cooling (Passivhaus vs macchina) e interazione con AC: **core/regole_core_logiche.md → Schema free-cooling VMC**.
- Anti-secco notturno e blocco DRY: **core/regole_core_logiche.md → Schema anti-secco**.
- Hook AC↔VMC e arbitraggi: **core/regole_core_logiche.md → Regole di interazione AC↔VMC**.

## Eccezioni locali / tuning specifico
- Boost bagno: soglie 75% ON / 65% OFF, ΔUR bagno/esterno 10pt; lock ingresso 10m con cooldown 5m; downgrade soft a vel_2 se esterno molto più secco.
- ΔUR interno/esterno: attiva vel_2 se UR_media >50% e ΔUR ≥10pt, rilascia a 48% o ΔUR <8pt (runtime max 8m).
- Escalation DRY: se boost >75m con UR ancora alta richiede AC in DRY mantenendo VMC vel_1 (min_on AC 30m, max_run 120m).
- Free-cooling sdoppiato: preferenza Passivhaus (ΔAH favorevole), fallback “macchina” solo termico con T_out>20 °C; ingressi lock 15m, max_run 120m.
- Anti-secco: finestra novembre–marzo, ore 23–07, UR minima 40% con isteresi 42%; duty vel_1 per 5m ogni 30m su base vel_0.
- Watchdog: se nessuna condizione vera per >10m, fallback vel_1.

## Note di implementazione YAML
- Automatismi e sensori definiti in `packages/1_ventilation.yaml`; plancia in `lovelace/1_ventilation_plancia.yaml`.
- I timer/lock seguono la tabella core; aggiornare soglie tramite `input_number` dove previsto (es. soglie UR bagno, ΔUR passivhaus/macchina).
- Gli hook `hook_vmc_request_ac_block` e `hook_ac_request_vmc_low` sono cablati nei rispettivi package AC per DRY/COOL e nei lock VMC.

# 3_heating — Logica riscaldamento a pavimento Casa Mercurio

## Obiettivi
- Portare le zone abitate al target comfort (default 21 °C giorno/notte) sfruttando l’inerzia del pavimento.
- Privilegiare la finestra 10:00–16:00 per usare PV/guadagni solari, con eventuale pre-carica se presente surplus.
- Limitare i cicli brevi applicando lock min_on/min_off e monitorando max_run.

## Zone, sensori e attuatori
- Zone: giorno, notte1, notte2, bagno (tutte selezionabili via `input_boolean.heating_use_*`).
- Sensori temperatura: `sensor.t_in_giorno`, `sensor.t_in_notte1`, `sensor.t_in_notte2`, `sensor.t_in_bagno`; esterno `sensor.t_out` per valutare dispersione.
- Eventuali letture UR: sensori stanza se disponibili (usati solo per diagnostica/condensa, non per il trigger principale).
- Attuatori: interruttore generale `switch.4_ch_interrutore_3`; valvole di zona gestite dagli attuatori fisici collegati ai termostati; pompa/relay centralizzato pilotato tramite lo switch principale.

## Collegamenti ai core rules
- Regole di priorità, finestra 10–16, lock pavimento (min_on/min_off/max_run) e interazione con surplus sono definite in `core/regole_core_logiche.md` → sezione "Heating — Pavimento, lock e priorità".
- Questo modulo applica `heating_should_run` seguendo quei vincoli e rende visibile l’eventuale `hook_surplus_heating_precharge` proveniente dal modulo surplus.

## Eccezioni locali / tuning specifico
- Bagno: può richiedere comfort più alto; mantenere `heating_use_bagno` attivo per includerlo nei calcoli anche quando le altre zone sono soddisfatte.
- Deroga finestra 10–16: consentita solo per comfort critico (zone sotto target di oltre 1 °C) o emergenze; la deroga è limitata dai lock min_off.
- Anti-condensa locale: se sensori UR stanza segnalano valori molto alti, evitare pre-carica aggressiva e preferire spegnimento anticipato a target raggiunto.
- Manual override: `heating_force_on/off` e `heating_manual_active` seguono i lock core ma possono ignorare l’assenza di surplus.

## Note di implementazione YAML
- Configurazione e helper in `packages/2_heating.yaml` (toggle zona, target, tolleranza, finestra oraria, lock configurabili e contatori runtime).
- Automazioni pubblicano `binary_sensor.heating_should_run`, `binary_sensor.heating_min_on_lock`/`heating_min_off_lock`, flag finestra oraria e condizioni esterne.
- La plancia usa entità del pacchetto per mostrare KPI e comandi; non duplicare logica qui.

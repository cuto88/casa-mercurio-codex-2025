# 6_surplus — Logica gestione surplus energetico

Obiettivo: massimizzare l’uso di energia PV riducendo i prelievi da rete, coordinando i carichi a step e gli hook verso heating. Tutte le soglie e i lock condivisi fanno riferimento a `core/regole_core_logiche.md` (tabella lock surplus) e alle priorità P0–P3.

## Obiettivi e priorità
- **Priorità P3 (efficienza)**: usare surplus PV prima di consumare da rete, mantenendo margine per batteria/servizi critici.
- **Priorità P2 (comfort)**: permettere pre-carica heating quando PV sufficiente (`hook_surplus_heating_precharge`).
- **Priorità P1/P0**: spegnere carichi non essenziali in assenza di produzione o in caso di fault contatori.

## Fonti dati e indicatori
- Potenze istantanee: `sensor.pv_power_w`, `sensor.grid_power_w`, direzione `sensor.pv_direction` / `sensor.grid_direction`.
- Contatori energia (A/B) per oggi e trend 7/30gg.
- Parametri configurabili: `input_number.surplus_min_w` (soglia attivazione), `input_number.surplus_lock_minutes`, `input_boolean.surplus_enable`, flag `input_boolean.energy_debug`.

## Logica di attivazione carichi
1. **Valutazione surplus**: se produzione PV − consumo casa ≥ `surplus_min_w` e batteria (se presente) non in carica prioritaria → stato SURPLUS.
2. **Sequenza carichi a step** (coordinata con tabella lock):
   - Step 1: carico base (es. boiler / presa EV lenta) → min_on/min_off 20m.
   - Step 2: carico opzionale (es. EV veloce o pompa calore ACS) se surplus stabile > 2× soglia.
   - Ogni step rispetta `max_run 180m` e si disattiva se surplus scende sotto soglia per più del `min_off`.
3. **Rientro da deficit**: se grid_direction indica import sostenuto o PV power < soglia → spegnere progressivamente gli step (inverso) e uscire da P3.

## Integrazione con altri moduli
- **Heating pre-carica**: quando SURPLUS stabile e fascia heating attiva, alzare temporaneamente target o anticipare accensione tramite `hook_surplus_heating_precharge` (timeout 180m, rispettare lock heating).
- **VMC/AC**: nessun comando diretto; evitare che carichi surplus interferiscano con blocchi P0/P1 di sicurezza.
- **Debug**: `hook_debug_force_state` può simulare SURPLUS per testare i contatori senza attivare carichi reali.

## Riferimenti
- Logiche condivise: `core/regole_core_logiche.md` (priorità, lock, hook).
- Linee guida UI: `core/regole_plancia.md`.
- Plancia monitoraggio: `6_surplus_plancia_regole.txt`.

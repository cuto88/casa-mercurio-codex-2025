# 1 — Ventilation / VMC — Ventilazione naturale & night flush (packages/1_ventilation.yaml)
> ATTENZIONE: questo file descrive la logica di `packages/1_ventilation.yaml` e dovrebbe essere rinominato `1_ventilation_logic.md` per allinearsi alla struttura ufficiale.

## Obiettivo del modulo
- Suggerire apertura/chiusura serramenti e abilitare il night-flush estivo coordinato con la VMC per massimizzare il raffrescamento passivo.
- Evitare ingressi di umidità, pioggia, vento forte o PM elevato che peggiorerebbero comfort e qualità dell’aria interna, mantenendo coerenza con le priorità VMC del README.

## Mappa priorità
| Stato / priorità | KPI principali | Azione / logica |
| --- | --- | --- |
| **P0_failsafe** | Sensori meteo o termo-igrometrici `unknown/unavailable` o fuori range (`binary_sensor.vmc_failsafe_sensors_bad`) | Disabilita consigli e night-flush; mantiene rilasciati gli hook finché i sensori tornano validi. |
| **P1_night_flush** | Stagione calda + fascia 21:00–08:00 + ΔT/ΔAH favorevole + meteo ok | Suggerisce apertura serramenti, abilita `hook_vent_enable_night_flush` e mantiene la VMC su vel_2 durante il ciclo; blocca AC via `input_boolean.ac_block_vmc`. |
| **P2_recommend_open** | ΔT ≥ `input_number.vent_deltat_min` o ΔAH ≥ `input_number.vent_deltaah_min` + meteo ok | Raccomanda apertura serramenti con messaggio in `input_text.vent_messaggio_consiglio`; non blocca AC ma evita conflitto con freecooling. |
| **P3_recommend_close** | Meteo sfavorevole (pioggia/vento/PM) o ΔT/ΔAH invertiti | Raccomanda chiusura serramenti e rilascia night-flush/AC block. |
| **idle** | Nessuna condizione prevalente | Nessuna notifica; mantiene hook disattivati e monitora i KPI. |

## KPI e sensori chiave
- Meteo: `binary_sensor.vent_pioggia`, `binary_sensor.vent_condizioni_meteo_ok`, qualità aria (PM2.5), vento forte.
- Termo-igrometria: `sensor.delta_t_in_out`, `sensor.delta_ah_in_out`, `sensor.ur_in_media`, `sensor.ur_out`, `sensor.t_out`.
- Stato finestre: conteggio e flag stanza; override manuale `input_boolean.vent_override_estate` e timer lock.
- Output UI: `binary_sensor.vent_recommend_open`, `binary_sensor.vent_recommend_close`, `input_text.vent_messaggio_consiglio`.

## Hook / eventi verso altri moduli
- `hook_vent_enable_night_flush`: attiva night-flush VMC vel_2 e può pubblicare `input_boolean.ac_block_vmc` durante il ciclo.
- Coordinamento con VMC freecooling: rispetta `hook_vmc_request_ac_block` e non duplica ΔT/ΔAH usati da `sensor.vmc_reason`.
- Nessun controllo diretto su heating; fornisce solo suggerimenti ambientali.

## Casi particolari / failsafe / lock
- Anti-smog: sospende suggerimenti se PM2.5 o qualità aria fuori soglia anche con ΔT/ΔAH favorevoli.
- Lock timer evitano ping-pong di notifiche; l’override manuale estate disattiva i consigli mantenendo monitoraggio sensori.
- Stagionalità: logica primaria maggio–settembre; in inverno la ventilazione è demandata alla VMC con priorità P1/P2/P3 come da README.

## Note operative
- Riferimenti principali: `packages/1_ventilation.yaml` per automazioni e `lovelace/1_ventilation_plancia.yaml` per UI con ΔT/ΔAH e messaggi.
- `sensor.vmc_priority` e `sensor.vmc_reason` visualizzano le priorità VMC (P0_failsafe, P1_boost_bagno, P2_anti_secco, P3_freecooling, manual, idle) e sono la fonte di verità per l’intero modulo 1.
- Nessun riferimento a file legacy (es. 2_vmc.yaml); la logica ΔT/ΔAH è unificata nel pacchetto ufficiale.

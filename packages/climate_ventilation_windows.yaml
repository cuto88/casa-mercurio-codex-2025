# LEGACY MODULE (do not refactor)
# Migration status: legacy-owner
# Strangler: ClimateOps observes only (no actuation)
# Toggle: input_boolean.climateops_migration_enabled (future cutover)
---
###############################################################################
# 1_ventilation_windows.yaml – Aggregazione stato finestre per modulo VMC/Vent
# - alias (input_boolean) da sostituire con sensori reed reali
# - gruppi zona giorno/notte/bagno
# - binary_sensor aggregati e contatori
###############################################################################

input_boolean:
  vent_finestra_giorno1_aperta:
    name: "Ventilazione – Finestra zona giorno 1"
    icon: mdi:window-open-variant
  vent_finestra_giorno2_aperta:
    name: "Ventilazione – Finestra zona giorno 2"
    icon: mdi:window-open-variant
  vent_portoncino_ingresso_aperto:
    name: "Ventilazione – Portoncino ingresso"
    icon: mdi:door-open
  vent_foro_cappa_aperto:
    name: "Ventilazione – Foro cappa"
    icon: mdi:tailwind
  vent_finestra_notte1_aperta:
    name: "Ventilazione – Finestra zona notte 1"
    icon: mdi:window-open-variant
  vent_finestra_notte2_aperta:
    name: "Ventilazione – Finestra zona notte 2"
    icon: mdi:window-open-variant
  vent_finestra_notte3_aperta:
    name: "Ventilazione – Finestra zona notte 3"
    icon: mdi:window-open-variant
  vent_finestra_bagno_aperta:
    name: "Ventilazione – Finestra bagno"
    icon: mdi:window-open-variant

# TODO: sostituire gli input_boolean con i sensori finestra reali (binary_sensor.*)

group:
  windows_zona_giorno:
    name: "Finestre – Zona giorno"
    entities:
      - input_boolean.vent_finestra_giorno1_aperta
      - input_boolean.vent_finestra_giorno2_aperta
      - input_boolean.vent_portoncino_ingresso_aperto
      - input_boolean.vent_foro_cappa_aperto
  windows_zona_notte:
    name: "Finestre – Zona notte"
    entities:
      - input_boolean.vent_finestra_notte1_aperta
      - input_boolean.vent_finestra_notte2_aperta
      - input_boolean.vent_finestra_notte3_aperta
  windows_bagni:
    name: "Finestre – Bagni"
    entities:
      - input_boolean.vent_finestra_bagno_aperta

template:
  - binary_sensor:
      - name: "Finestre zona giorno aperte"
        unique_id: windows_giorno_any
        device_class: opening
        state: >
          {{ expand('group.windows_zona_giorno') | selectattr('state','eq','on') | list | count > 0 }}
      - name: "Finestre zona notte aperte"
        unique_id: windows_notte_any
        device_class: opening
        state: >
          {{ expand('group.windows_zona_notte') | selectattr('state','eq','on') | list | count > 0 }}
      - name: "Finestre bagno aperte"
        unique_id: windows_bagno_any
        device_class: opening
        state: >
          {{ expand('group.windows_bagni') | selectattr('state','eq','on') | list | count > 0 }}
      - name: "Casa chiusa"
        unique_id: windows_all_closed
        device_class: opening
        state: >
          {{
            expand('group.windows_zona_giorno') | selectattr('state','eq','on') | list | count == 0 and
            expand('group.windows_zona_notte') | selectattr('state','eq','on') | list | count == 0 and
            expand('group.windows_bagni') | selectattr('state','eq','on') | list | count == 0
          }}
  - sensor:
      - name: "Conteggio finestre aperte"
        unique_id: windows_open_count
        unit_of_measurement: "finestre"
        state: >
          {% set groups = [
            'group.windows_zona_giorno',
            'group.windows_zona_notte',
            'group.windows_bagni'
          ] %}
          {% set total = namespace(v=0) %}
          {% for g in groups %}
            {% set members = expand(g) | selectattr('state','eq','on') | list %}
            {% set total.v = total.v + (members | count) %}
          {% endfor %}
          {{ total.v }}
      - name: "vent_finestre_state"
        unique_id: vent_finestre_state
        icon: mdi:text
        state: >-
          {% set labels = {
            'input_boolean.vent_finestra_giorno1_aperta': 'Giorno – Finestra 1',
            'input_boolean.vent_finestra_giorno2_aperta': 'Giorno – Finestra 2',
            'input_boolean.vent_portoncino_ingresso_aperto': 'Portoncino ingresso',
            'input_boolean.vent_foro_cappa_aperto': 'Foro cappa',
            'input_boolean.vent_finestra_notte1_aperta': 'Zona notte 1',
            'input_boolean.vent_finestra_notte2_aperta': 'Zona notte 2',
            'input_boolean.vent_finestra_notte3_aperta': 'Zona notte 3',
            'input_boolean.vent_finestra_bagno_aperta': 'Bagno'
          } %}
          {% set aperte = [] %}
          {% for ent, label in labels.items() %}
            {% if is_state(ent,'on') %}
              {% set aperte = aperte + [label] %}
            {% endif %}
          {% endfor %}
          {{ ', '.join(aperte) if aperte else 'Tutte chiuse' }}

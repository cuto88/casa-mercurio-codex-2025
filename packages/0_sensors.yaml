###############################################################################
# Test Codex → GitHub → HA OK ✅
# 0_sensors.yaml — KPI canonici (senza mapping)
# SORGENTI (solo sensori attivi):
#  - Temperature:  sensor.t_in_giorno, sensor.t_in_notte1, sensor.t_in_bagno, sensor.t_out
#  - Umidità:      sensor.ur_in_giorno, sensor.ur_in_notte1, sensor.ur_in_bagno, sensor.ur_out
#  - Switch VMC:   switch.vmc_vel_0/1/2/3
#  - Switch AC:    switch.ac_notte, switch.ac_giorno
###############################################################################

# ==================== LISTA ENTIÀ DEFINITIVE ================================
# --- SENSORI BASE ------------------------------------------------------------
#   sensor.t_in_giorno
#   sensor.t_in_notte1
#   sensor.t_in_bagno
#   sensor.t_out
#   sensor.ur_in_giorno
#   sensor.ur_in_notte1
#   sensor.ur_in_bagno
#   sensor.ur_out
# --- DERIVATI CLIMATICI -----------------------------------------------------
#   sensor.t_in_media
#   sensor.ur_in_media
#   sensor.ur_in_min
#   sensor.ah_in
#   sensor.ah_out
#   sensor.dewpoint_in
#   sensor.delta_t_in_out
#   sensor.delta_ah_in_out
# --- DIAGNOSTICA / LOGICHE --------------------------------------------------
#   sensor.vmc_priority
#   sensor.vmc_reason
#   sensor.vmc_last_event
#   binary_sensor.stagione_calda
#   binary_sensor.stagione_fredda
# --- SWITCH -----------------------------------------------------------------
#   switch.vmc_vel_0
#   switch.vmc_vel_1
#   switch.vmc_vel_2
#   switch.vmc_vel_3
#   switch.ac_notte
#   switch.ac_giorno
###############################################################################

template:
  - sensor:
      # ==================== MEDIE / MINIMI INTERNE ===========================
      - name: "t_in_media"
        unit_of_measurement: "°C"
        state_class: measurement
        icon: mdi:thermometer
        availability: >-
          {{ states('sensor.t_in_giorno') not in ['unknown','unavailable','', none] or
             states('sensor.t_in_notte1') not in ['unknown','unavailable','', none] or
             states('sensor.t_in_notte2') not in ['unknown','unavailable','', none] or
             states('sensor.t_in_bagno') not in ['unknown','unavailable','', none] }}
        state: >-
          {% set e_list = [
            'sensor.t_in_giorno',
            'sensor.t_in_notte1',
            'sensor.t_in_notte2',
            'sensor.t_in_bagno'
          ] %}
          {% set ns = namespace(vals=[]) %}
          {% for e in e_list %}
            {% set v = states(e) %}
            {% if v not in ['unknown','unavailable','', none] %}
              {% set ns.vals = ns.vals + [ v|float(0) ] %}
            {% endif %}
          {% endfor %}
          {{ (ns.vals|sum / ns.vals|length)|round(1) if (ns.vals|length)>0 else 'unavailable' }}

      - name: "ur_in_media"
        unit_of_measurement: "%"
        device_class: humidity
        icon: mdi:water-percent
        availability: >-
          {{ states('sensor.ur_in_giorno') not in ['unknown','unavailable','', none] or
             states('sensor.ur_in_notte1') not in ['unknown','unavailable','', none] or
             states('sensor.ur_in_notte2') not in ['unknown','unavailable','', none] or
             states('sensor.ur_in_bagno') not in ['unknown','unavailable','', none] }}
        state: >-
          {% set e_list = [
            'sensor.ur_in_giorno',
            'sensor.ur_in_notte1',
            'sensor.ur_in_notte2',
            'sensor.ur_in_bagno'
          ] %}
          {% set ns = namespace(vals=[]) %}
          {% for e in e_list %}
            {% set v = states(e) %}
            {% if v not in ['unknown','unavailable','', none] %}
              {% set ns.vals = ns.vals + [ v|float(0) ] %}
            {% endif %}
          {% endfor %}
          {{ (ns.vals|sum / ns.vals|length)|round(0) if (ns.vals|length)>0 else 'unavailable' }}

      - name: "ur_in_min"
        unit_of_measurement: "%"
        device_class: humidity
        icon: mdi:water-percent
        availability: >-
          {{ states('sensor.ur_in_giorno') not in ['unknown','unavailable','', none] or
             states('sensor.ur_in_notte1') not in ['unknown','unavailable','', none] or
             states('sensor.ur_in_notte2') not in ['unknown','unavailable','', none] or
             states('sensor.ur_in_bagno') not in ['unknown','unavailable','', none] }}
        state: >-
          {% set e_list = [
            'sensor.ur_in_giorno',
            'sensor.ur_in_notte1',
            'sensor.ur_in_notte2',
            'sensor.ur_in_bagno'
          ] %}
          {% set ns = namespace(vals=[]) %}
          {% for e in e_list %}
            {% set v = states(e) %}
            {% if v not in ['unknown','unavailable','', none] %}
              {% set ns.vals = ns.vals + [ v|float(0) ] %}
            {% endif %}
          {% endfor %}
          {{ (ns.vals|min)|round(0) if (ns.vals|length)>0 else 'unavailable' }}

      # ==================== UMIDITÀ ASSOLUTA ================================
      - name: "ah_in"
        unit_of_measurement: "g/m³"
        state_class: measurement
        icon: mdi:water
        availability: >-
          {{ states('sensor.t_in_media') not in ['unknown','unavailable','', none] and
             states('sensor.ur_in_media') not in ['unknown','unavailable','', none] }}
        state: >-
          {% set T = states('sensor.t_in_media')|float(default=none) %}
          {% set RH = states('sensor.ur_in_media')|float(default=none) %}
          {% if T is number and RH is number %}
            {% set RHc = [RH, 100]|min %}
            {% set RHc = [RHc, 1]|max %}
            {% set es = 6.112 * pow(2.718281828, (17.67*T)/(T+243.5)) %}
            {% set pv = RHc/100 * es %}
            {{ (216.7 * pv / (T + 273.15)) | round(2) }}
          {% else %}unavailable{% endif %}

      - name: "ah_out"
        unit_of_measurement: "g/m³"
        state_class: measurement
        icon: mdi:water-outline
        availability: >-
          {{ states('sensor.t_out') not in ['unknown','unavailable','', none] and
             states('sensor.ur_out') not in ['unknown','unavailable','', none] }}
        state: >-
          {% set T = states('sensor.t_out')|float(default=none) %}
          {% set RH = states('sensor.ur_out')|float(default=none) %}
          {% if T is number and RH is number %}
            {% set RHc = [RH, 100]|min %}
            {% set RHc = [RHc, 1]|max %}
            {% set es = 6.112 * pow(2.718281828, (17.67*T)/(T+243.5)) %}
            {% set pv = RHc/100 * es %}
            {{ (216.7 * pv / (T + 273.15)) | round(2) }}
          {% else %}unavailable{% endif %}

      # ==================== DEW POINT & DELTE ================================
      - name: "dewpoint_in"
        unit_of_measurement: "°C"
        state_class: measurement
        icon: mdi:thermometer-alert
        availability: >-
          {{ states('sensor.t_in_media') not in ['unknown','unavailable','', none] and
             states('sensor.ur_in_media') not in ['unknown','unavailable','', none] }}
        state: >-
          {% set T = states('sensor.t_in_media')|float(default=none) %}
          {% set RH = states('sensor.ur_in_media')|float(default=none) %}
          {% if T is number and RH is number %}
            {% set RHc = [RH, 100]|min %}
            {% set RHc = [RHc, 1]|max %}
            {% set b = 17.62 %}{% set c = 243.12 %}
            {% set gamma = (b*T/(c+T)) + log(RHc/100) %}
            {{ (c*gamma / (b - gamma)) | round(1) }}
          {% else %}unavailable{% endif %}

      - name: "delta_t_in_out"
        unit_of_measurement: "°C"
        icon: mdi:delta
        availability: >-
          {{ states('sensor.t_in_media') not in ['unknown','unavailable','', none] and
             states('sensor.t_out') not in ['unknown','unavailable','', none] }}
        state: >-
          {{ (states('sensor.t_in_media')|float(0) - states('sensor.t_out')|float(0)) | round(1) }}

      - name: "delta_ah_in_out"
        unit_of_measurement: "g/m³"
        icon: mdi:delta
        availability: >-
          {{ states('sensor.ah_in') not in ['unknown','unavailable','', none] and
             states('sensor.ah_out') not in ['unknown','unavailable','', none] }}
        state: >-
          {{ (states('sensor.ah_in')|float(0) - states('sensor.ah_out')|float(0)) | round(2) }}


---
###############################################################################
# 0_sensors.yaml — Sensori climatici canonici e KPI base (ΔT/ΔAH)
# - ΔT in-out
# - ΔAH in-out
###############################################################################

template:
  - sensor:
      - name: "Temperatura esterna (canonico)"
        unique_id: t_out_canonico
        entity_id: sensor.t_out
        unit_of_measurement: "°C"
        device_class: temperature
        state_class: measurement
        icon: mdi:thermometer
        state: >-
          {# sorgente principale: sensore esterno reale #}
          {% set t_real = states('sensor.temperatura_esterna') %}
          {% if t_real not in ['unknown','unavailable',''] %}
            {{ t_real|float }}
          {% else %}
            {# fallback: meteo Open-Meteo #}
            {% set t_met = states('sensor.vent_meteo_temp') %}
            {% if t_met not in ['unknown','unavailable',''] %}
              {{ t_met|float }}
            {% else %}
              unknown
            {% endif %}
          {% endif %}
        availability: >-
          {{ states('sensor.temperatura_esterna') not in ['unknown','unavailable',''] or
             states('sensor.vent_meteo_temp') not in ['unknown','unavailable',''] }}
        # Home Assistant genererà l'entity_id sensor.t_out

      - name: "AH esterna (canonico)"
        unique_id: ah_out_canonico
        entity_id: sensor.ah_out
        unit_of_measurement: "g/m³"
        state_class: measurement
        icon: mdi:water-outline
        state: >-
          {# sorgente principale: sensore esterno reale (T + UR) #}
          {% set T_real = states('sensor.temperatura_esterna')|float(default=none) %}
          {% set RH_real = states('sensor.umidita_esterna')|float(default=none) %}
          {% if T_real is number and RH_real is number %}
            {% set T = T_real %}
            {% set RH = RH_real %}
          {% else %}
            {# fallback: meteo #}
            {% set T = states('sensor.vent_meteo_temp')|float(default=none) %}
            {% set RH = states('sensor.vent_meteo_rh')|float(default=none) %}
          {% endif %}

          {% if T is number and RH is number %}
            {% set RHc = [ [RH, 100]|min, 1]|max %}
            {% set exponent = (17.67*T)/(T+243.5) %}
            {% set es = 6.112 * (2.718281828 ** exponent) %}
            {% set pv = RHc/100 * es %}
            {{ (216.7 * pv / (T + 273.15)) | round(2) }}
          {% else %}
            unknown
          {% endif %}
        availability: >-
          {{ (states('sensor.temperatura_esterna') not in ['unknown','unavailable',''] and
              states('sensor.umidita_esterna') not in ['unknown','unavailable','']) or
             (states('sensor.vent_meteo_temp') not in ['unknown','unavailable',''] and
              states('sensor.vent_meteo_rh') not in ['unknown','unavailable','']) }}

      - name: "Delta T in-out"
        unique_id: delta_t_in_out
        unit_of_measurement: "°C"
        device_class: temperature
        state_class: measurement
        icon: mdi:thermometer-chevron-up
        state: >-
          {% set tin = states('sensor.t_in_media')|float(default=none) %}
          {% set tout = states('sensor.t_out')|float(default=none) %}
          {% if tin is number and tout is number %}
            {{ (tin - tout) | round(2) }}
          {% else %}
            unknown
          {% endif %}
        availability: >-
          {{ states('sensor.t_in_media') not in ['unknown','unavailable',''] and
             states('sensor.t_out') not in ['unknown','unavailable',''] }}

      - name: "Delta AH in-out"
        unique_id: delta_ah_in_out
        unit_of_measurement: "g/m³"
        state_class: measurement
        icon: mdi:water-percent
        state: >-
          {% set ah_in = states('sensor.ah_in')|float(default=none) %}
          {% set ah_out = states('sensor.ah_out')|float(default=none) %}
          {% if ah_in is number and ah_out is number %}
            {{ (ah_in - ah_out) | round(2) }}
          {% else %}
            unknown
          {% endif %}
        availability: >-
          {{ states('sensor.ah_in') not in ['unknown','unavailable',''] and
             states('sensor.ah_out') not in ['unknown','unavailable',''] }}

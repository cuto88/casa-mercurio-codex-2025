###############################################################################
# Test Codex → GitHub → HA OK ✅
# 0_sensors.yaml — KPI canonici (senza mapping)
# SORGENTI (solo sensori attivi):
#  - Temperature:  sensor.t_in_giorno, sensor.t_in_notte1, sensor.t_in_bagno, sensor.t_out
#  - Umidità:      sensor.ur_in_giorno, sensor.ur_in_notte1, sensor.ur_in_bagno, sensor.ur_out
#  - Switch VMC:   switch.vmc_vel_0/1/2/3
#  - Switch AC:    switch.ac_notte, switch.ac_giorno
###############################################################################

# ==================== LISTA ENTIÀ DEFINITIVE ================================
# --- SENSORI BASE ------------------------------------------------------------
#   sensor.t_in_giorno
#   sensor.t_in_notte1
#   sensor.t_in_bagno
#   sensor.t_out
#   sensor.ur_in_giorno
#   sensor.ur_in_notte1
#   sensor.ur_in_bagno
#   sensor.ur_out
# --- DERIVATI CLIMATICI -----------------------------------------------------
#   sensor.t_in_media
#   sensor.ur_in_media
#   sensor.ur_in_min
#   sensor.ah_in
#   sensor.ah_out
#   sensor.dewpoint_in
#   sensor.delta_t_in_out
#   sensor.delta_ah_in_out
# --- DIAGNOSTICA / LOGICHE --------------------------------------------------
#   sensor.vmc_priority
#   sensor.vmc_reason
#   sensor.vmc_last_event
#   binary_sensor.stagione_calda
#   binary_sensor.stagione_fredda
# --- SWITCH -----------------------------------------------------------------
#   switch.vmc_vel_0
#   switch.vmc_vel_1
#   switch.vmc_vel_2
#   switch.vmc_vel_3
#   switch.ac_notte
#   switch.ac_giorno
###############################################################################

template:
  - sensor:
      # ==================== MEDIE / MINIMI INTERNE ===========================
      - name: "t_in_media"
        unit_of_measurement: "°C"
        state_class: measurement
        icon: mdi:thermometer
        availability: >-
          {% set invalid = ['unknown','unavailable','', 'none', none, 'nan'] %}
          {{ states('sensor.t_in_giorno')|lower not in invalid or
             states('sensor.t_in_notte1')|lower not in invalid or
             states('sensor.t_in_notte2')|lower not in invalid or
             states('sensor.t_in_bagno')|lower not in invalid }}
        state: >-
          {% set e_list = [
            'sensor.t_in_giorno',
            'sensor.t_in_notte1',
            'sensor.t_in_notte2',
            'sensor.t_in_bagno'
          ] %}
          {% set invalid = ['unknown','unavailable','', 'none', 'nan'] %}
          {% set ns = namespace(vals=[]) %}
          {% for e in e_list %}
            {% set raw = states(e) %}
            {% set v = raw|string %}
            {% if v|lower not in invalid %}
              {% set ns.vals = ns.vals + [ raw|float(0) ] %}
            {% endif %}
          {% endfor %}
          {{ (ns.vals|sum / ns.vals|length)|round(1) if (ns.vals|length)>0 else 'unavailable' }}

      - name: "ur_in_media"
        unit_of_measurement: "%"
        device_class: humidity
        icon: mdi:water-percent
        availability: >-
          {% set invalid = ['unknown','unavailable','', 'none', none, 'nan'] %}
          {{ states('sensor.ur_in_giorno')|lower not in invalid or
             states('sensor.ur_in_notte1')|lower not in invalid or
             states('sensor.ur_in_notte2')|lower not in invalid or
             states('sensor.ur_in_bagno')|lower not in invalid }}
        state: >-
          {% set e_list = [
            'sensor.ur_in_giorno',
            'sensor.ur_in_notte1',
            'sensor.ur_in_notte2',
            'sensor.ur_in_bagno'
          ] %}
          {% set invalid = ['unknown','unavailable','', 'none', 'nan'] %}
          {% set ns = namespace(vals=[]) %}
          {% for e in e_list %}
            {% set raw = states(e) %}
            {% set v = raw|string %}
            {% if v|lower not in invalid %}
              {% set ns.vals = ns.vals + [ raw|float(0) ] %}
            {% endif %}
          {% endfor %}
          {{ (ns.vals|sum / ns.vals|length)|round(0) if (ns.vals|length)>0 else 'unavailable' }}

      - name: "ur_in_min"
        unit_of_measurement: "%"
        device_class: humidity
        icon: mdi:water-percent
        availability: >-
          {% set invalid = ['unknown','unavailable','', 'none', none, 'nan'] %}
          {{ states('sensor.ur_in_giorno')|lower not in invalid or
             states('sensor.ur_in_notte1')|lower not in invalid or
             states('sensor.ur_in_notte2')|lower not in invalid or
             states('sensor.ur_in_bagno')|lower not in invalid }}
        state: >-
          {% set e_list = [
            'sensor.ur_in_giorno',
            'sensor.ur_in_notte1',
            'sensor.ur_in_notte2',
            'sensor.ur_in_bagno'
          ] %}
          {% set invalid = ['unknown','unavailable','', 'none', 'nan'] %}
          {% set ns = namespace(vals=[]) %}
          {% for e in e_list %}
            {% set raw = states(e) %}
            {% set v = raw|string %}
            {% if v|lower not in invalid %}
              {% set ns.vals = ns.vals + [ raw|float(0) ] %}
            {% endif %}
          {% endfor %}
          {{ (ns.vals|min)|round(0) if (ns.vals|length)>0 else 'unavailable' }}

      # ==================== UMIDITÀ ASSOLUTA ================================
      - name: "ah_in"
        unit_of_measurement: "g/m³"
        state_class: measurement
        icon: mdi:water
        availability: >-
          {% set invalid = ['unknown','unavailable','', 'none', none, 'nan'] %}
          {{ states('sensor.t_in_media')|lower not in invalid and
             states('sensor.ur_in_media')|lower not in invalid }}
        state: >-
          {% set invalid = ['unknown','unavailable','', 'none', 'nan'] %}
          {% set T_raw = states('sensor.t_in_media') %}
          {% set RH_raw = states('sensor.ur_in_media') %}
          {% if T_raw|string|lower in invalid or RH_raw|string|lower in invalid %}
            unavailable
          {% else %}
            {% set T = T_raw|float %}
            {% set RH = RH_raw|float %}
            {% set RHc = [RH, 100]|min %}
            {% set RHc = [RHc, 1]|max %}
            {% set exponent = (17.67*T)/(T+243.5) %}
            {% if exponent|abs > 100 %}
              unavailable
            {% else %}
              {% set es = 6.112 * (2.718281828 ** exponent) %}
              {% set pv = RHc/100 * es %}
              {{ (216.7 * pv / (T + 273.15)) | round(2) }}
            {% endif %}
          {% endif %}

      - name: "ah_out"
        unit_of_measurement: "g/m³"
        state_class: measurement
        icon: mdi:water-outline
        availability: >-
          {% set invalid = ['unknown','unavailable','', 'none', none, 'nan'] %}
          {{ states('sensor.t_out')|lower not in invalid and
             states('sensor.ur_out')|lower not in invalid }}
        state: >-
          {% set invalid = ['unknown','unavailable','', 'none', 'nan'] %}
          {% set T_raw = states('sensor.t_out') %}
          {% set RH_raw = states('sensor.ur_out') %}
          {% if T_raw|string|lower in invalid or RH_raw|string|lower in invalid %}
            unavailable
          {% else %}
            {% set T = T_raw|float %}
            {% set RH = RH_raw|float %}
            {% set RHc = [RH, 100]|min %}
            {% set RHc = [RHc, 1]|max %}
            {% set exponent = (17.67*T)/(T+243.5) %}
            {% if exponent|abs > 100 %}
              unavailable
            {% else %}
              {% set es = 6.112 * (2.718281828 ** exponent) %}
              {% set pv = RHc/100 * es %}
              {{ (216.7 * pv / (T + 273.15)) | round(2) }}
            {% endif %}
          {% endif %}

      # ==================== DEW POINT & DELTE ================================
      - name: "dewpoint_in"
        unit_of_measurement: "°C"
        state_class: measurement
        icon: mdi:thermometer-alert
        availability: >-
          {% set invalid = ['unknown','unavailable','', 'none', none, 'nan'] %}
          {{ states('sensor.t_in_media')|lower not in invalid and
             states('sensor.ur_in_media')|lower not in invalid }}
        state: >-
          {% set invalid = ['unknown','unavailable','', 'none', 'nan'] %}
          {% set T_raw = states('sensor.t_in_media') %}
          {% set RH_raw = states('sensor.ur_in_media') %}
          {% if T_raw|string|lower in invalid or RH_raw|string|lower in invalid %}
            unavailable
          {% else %}
            {% set T = T_raw|float %}
            {% set RH = RH_raw|float %}
            {% set RHc = [RH, 100]|min %}
            {% set RHc = [RHc, 1]|max %}
            {% set b = 17.62 %}{% set c = 243.12 %}
            {% set gamma = (b*T/(c+T)) + log(RHc/100) %}
            {{ (c*gamma / (b - gamma)) | round(1) }}
          {% endif %}

      - name: "delta_t_in_out"
        unit_of_measurement: "°C"
        icon: mdi:delta
        availability: >-
          {% set invalid = ['unknown','unavailable','', none, 'nan'] %}
          {{ states('sensor.t_in_media')|lower not in invalid and
             states('sensor.t_out')|lower not in invalid }}
        state: >-
          {{ (states('sensor.t_in_media')|float(0) - states('sensor.t_out')|float(0)) | round(1) }}

      - name: "delta_ah_in_out"
        unit_of_measurement: "g/m³"
        icon: mdi:delta
        availability: >-
          {% set invalid = ['unknown','unavailable','', none, 'nan'] %}
          {{ states('sensor.ah_in')|lower not in invalid and
             states('sensor.ah_out')|lower not in invalid }}
        state: >-
          {{ (states('sensor.ah_in')|float(0) - states('sensor.ah_out')|float(0)) | round(2) }}


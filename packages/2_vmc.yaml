###############################################################################
# 2_vmc.yaml — CORE LOGIC (reattivo, autosufficiente)
# Allineato ai KPI/entità base fornite:
#  - Temperature:  sensor.t_out, sensor.t_in_giorno, sensor.t_in_bagno,
#                  sensor.t_in_notte1, sensor.t_in_notte2, sensor.t_in_notte3,
#                  sensor.t_lavanderia (opz.)
#  - Umidità:      sensor.ur_out, sensor.ur_in_giorno, sensor.ur_in_bagno,
#                  sensor.ur_in_notte1, sensor.ur_in_notte2, sensor.ur_in_notte3,
#                  sensor.ur_lavanderia (opz.)
#  - KPI derivati usati qui: sensor.t_in_media, sensor.ur_in_media,
#                            sensor.ur_in_min, sensor.ah_in, sensor.ah_out
#  - Attuatori:    switch.vmc_vel_0/1/2/3, switch.ac_notte, switch.ac_giorno
###############################################################################

# =============================
# 1) HELPER & COMANDI MANUALI
# =============================
input_boolean:
  vmc_manual:
    name: Modalità manuale
    icon: mdi:hand

input_select:
  vmc_manual_speed:
    name: Velocità manuale
    options: [OFF, vel_0, vel_1, vel_2, vel_3]
    icon: mdi:fan

timer:
  vmc_manual_timeout:
    name: Timeout modalità manuale
    duration: "01:00:00"

  vmc_anti_secco_lock:
    name: "VMC lock anti-secco"
    duration: "00:15:00"

  vmc_boost_lock:
    name: "VMC lock bagno boost"
    duration: "00:12:00"

  vmc_freecooling_max_run:
    name: "VMC max-run free-cooling"
    duration: "02:00:00"

# Helper locali (soglie)
input_number:
  vmc_bagno_on:
    name: "Bagno — UR ON"
    min: 40
    max: 90
    step: 1
    unit_of_measurement: "%"
    mode: slider
    icon: mdi:water-percent
    initial: 75

  vmc_bagno_off:
    name: "Bagno — UR OFF"
    min: 40
    max: 90
    step: 1
    unit_of_measurement: "%"
    mode: slider
    icon: mdi:water-percent
    initial: 65

  vmc_fc_ph_tin_on:
    name: "FC (PH) — T_in ON"
    min: 18
    max: 28
    step: 0.5
    unit_of_measurement: "°C"
    mode: slider
    icon: mdi:thermometer
    initial: 24

  vmc_fc_macchina_tout_min:
    name: "FC (Macchina) — T_out min"
    min: 5
    max: 25
    step: 0.5
    unit_of_measurement: "°C"
    mode: slider
    icon: mdi:thermometer-low
    initial: 20

  vmc_anti_secco_ur_min:
    name: "Anti-secco — UR_min"
    min: 20
    max: 60
    step: 1
    unit_of_measurement: "%"
    mode: slider
    icon: mdi:water-percent-alert
    initial: 40

# =============================
# 2) RIASSUNTO PRIORITÀ
# =============================
#   P0) Failsafe               → spegni TUTTI i relè vel_0/1/2/3
#   OV) AC notte = DRY         → vel_0
#   P1) Bagno / BOOST          → vel_3 (solo se UR_bagno ≥ soglia ON)
#   P1-Lite) ΔUR interno alto  → vel_2 (UR_media >50% e UR_out almeno 10pt più bassa)
#   P1B) Escalation DRY        → aiuto AC Notte/Giorno se boost >75’ e UR alta
#   P2) Free-cooling           → vel_2
#   P3) Inverno / Anti-secco   → vel_0
#   P4) Baseline               → vel_1

# =============================
# 3) LOGICHE AUTOMAZIONI
# =============================
automation:
  - id: vmc_manual_override
    alias: "VMC — Modalità manuale (override velocità)"
    mode: restart
    triggers:
      - trigger: state
        entity_id:
          - input_boolean.vmc_manual
          - input_select.vmc_manual_speed
    actions:
      - choose:
          - conditions:
              - condition: state
                entity_id: input_boolean.vmc_manual
                state: "on"
            sequence:
              - service: timer.start
                target:
                  entity_id: timer.vmc_manual_timeout
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ states('input_select.vmc_manual_speed') == 'vel_0' }}"
                    sequence:
                      - service: switch.turn_off
                        target:
                          entity_id:
                            - switch.vmc_vel_1
                            - switch.vmc_vel_2
                            - switch.vmc_vel_3
                      - service: switch.turn_on
                        target:
                          entity_id: switch.vmc_vel_0
                  - conditions:
                      - condition: template
                        value_template: "{{ states('input_select.vmc_manual_speed') == 'vel_1' }}"
                    sequence:
                      - service: switch.turn_off
                        target:
                          entity_id:
                            - switch.vmc_vel_0
                            - switch.vmc_vel_2
                            - switch.vmc_vel_3
                      - service: switch.turn_on
                        target:
                          entity_id: switch.vmc_vel_1
                  - conditions:
                      - condition: template
                        value_template: "{{ states('input_select.vmc_manual_speed') == 'vel_2' }}"
                    sequence:
                      - service: switch.turn_off
                        target:
                          entity_id:
                            - switch.vmc_vel_0
                            - switch.vmc_vel_1
                            - switch.vmc_vel_3
                      - service: switch.turn_on
                        target:
                          entity_id: switch.vmc_vel_2
                  - conditions:
                      - condition: template
                        value_template: "{{ states('input_select.vmc_manual_speed') == 'vel_3' }}"
                    sequence:
                      - service: switch.turn_off
                        target:
                          entity_id:
                            - switch.vmc_vel_0
                            - switch.vmc_vel_1
                            - switch.vmc_vel_2
                      - service: switch.turn_on
                        target:
                          entity_id: switch.vmc_vel_3
        default:
          - service: switch.turn_off
            target:
              entity_id:
                - switch.vmc_vel_0
                - switch.vmc_vel_1
                - switch.vmc_vel_2
                - switch.vmc_vel_3

  - id: vmc_manual_timeout
    alias: "VMC — Timeout modalità manuale"
    mode: single
    triggers:
      - trigger: event
        event_type: timer.finished
        event_data:
          entity_id: timer.vmc_manual_timeout
      - trigger: state
        entity_id: input_boolean.vmc_manual
        to: "off"
    actions:
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.vmc_manual

  - id: vmc_p0_failsafe
    alias: "VMC P0 — Failsafe sensori"
    mode: restart
    triggers:
      - trigger: state
        entity_id: binary_sensor.vmc_failsafe_sensors_bad
      - trigger: time_pattern
        minutes: "/5"
    conditions:
      - condition: state
        entity_id: binary_sensor.vmc_failsafe_sensors_bad
        state: "on"
    actions:
      - service: switch.turn_on
        target:
          entity_id: switch.vmc_vel_0
      - service: switch.turn_off
        target:
          entity_id:
            - switch.vmc_vel_1
            - switch.vmc_vel_2
            - switch.vmc_vel_3
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ state_attr('sensor.vmc_reason','reason') != 'P0_failsafe' }}"
            sequence:
              - event: template_event
                event_data:
                  entity_id: sensor.vmc_reason
                  attributes:
                    reason: "P0_failsafe"

  - id: vmc_controllo_prioritario
    alias: "VMC — Controllo priorità P0–P4"
    mode: restart
    triggers:
      - trigger: time_pattern
        minutes: "/2"
      - trigger: state
        entity_id:
          - sensor.ur_in_min
          - sensor.delta_ah_in_out
          - sensor.ur_in_bagno
          - sensor.ur_in_media
          - sensor.ur_out
          - sensor.t_in_media
          - sensor.t_out
          - binary_sensor.stagione_calda
          - input_boolean.vmc_manual
          - input_number.vmc_bagno_on
          - input_number.vmc_freecooling_delta
          - input_number.vmc_freecooling_delta_ah
    actions:
      - choose:
          - conditions:
              - condition: state
                entity_id: binary_sensor.vmc_failsafe_sensors_bad
                state: "on"
            sequence: []
          - conditions:
              - condition: state
                entity_id: input_boolean.vmc_manual
                state: "on"
            sequence: []
          - conditions:
              - condition: template
                value_template: "{{ is_state('timer.vmc_anti_secco_lock','active') }}"
            sequence:
              - service: switch.turn_off
                target:
                  entity_id:
                    - switch.vmc_vel_0
                    - switch.vmc_vel_2
                    - switch.vmc_vel_3
              - service: switch.turn_on
                target:
                  entity_id: switch.vmc_vel_1
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ state_attr('sensor.vmc_reason','reason') != 'P1_anti_secco' }}"
                    sequence:
                      - event: template_event
                        event_data:
                          entity_id: sensor.vmc_reason
                          attributes:
                            reason: "P1_anti_secco"
          - conditions:
              - condition: template
                value_template: "{{ is_state('timer.vmc_boost_lock','active') }}"
            sequence:
              - service: switch.turn_off
                target:
                  entity_id:
                    - switch.vmc_vel_0
                    - switch.vmc_vel_1
                    - switch.vmc_vel_2
              - service: switch.turn_on
                target:
                  entity_id: switch.vmc_vel_3
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ state_attr('sensor.vmc_reason','reason') != 'P2_boost_bagno' }}"
                    sequence:
                      - event: template_event
                        event_data:
                          entity_id: sensor.vmc_reason
                          attributes:
                            reason: "P2_boost_bagno"
          - conditions:
              - condition: template
                value_template: "{{ is_state('timer.vmc_freecooling_max_run','active') }}"
            sequence:
              - service: switch.turn_off
                target:
                  entity_id:
                    - switch.vmc_vel_0
                    - switch.vmc_vel_1
                    - switch.vmc_vel_3
              - service: switch.turn_on
                target:
                  entity_id: switch.vmc_vel_2
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ state_attr('sensor.vmc_reason','reason') != 'P3_freecooling' }}"
                    sequence:
                      - event: template_event
                        event_data:
                          entity_id: sensor.vmc_reason
                          attributes:
                            reason: "P3_freecooling"
          - conditions:
              - condition: template
                value_template: >
                  {% set ur_min = states('sensor.ur_in_min')|float(100) %}
                  {% set soglia = states('input_number.vmc_ur_min') %}
                  {% set soglia_val = soglia|float(40) if soglia not in ['unknown','unavailable','', none] else 40 %}
                  {% set delta_ah = states('sensor.delta_ah_in_out')|float(0) %}
                  {{ (ur_min < soglia_val) or (ur_min < 40) or (delta_ah > 10) }}
            sequence:
              - service: switch.turn_off
                target:
                  entity_id:
                    - switch.vmc_vel_0
                    - switch.vmc_vel_2
                    - switch.vmc_vel_3
              - service: switch.turn_on
                target:
                  entity_id: switch.vmc_vel_1
              - service: timer.start
                target:
                  entity_id: timer.vmc_anti_secco_lock
              - event: hook_vmc_request_ac_block
                event_data:
                  reason: "anti_secco"
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ state_attr('sensor.vmc_reason','reason') != 'P1_anti_secco' }}"
                    sequence:
                      - event: template_event
                        event_data:
                          entity_id: sensor.vmc_reason
                          attributes:
                            reason: "P1_anti_secco"
          - conditions:
              - condition: template
                value_template: >
                  {% set ur_b = states('sensor.ur_in_bagno')|float(0) %}
                  {% set soglia = states('input_number.vmc_bagno_on')|float(75) %}
                  {% set ur_out = states('sensor.ur_out')|float(0) %}
                  {% set ur_media = states('sensor.ur_in_media')|float(0) %}
                  {% set delta_ok = (ur_b - ur_out) >= 10 %}
                  {% set media_ok = (ur_media > 50) and ((ur_media - ur_out) > 10) %}
                  {{ (ur_b >= soglia) or delta_ok or media_ok }}
            sequence:
              - service: switch.turn_off
                target:
                  entity_id:
                    - switch.vmc_vel_0
                    - switch.vmc_vel_1
                    - switch.vmc_vel_2
              - service: switch.turn_on
                target:
                  entity_id: switch.vmc_vel_3
              - service: timer.start
                target:
                  entity_id: timer.vmc_boost_lock
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ state_attr('sensor.vmc_reason','reason') != 'P2_boost_bagno' }}"
                    sequence:
                      - event: template_event
                        event_data:
                          entity_id: sensor.vmc_reason
                          attributes:
                            reason: "P2_boost_bagno"
          - conditions:
              - condition: template
                value_template: >
                  {% set Tin = states('sensor.t_in_media')|float(0) %}
                  {% set Tout = states('sensor.t_out')|float(0) %}
                  {% set AHin = states('sensor.ah_in')|float(0) %}
                  {% set AHout = states('sensor.ah_out')|float(0) %}
                  {% set dT = states('input_number.vmc_freecooling_delta')|float(2) %}
                  {% set dAH = states('input_number.vmc_freecooling_delta_ah')|float(2) %}
                  {{ is_state('binary_sensor.stagione_calda','on') and ((Tout < (Tin - dT)) or (AHout < (AHin - dAH))) }}
            sequence:
              - service: switch.turn_off
                target:
                  entity_id:
                    - switch.vmc_vel_0
                    - switch.vmc_vel_1
                    - switch.vmc_vel_3
              - service: switch.turn_on
                target:
                  entity_id: switch.vmc_vel_2
              - service: timer.start
                target:
                  entity_id: timer.vmc_freecooling_max_run
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ states('sensor.ah_out')|float(0) > states('sensor.ah_in')|float(0) }}"
                    sequence:
                      - event: hook_vmc_request_ac_block
                        event_data:
                          reason: "delta_AH_sfavorevole"
              - event: hook_vent_enable_night_flush
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ state_attr('sensor.vmc_reason','reason') != 'P3_freecooling' }}"
                    sequence:
                      - event: template_event
                        event_data:
                          entity_id: sensor.vmc_reason
                          attributes:
                            reason: "P3_freecooling"
          - conditions:
              - condition: template
                value_template: "{{ True }}"
            sequence:
              - service: switch.turn_off
                target:
                  entity_id:
                    - switch.vmc_vel_0
                    - switch.vmc_vel_2
                    - switch.vmc_vel_3
              - service: switch.turn_on
                target:
                  entity_id: switch.vmc_vel_1
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ state_attr('sensor.vmc_reason','reason') != 'idle' }}"
                    sequence:
                      - event: template_event
                        event_data:
                          entity_id: sensor.vmc_reason
                          attributes:
                            reason: "idle"

  - id: vmc_hook_ac_request_vmc_low
    alias: "VMC — Hook richiesta AC: forza vel_1"
    mode: restart
    triggers:
      - trigger: event
        event_type: hook_ac_request_vmc_low
    conditions:
      - condition: state
        entity_id: binary_sensor.vmc_failsafe_sensors_bad
        state: "off"
    actions:
      - service: switch.turn_off
        target:
          entity_id:
            - switch.vmc_vel_0
            - switch.vmc_vel_2
            - switch.vmc_vel_3
      - service: switch.turn_on
        target:
          entity_id: switch.vmc_vel_1

  - id: vmc_hook_night_flush
    alias: "VMC — Hook ventilazione notturna"
    mode: restart
    triggers:
      - trigger: event
        event_type: hook_vent_enable_night_flush
    conditions:
      - condition: state
        entity_id: binary_sensor.stagione_calda
        state: "on"
      - condition: template
        value_template: "{{ states('sensor.t_out')|float(0) < states('sensor.t_in_media')|float(0) }}"
    actions:
      - service: switch.turn_off
        target:
          entity_id:
            - switch.vmc_vel_0
            - switch.vmc_vel_1
            - switch.vmc_vel_3
      - service: switch.turn_on
        target:
          entity_id: switch.vmc_vel_2
      - service: timer.start
        target:
          entity_id: timer.vmc_freecooling_max_run

template:
  - binary_sensor:
      - name: "VMC failsafe — sensori non ok"
        unique_id: vmc_failsafe_sensors_bad
        object_id: vmc_failsafe_sensors_bad
        icon: mdi:alert-circle
        state: >
          {% set specs = {
            'sensor.t_in_media': [-20, 50],
            'sensor.t_out': [-20, 50],
            'sensor.ur_in_media': [0, 100],
            'sensor.ur_out': [0, 100],
            'sensor.ah_in': [0, none],
            'sensor.ah_out': [0, none],
            'sensor.ur_in_bagno': [0, 100]
          } %}
          {% set bad = namespace(items=[]) %}
          {% for key, limits in specs.items() %}
            {% set raw = states(key) %}
            {% set val = raw|float(default=none) if raw not in ['unknown','unavailable','', none] else none %}
            {% if val is none %}
              {% set bad.items = bad.items + [key] %}
            {% else %}
              {% if (limits[0] is not none and val < limits[0]) or (limits[1] is not none and val > limits[1]) %}
                {% set bad.items = bad.items + [key] %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {{ bad.items | count > 0 }}
        attributes:
          problematic_sensors: >
            {% set specs = {
              'sensor.t_in_media': [-20, 50],
              'sensor.t_out': [-20, 50],
              'sensor.ur_in_media': [0, 100],
              'sensor.ur_out': [0, 100],
              'sensor.ah_in': [0, none],
              'sensor.ah_out': [0, none],
              'sensor.ur_in_bagno': [0, 100]
            } %}
            {% set bad = [] %}
            {% for key, limits in specs.items() %}
              {% set raw = states(key) %}
              {% set val = raw|float(default=none) if raw not in ['unknown','unavailable','', none] else none %}
              {% if val is none %}
                {% set bad = bad + [key] %}
              {% else %}
                {% if (limits[0] is not none and val < limits[0]) or (limits[1] is not none and val > limits[1]) %}
                  {% set bad = bad + [key] %}
                {% endif %}
              {% endif %}
            {% endfor %}
            {{ bad }}

      - name: "VMC Override AC notte = DRY"
        unique_id: vmc_override_ac_dry
        icon: mdi:shield-refresh
        state: >
          {{ is_state('switch.ac_notte','on') and is_state('switch.vmc_vel_0','on') }}

      - name: "VMC Bagno Boost attivo"
        unique_id: vmc_bagno_boost
        icon: mdi:fan-speed-3
        state: >
          {% set ur_b_raw = states('sensor.ur_in_bagno') %}
          {% set ur_b = ur_b_raw|float(default=none) if ur_b_raw not in ['unknown','unavailable','', none] else none %}
          {% set ur_o_raw = states('sensor.ur_out') %}
          {% set ur_o = ur_o_raw|float(default=none) if ur_o_raw not in ['unknown','unavailable','', none] else none %}
          {% set ur_m_raw = states('sensor.ur_in_media') %}
          {% set ur_m = ur_m_raw|float(default=none) if ur_m_raw not in ['unknown','unavailable','', none] else none %}
          {% set soglia_raw = states('input_number.vmc_bagno_on') %}
          {% set soglia = soglia_raw|float(75) if soglia_raw not in ['unknown','unavailable','', none] else 75 %}
          {% set delta = (ur_b - ur_o) if (ur_b is not none and ur_o is not none) else none %}
          {% set main_boost = (ur_b is not none and ur_b >= soglia) or (delta is not none and delta >= 10) %}
          {% set lite = ur_m is not none and ur_o is not none and ur_m > 50 and (ur_m - ur_o) >= 10 %}
          {% set soft = is_state('switch.vmc_vel_2','on') and main_boost and lite and (ur_b is none or ur_o < ur_b) %}
          {{ is_state('switch.vmc_vel_3','on') or soft }}

      - name: "VMC Free-cooling PH attivo"
        unique_id: vmc_free_cooling_ph
        icon: mdi:snowflake-thermometer
        state: >
          {% set Tin_raw  = states('sensor.t_in_media') %}
          {% set Tin = Tin_raw|float(default=none) if Tin_raw not in ['unknown','unavailable','', none] else none %}
          {% set Tout_raw = states('sensor.t_out') %}
          {% set Tout = Tout_raw|float(default=none) if Tout_raw not in ['unknown','unavailable','', none] else none %}
          {% set AHin_raw  = states('sensor.ah_in') %}
          {% set AHin = AHin_raw|float(default=none) if AHin_raw not in ['unknown','unavailable','', none] else none %}
          {% set AHout_raw = states('sensor.ah_out') %}
          {% set AHout = AHout_raw|float(default=none) if AHout_raw not in ['unknown','unavailable','', none] else none %}
          {% set T_on_raw = states('input_number.vmc_fc_ph_tin_on') %}
          {% set T_on = T_on_raw|float(24) if T_on_raw not in ['unknown','unavailable','', none] else 24 %}
          {{ Tin is not none and Tout is not none and AHin is not none and AHout is not none and
             Tin > T_on and Tout < Tin and AHout < AHin and
             is_state('switch.vmc_vel_3','off') and is_state('switch.ac_notte','off') and is_state('switch.ac_giorno','off') and
             is_state('switch.vmc_vel_2','on') }}

      - name: "VMC Free-cooling Macchina attivo"
        unique_id: vmc_free_cooling_machine
        icon: mdi:home-thermometer-outline
        state: >
          {% set Tin_raw  = states('sensor.t_in_media') %}
          {% set Tin = Tin_raw|float(default=none) if Tin_raw not in ['unknown','unavailable','', none] else none %}
          {% set Tout_raw = states('sensor.t_out') %}
          {% set Tout = Tout_raw|float(default=none) if Tout_raw not in ['unknown','unavailable','', none] else none %}
          {% set T_on_raw = states('input_number.vmc_fc_ph_tin_on') %}
          {% set T_on = T_on_raw|float(24) if T_on_raw not in ['unknown','unavailable','', none] else 24 %}
          {% set T_min_raw = states('input_number.vmc_fc_macchina_tout_min') %}
          {% set T_min = T_min_raw|float(20) if T_min_raw not in ['unknown','unavailable','', none] else 20 %}
          {% set AHin_raw  = states('sensor.ah_in') %}
          {% set AHin = AHin_raw|float(default=none) if AHin_raw not in ['unknown','unavailable','', none] else none %}
          {% set AHout_raw = states('sensor.ah_out') %}
          {% set AHout = AHout_raw|float(default=none) if AHout_raw not in ['unknown','unavailable','', none] else none %}
          {% set ph = Tin is not none and Tout is not none and AHin is not none and AHout is not none and
                     Tin > T_on and Tout < Tin and AHout < AHin %}
          {% set macchina = Tin is not none and Tout is not none and Tin > T_on and Tout < Tin and Tout > T_min %}
          {{ macchina and not ph and is_state('switch.vmc_vel_3','off') and
             is_state('switch.ac_notte','off') and is_state('switch.ac_giorno','off') and is_state('switch.vmc_vel_2','on') }}

      - name: "VMC Anti-secco attivo"
        unique_id: vmc_anti_secco
        icon: mdi:water-percent-alert
        state: >
          {% set m = now().month %}
          {% set notte = now().hour >= 23 or now().hour < 7 %}
          {% set ur_min_raw = states('sensor.ur_in_min') %}
          {% set ur_min = ur_min_raw|float(default=none) if ur_min_raw not in ['unknown','unavailable','', none] else none %}
          {% set soglia_raw = states('input_number.vmc_anti_secco_ur_min') %}
          {% set soglia = soglia_raw|float(40) if soglia_raw not in ['unknown','unavailable','', none] else 40 %}
          {{ (m in [11,12,1,2,3]) and notte and ur_min is not none and (ur_min <= soglia) and is_state('switch.vmc_vel_0','on') }}

      - name: "VMC DRY attivo (P1B)"
        object_id: vmc_dry_active
        unique_id: vmc_dry_active
        icon: mdi:water-remove
        state: >
          {{ is_state('switch.ac_notte','on') or is_state('switch.ac_giorno','on') }}
        attributes:
          started_minutes_ago: >
            {% set ns = namespace(times=[]) %}
            {% set ent_n = states.get('switch.ac_notte') %}
            {% set ent_g = states.get('switch.ac_giorno') %}
            {% for obj in [ent_n, ent_g] %}
              {% if obj is not none and obj.last_changed is defined %}
                {% set ns.times = ns.times + [obj.last_changed] %}
              {% endif %}
            {% endfor %}
            {% if ns.times %}
              {{ ((now() - (ns.times | max)).total_seconds() / 60) | round(0) }}
            {% else %}
              0
            {% endif %}

      - name: "Stagione calda"
        unique_id: stagione_calda
        state: >
          {{ now().month in [5,6,7,8,9] }}

      - name: "Stagione fredda"
        unique_id: stagione_fredda
        state: >
          {{ now().month in [11,12,1,2,3] }}

  - sensor:
      - name: "UR interna minima"
        unique_id: ur_in_min
        object_id: ur_in_min
        unit_of_measurement: "%"
        icon: mdi:water-percent
        state_class: measurement
        state: >
          {% set sensors = [
            'sensor.ur_in_giorno',
            'sensor.ur_in_notte1',
            'sensor.ur_in_notte2',
            'sensor.ur_in_notte3',
            'sensor.ur_in_bagno',
            'sensor.ur_lavanderia'
          ] %}
          {% set values = [] %}
          {% for s in sensors %}
            {% set raw = states(s) %}
            {% if raw not in ['unknown','unavailable','', none] %}
              {% set values = values + [ raw | float ] %}
            {% endif %}
          {% endfor %}
          {{ (values | min | round(1)) if values | length > 0 else 'unknown' }}

      - name: "VMC Vel target"
        unique_id: vmc_vel_target
        icon: mdi:fan
        state: >
          {% if is_state('switch.vmc_vel_3','on') %}vel_3
          {% elif is_state('switch.vmc_vel_2','on') %}vel_2
          {% elif is_state('switch.vmc_vel_1','on') %}vel_1
          {% elif is_state('switch.vmc_vel_0','on') %}vel_0
          {% else %}off{% endif %}

      - name: "VMC velocità indice"
        unique_id: vmc_vel_index
        object_id: vmc_vel_index
        unit_of_measurement: "step"
        icon: mdi:fan-speed-1
        state_class: measurement
        state: >
          {% if is_state('switch.vmc_vel_3','on') %}3
          {% elif is_state('switch.vmc_vel_2','on') %}2
          {% elif is_state('switch.vmc_vel_1','on') %}1
          {% elif is_state('switch.vmc_vel_0','on') %}0
          {% else %}0{% endif %}

      - name: "VMC Reason"
        unique_id: vmc_reason
        icon: mdi:text
        state: >
          {% set Tin_raw = states('sensor.t_in_media') %}
          {% set Tin = Tin_raw|float(default=none) if Tin_raw not in ['unknown','unavailable','', none] else none %}
          {% set Tout_raw = states('sensor.t_out') %}
          {% set Tout = Tout_raw|float(default=none) if Tout_raw not in ['unknown','unavailable','', none] else none %}
          {% set AHin_raw = states('sensor.ah_in') %}
          {% set AHin = AHin_raw|float(default=none) if AHin_raw not in ['unknown','unavailable','', none] else none %}
          {% set AHout_raw = states('sensor.ah_out') %}
          {% set AHout = AHout_raw|float(default=none) if AHout_raw not in ['unknown','unavailable','', none] else none %}
          {% set URb_raw = states('sensor.ur_in_bagno') %}
          {% set URb = URb_raw|float(default=none) if URb_raw not in ['unknown','unavailable','', none] else none %}
          {% set URo_raw = states('sensor.ur_out') %}
          {% set URo = URo_raw|float(default=none) if URo_raw not in ['unknown','unavailable','', none] else none %}
          {% set URm_raw = states('sensor.ur_in_media') %}
          {% set URm = URm_raw|float(default=none) if URm_raw not in ['unknown','unavailable','', none] else none %}
          {% set soglia_raw = states('input_number.vmc_bagno_on') %}
          {% set soglia = soglia_raw|float(75) if soglia_raw not in ['unknown','unavailable','', none] else 75 %}
          {% set delta_ur = (URb - URo) if (URb is not none and URo is not none) else none %}
          {% set soft_boost = is_state('binary_sensor.vmc_bagno_boost','on') and is_state('switch.vmc_vel_2','on') %}
          {% set fc_ph = is_state('binary_sensor.vmc_free_cooling_ph','on') %}
          {% set fc_mac = is_state('binary_sensor.vmc_free_cooling_machine','on') %}
          {% set lite_ok = URm is not none and URo is not none and URm > 50 and (URm - URo) >= 10 %}
          {% set p1_lite = is_state('switch.vmc_vel_2','on') and not soft_boost and lite_ok and not fc_ph and not fc_mac %}
          {% if is_state('switch.vmc_vel_3','on') %}
            Boost bagno: UR_bagno={{ URb|round(1) if URb is not none else 'n/d' }}% (ΔUR={{ delta_ur|round(1) if delta_ur is not none else 'n/d' }}%)
          {% elif soft_boost %}
            Boost bagno soft (vel_2: aria esterna più secca, target 50%): UR_media={{ URm|round(1) if URm is not none else 'n/d' }}%, UR_esterna={{ URo|round(1) if URo is not none else 'n/d' }}%
          {% elif fc_ph %}
            Free-cooling Passivhaus: Tin {{ Tin|round(1) if Tin is not none else 'n/d' }}°C, Tout {{ Tout|round(1) if Tout is not none else 'n/d' }}°C, AH_out {{ AHout|round(1) if AHout is not none else 'n/d' }} < AH_in {{ AHin|round(1) if AHin is not none else 'n/d' }}
          {% elif fc_mac %}
            Free-cooling macchina: Tin {{ Tin|round(1) if Tin is not none else 'n/d' }}°C, Tout {{ Tout|round(1) if Tout is not none else 'n/d' }}°C (fascia macchina)
          {% elif p1_lite %}
            Aria esterna molto più secca (P1-Lite): UR_media={{ URm|round(1) if URm is not none else 'n/d' }}%, UR_esterna={{ URo|round(1) if URo is not none else 'n/d' }}%
          {% elif is_state('binary_sensor.vmc_anti_secco','on') %}
            Anti-secco: UR_interna_min ≤ soglia notturna
          {% elif is_state('switch.ac_notte','on') and is_state('switch.vmc_vel_0','on') %}
            Override: AC notte = DRY → VMC vel_0
          {% elif is_state('switch.vmc_vel_1','on') %}
            Nessuna condizione prioritaria → baseline
          {% elif is_state('switch.vmc_vel_0','on') %}
            Failsafe/spegnimento forzato
          {% else %}—{% endif %}

      - name: "VMC Last Event"
        unique_id: vmc_last_event
        icon: mdi:clock-outline
        state: "{{ states('input_text.vmc_last_event') if states('input_text.vmc_last_event') not in ['unknown','unavailable'] else '—' }}"

      - name: "VMC Priority"
        unique_id: vmc_priority
        icon: mdi:arrow-top-right-bold-outline
        state: >
          {% set URb_raw = states('sensor.ur_in_bagno') %}
          {% set URb = URb_raw|float(default=none) if URb_raw not in ['unknown','unavailable','', none] else none %}
          {% set URo_raw = states('sensor.ur_out') %}
          {% set URo = URo_raw|float(default=none) if URo_raw not in ['unknown','unavailable','', none] else none %}
          {% set URm_raw = states('sensor.ur_in_media') %}
          {% set URm = URm_raw|float(default=none) if URm_raw not in ['unknown','unavailable','', none] else none %}
          {% set soglia_raw = states('input_number.vmc_bagno_on') %}
          {% set soglia = soglia_raw|float(75) if soglia_raw not in ['unknown','unavailable','', none] else 75 %}
          {% set delta_ur = (URb - URo) if (URb is not none and URo is not none) else none %}
          {% set soft_boost = is_state('binary_sensor.vmc_bagno_boost','on') and is_state('switch.vmc_vel_2','on') %}
          {% set lite_ok = URm is not none and URo is not none and URm > 50 and (URm - URo) >= 10 %}
          {% set fc_ph = is_state('binary_sensor.vmc_free_cooling_ph','on') %}
          {% set fc_mac = is_state('binary_sensor.vmc_free_cooling_machine','on') %}
          {% set p1_lite = is_state('switch.vmc_vel_2','on') and not soft_boost and lite_ok and not fc_ph and not fc_mac %}
          {% if is_state('binary_sensor.vmc_bagno_boost','on') %}P1 — Bagno/BOOST
          {% elif p1_lite %}P1-Lite — ΔUR interno vs esterno
          {% elif is_state('switch.vmc_vel_2','on') %}P2 — Free-cooling
          {% elif is_state('binary_sensor.vmc_anti_secco','on') %}P3 — Anti-secco
          {% elif is_state('switch.ac_notte','on') and is_state('switch.vmc_vel_0','on') %}OV — AC notte = DRY
          {% elif is_state('switch.vmc_vel_1','on') %}P4 — Baseline
          {% elif is_state('switch.vmc_vel_0','on') %}P0 — Failsafe/Stop
          {% else %}—{% endif %}

input_text:
  vmc_last_event:
    name: "VMC — Last Event"
    max: 120
    mode: text

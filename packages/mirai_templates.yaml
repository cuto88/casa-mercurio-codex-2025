template:
  - binary_sensor:
      - name: "MIRAI status word bit 00"
        unique_id: mirai_status_word_bit_00
        availability: >
          {{ states('sensor.mirai_status_word_raw') not in ['unknown','unavailable','none','None',''] }}
        state: >
          {% set v = states('sensor.mirai_status_word_raw') | int(0) %}
          {{ (v | bitwise_and(2**0)) != 0 }}
      - name: "MIRAI status word bit 01"
        unique_id: mirai_status_word_bit_01
        availability: >
          {{ states('sensor.mirai_status_word_raw') not in ['unknown','unavailable','none','None',''] }}
        state: >
          {% set v = states('sensor.mirai_status_word_raw') | int(0) %}
          {{ (v | bitwise_and(2**1)) != 0 }}
      - name: "MIRAI status word bit 02"
        unique_id: mirai_status_word_bit_02
        availability: >
          {{ states('sensor.mirai_status_word_raw') not in ['unknown','unavailable','none','None',''] }}
        state: >
          {% set v = states('sensor.mirai_status_word_raw') | int(0) %}
          {{ (v | bitwise_and(2**2)) != 0 }}
      - name: "MIRAI status word bit 03"
        unique_id: mirai_status_word_bit_03
        availability: >
          {{ states('sensor.mirai_status_word_raw') not in ['unknown','unavailable','none','None',''] }}
        state: >
          {% set v = states('sensor.mirai_status_word_raw') | int(0) %}
          {{ (v | bitwise_and(2**3)) != 0 }}
      - name: "MIRAI status word bit 04"
        unique_id: mirai_status_word_bit_04
        availability: >
          {{ states('sensor.mirai_status_word_raw') not in ['unknown','unavailable','none','None',''] }}
        state: >
          {% set v = states('sensor.mirai_status_word_raw') | int(0) %}
          {{ (v | bitwise_and(2**4)) != 0 }}
      - name: "MIRAI status word bit 05"
        unique_id: mirai_status_word_bit_05
        availability: >
          {{ states('sensor.mirai_status_word_raw') not in ['unknown','unavailable','none','None',''] }}
        state: >
          {% set v = states('sensor.mirai_status_word_raw') | int(0) %}
          {{ (v | bitwise_and(2**5)) != 0 }}
      - name: "MIRAI status word bit 06"
        unique_id: mirai_status_word_bit_06
        availability: >
          {{ states('sensor.mirai_status_word_raw') not in ['unknown','unavailable','none','None',''] }}
        state: >
          {% set v = states('sensor.mirai_status_word_raw') | int(0) %}
          {{ (v | bitwise_and(2**6)) != 0 }}
      - name: "MIRAI status word bit 07"
        unique_id: mirai_status_word_bit_07
        availability: >
          {{ states('sensor.mirai_status_word_raw') not in ['unknown','unavailable','none','None',''] }}
        state: >
          {% set v = states('sensor.mirai_status_word_raw') | int(0) %}
          {{ (v | bitwise_and(2**7)) != 0 }}
      - name: "MIRAI status word bit 08"
        unique_id: mirai_status_word_bit_08
        availability: >
          {{ states('sensor.mirai_status_word_raw') not in ['unknown','unavailable','none','None',''] }}
        state: >
          {% set v = states('sensor.mirai_status_word_raw') | int(0) %}
          {{ (v | bitwise_and(2**8)) != 0 }}
      - name: "MIRAI status word bit 09"
        unique_id: mirai_status_word_bit_09
        availability: >
          {{ states('sensor.mirai_status_word_raw') not in ['unknown','unavailable','none','None',''] }}
        state: >
          {% set v = states('sensor.mirai_status_word_raw') | int(0) %}
          {{ (v | bitwise_and(2**9)) != 0 }}
      - name: "MIRAI status word bit 10"
        unique_id: mirai_status_word_bit_10
        availability: >
          {{ states('sensor.mirai_status_word_raw') not in ['unknown','unavailable','none','None',''] }}
        state: >
          {% set v = states('sensor.mirai_status_word_raw') | int(0) %}
          {{ (v | bitwise_and(2**10)) != 0 }}
      - name: "MIRAI status word bit 11"
        unique_id: mirai_status_word_bit_11
        availability: >
          {{ states('sensor.mirai_status_word_raw') not in ['unknown','unavailable','none','None',''] }}
        state: >
          {% set v = states('sensor.mirai_status_word_raw') | int(0) %}
          {{ (v | bitwise_and(2**11)) != 0 }}
      - name: "MIRAI status word bit 12"
        unique_id: mirai_status_word_bit_12
        availability: >
          {{ states('sensor.mirai_status_word_raw') not in ['unknown','unavailable','none','None',''] }}
        state: >
          {% set v = states('sensor.mirai_status_word_raw') | int(0) %}
          {{ (v | bitwise_and(2**12)) != 0 }}
      - name: "MIRAI status word bit 13"
        unique_id: mirai_status_word_bit_13
        availability: >
          {{ states('sensor.mirai_status_word_raw') not in ['unknown','unavailable','none','None',''] }}
        state: >
          {% set v = states('sensor.mirai_status_word_raw') | int(0) %}
          {{ (v | bitwise_and(2**13)) != 0 }}
      - name: "MIRAI status word bit 14"
        unique_id: mirai_status_word_bit_14
        availability: >
          {{ states('sensor.mirai_status_word_raw') not in ['unknown','unavailable','none','None',''] }}
        state: >
          {% set v = states('sensor.mirai_status_word_raw') | int(0) %}
          {{ (v | bitwise_and(2**14)) != 0 }}
      - name: "MIRAI status word bit 15"
        unique_id: mirai_status_word_bit_15
        availability: >
          {{ states('sensor.mirai_status_word_raw') not in ['unknown','unavailable','none','None',''] }}
        state: >
          {% set v = states('sensor.mirai_status_word_raw') | int(0) %}
          {{ (v | bitwise_and(2**15)) != 0 }}
      - name: "MIRAI internal circulator on"
        unique_id: mirai_internal_circulator_on
        availability: >
          {{ states('sensor.mirai_l243_internal_circulator') not in ['unknown','unavailable','none','None',''] }}
        state: >
          {{ states('sensor.mirai_l243_internal_circulator') | int(0) != 0 }}
      - name: "MIRAI relaunch pump on"
        unique_id: mirai_relaunch_pump_on
        availability: >
          {{ states('sensor.mirai_l244_relaunch_pump') not in ['unknown','unavailable','none','None',''] }}
        state: >
          {{ states('sensor.mirai_l244_relaunch_pump') | int(0) != 0 }}
      - name: "MIRAI antifreeze lvl1 on"
        unique_id: mirai_antifreeze_lvl1_on
        availability: >
          {{ states('sensor.mirai_l241_antifreeze_lvl1') not in ['unknown','unavailable','none','None',''] }}
        state: >
          {{ states('sensor.mirai_l241_antifreeze_lvl1') | int(0) != 0 }}
      - name: "MIRAI antifreeze lvl2 on"
        unique_id: mirai_antifreeze_lvl2_on
        availability: >
          {{ states('sensor.mirai_l242_antifreeze_lvl2') not in ['unknown','unavailable','none','None',''] }}
        state: >
          {{ states('sensor.mirai_l242_antifreeze_lvl2') | int(0) != 0 }}

  - sensor:
      - name: "MIRAI status bits ON"
        unique_id: mirai_status_bits_on
        icon: mdi:format-list-bulleted
        availability: >
          {{ states('sensor.mirai_status_word_raw') not in ['unknown','unavailable','none','None',''] }}
        state: >
          {% set v = states('sensor.mirai_status_word_raw') | int(0) %}
          {% set bits = [] %}
          {% for i in range(0,16) %}
            {% if (v | bitwise_and(2**i)) != 0 %}
              {% set bits = bits + [i] %}
            {% endif %}
          {% endfor %}
          {{ bits | join(',') }}
      - name: "MIRAI compressor step"
        unique_id: mirai_compressor_step
        availability: >
          {{ states('sensor.mirai_l261_compressor_step') not in ['unknown','unavailable','none','None',''] }}
        state: >
          {{ states('sensor.mirai_l261_compressor_step') | int(0) }}
      - name: "MIRAI outlet water temp °C"
        unique_id: mirai_outlet_water_temp_c
        availability: >
          {{ states('sensor.mirai_l162_outlet_water_temp') not in ['unknown','unavailable','none','None',''] }}
        device_class: temperature
        unit_of_measurement: "°C"
        state_class: measurement
        state: >
          {{ states('sensor.mirai_l162_outlet_water_temp') | float(0) | round(1) }}
      - name: "MIRAI L261 compressor step final"
        unique_id: mirai_l261_compressor_step_final
        availability: >
          {% set a = states('sensor.mirai_l261_compressor_step_a') %}
          {% set b = states('sensor.mirai_l261_compressor_step_b') %}
          {{ a not in ['unknown','unavailable','none','None',''] or b not in ['unknown','unavailable','none','None',''] }}
        state: >
          {% set a = states('sensor.mirai_l261_compressor_step_a') %}
          {% set b = states('sensor.mirai_l261_compressor_step_b') %}
          {% if a not in ['unknown','unavailable','none','None',''] %}
            {{ a | int(0) }}
          {% elif b not in ['unknown','unavailable','none','None',''] %}
            {{ b | int(0) }}
          {% else %}
            {{ 'unknown' }}
          {% endif %}
        attributes:
          source: >
            {% set a = states('sensor.mirai_l261_compressor_step_a') %}
            {% set b = states('sensor.mirai_l261_compressor_step_b') %}
            {% if a not in ['unknown','unavailable','none','None',''] %}
              A
            {% elif b not in ['unknown','unavailable','none','None',''] %}
              B
            {% else %}
              none
            {% endif %}
      - name: "MIRAI L243 internal circulator final"
        unique_id: mirai_l243_internal_circulator_final
        availability: >
          {% set a = states('sensor.mirai_l243_internal_circulator_a') %}
          {% set b = states('sensor.mirai_l243_internal_circulator_b') %}
          {{ a not in ['unknown','unavailable','none','None',''] or b not in ['unknown','unavailable','none','None',''] }}
        state: >
          {% set a = states('sensor.mirai_l243_internal_circulator_a') %}
          {% set b = states('sensor.mirai_l243_internal_circulator_b') %}
          {% if a not in ['unknown','unavailable','none','None',''] %}
            {{ a | int(0) }}
          {% elif b not in ['unknown','unavailable','none','None',''] %}
            {{ b | int(0) }}
          {% else %}
            {{ 'unknown' }}
          {% endif %}
        attributes:
          source: >
            {% set a = states('sensor.mirai_l243_internal_circulator_a') %}
            {% set b = states('sensor.mirai_l243_internal_circulator_b') %}
            {% if a not in ['unknown','unavailable','none','None',''] %}
              A
            {% elif b not in ['unknown','unavailable','none','None',''] %}
              B
            {% else %}
              none
            {% endif %}
      - name: "MIRAI L244 relaunch pump final"
        unique_id: mirai_l244_relaunch_pump_final
        availability: >
          {% set a = states('sensor.mirai_l244_relaunch_pump_a') %}
          {% set b = states('sensor.mirai_l244_relaunch_pump_b') %}
          {{ a not in ['unknown','unavailable','none','None',''] or b not in ['unknown','unavailable','none','None',''] }}
        state: >
          {% set a = states('sensor.mirai_l244_relaunch_pump_a') %}
          {% set b = states('sensor.mirai_l244_relaunch_pump_b') %}
          {% if a not in ['unknown','unavailable','none','None',''] %}
            {{ a | int(0) }}
          {% elif b not in ['unknown','unavailable','none','None',''] %}
            {{ b | int(0) }}
          {% else %}
            {{ 'unknown' }}
          {% endif %}
        attributes:
          source: >
            {% set a = states('sensor.mirai_l244_relaunch_pump_a') %}
            {% set b = states('sensor.mirai_l244_relaunch_pump_b') %}
            {% if a not in ['unknown','unavailable','none','None',''] %}
              A
            {% elif b not in ['unknown','unavailable','none','None',''] %}
              B
            {% else %}
              none
            {% endif %}
      - name: "MIRAI L241 antifreeze lvl1 final"
        unique_id: mirai_l241_antifreeze_lvl1_final
        availability: >
          {% set a = states('sensor.mirai_l241_antifreeze_lvl1_a') %}
          {% set b = states('sensor.mirai_l241_antifreeze_lvl1_b') %}
          {{ a not in ['unknown','unavailable','none','None',''] or b not in ['unknown','unavailable','none','None',''] }}
        state: >
          {% set a = states('sensor.mirai_l241_antifreeze_lvl1_a') %}
          {% set b = states('sensor.mirai_l241_antifreeze_lvl1_b') %}
          {% if a not in ['unknown','unavailable','none','None',''] %}
            {{ a | int(0) }}
          {% elif b not in ['unknown','unavailable','none','None',''] %}
            {{ b | int(0) }}
          {% else %}
            {{ 'unknown' }}
          {% endif %}
        attributes:
          source: >
            {% set a = states('sensor.mirai_l241_antifreeze_lvl1_a') %}
            {% set b = states('sensor.mirai_l241_antifreeze_lvl1_b') %}
            {% if a not in ['unknown','unavailable','none','None',''] %}
              A
            {% elif b not in ['unknown','unavailable','none','None',''] %}
              B
            {% else %}
              none
            {% endif %}
      - name: "MIRAI L242 antifreeze lvl2 final"
        unique_id: mirai_l242_antifreeze_lvl2_final
        availability: >
          {% set a = states('sensor.mirai_l242_antifreeze_lvl2_a') %}
          {% set b = states('sensor.mirai_l242_antifreeze_lvl2_b') %}
          {{ a not in ['unknown','unavailable','none','None',''] or b not in ['unknown','unavailable','none','None',''] }}
        state: >
          {% set a = states('sensor.mirai_l242_antifreeze_lvl2_a') %}
          {% set b = states('sensor.mirai_l242_antifreeze_lvl2_b') %}
          {% if a not in ['unknown','unavailable','none','None',''] %}
            {{ a | int(0) }}
          {% elif b not in ['unknown','unavailable','none','None',''] %}
            {{ b | int(0) }}
          {% else %}
            {{ 'unknown' }}
          {% endif %}
        attributes:
          source: >
            {% set a = states('sensor.mirai_l242_antifreeze_lvl2_a') %}
            {% set b = states('sensor.mirai_l242_antifreeze_lvl2_b') %}
            {% if a not in ['unknown','unavailable','none','None',''] %}
              A
            {% elif b not in ['unknown','unavailable','none','None',''] %}
              B
            {% else %}
              none
            {% endif %}
      - name: "MIRAI debug snapshot"
        unique_id: mirai_debug_snapshot
        icon: mdi:bug-outline
        state: >
          {% set ts = now().strftime('%Y-%m-%d %H:%M:%S') %}
          {% set status_word = states('sensor.mirai_status_word_raw') %}
          {% set status_code = states('sensor.mirai_status_code_raw') %}
          {% set fault_code = states('sensor.mirai_fault_code_raw') %}
          {% set bits_on = states('sensor.mirai_status_bits_on') %}
          {% set l261_a = states('sensor.mirai_l261_compressor_step_a') %}
          {% set l261_b = states('sensor.mirai_l261_compressor_step_b') %}
          {% set l261_final = states('sensor.mirai_l261_compressor_step_final') %}
          {% set l261_source = state_attr('sensor.mirai_l261_compressor_step_final', 'source') %}
          {% set l243_a = states('sensor.mirai_l243_internal_circulator_a') %}
          {% set l243_b = states('sensor.mirai_l243_internal_circulator_b') %}
          {% set l243_final = states('sensor.mirai_l243_internal_circulator_final') %}
          {% set l243_source = state_attr('sensor.mirai_l243_internal_circulator_final', 'source') %}
          {% set l244_a = states('sensor.mirai_l244_relaunch_pump_a') %}
          {% set l244_b = states('sensor.mirai_l244_relaunch_pump_b') %}
          {% set l244_final = states('sensor.mirai_l244_relaunch_pump_final') %}
          {% set l244_source = state_attr('sensor.mirai_l244_relaunch_pump_final', 'source') %}
          {% set l241_a = states('sensor.mirai_l241_antifreeze_lvl1_a') %}
          {% set l241_b = states('sensor.mirai_l241_antifreeze_lvl1_b') %}
          {% set l241_final = states('sensor.mirai_l241_antifreeze_lvl1_final') %}
          {% set l241_source = state_attr('sensor.mirai_l241_antifreeze_lvl1_final', 'source') %}
          {% set l242_a = states('sensor.mirai_l242_antifreeze_lvl2_a') %}
          {% set l242_b = states('sensor.mirai_l242_antifreeze_lvl2_b') %}
          {% set l242_final = states('sensor.mirai_l242_antifreeze_lvl2_final') %}
          {% set l242_source = state_attr('sensor.mirai_l242_antifreeze_lvl2_final', 'source') %}
          time: {{ ts }}
          status_word_raw: {{ status_word }}
          bits_on: {{ bits_on }}
          status_code_raw: {{ status_code }}
          fault_code_raw: {{ fault_code }}
          L261_COMPRESSOR_STEP: {{ l261_final }} (A={{ l261_a }}, B={{ l261_b }}, source={{ l261_source }})
          L243_INTERNAL_CIRCULATOR: {{ l243_final }} (A={{ l243_a }}, B={{ l243_b }}, source={{ l243_source }})
          L244_RELAUNCH_PUMP: {{ l244_final }} (A={{ l244_a }}, B={{ l244_b }}, source={{ l244_source }})
          L241_ANTIFREEZE_LVL1: {{ l241_final }} (A={{ l241_a }}, B={{ l241_b }}, source={{ l241_source }})
          L242_ANTIFREEZE_LVL2: {{ l242_final }} (A={{ l242_a }}, B={{ l242_b }}, source={{ l242_source }})

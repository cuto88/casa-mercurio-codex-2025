template:
  - sensor:
      - name: "MIRAI temperature inlet water"
        unique_id: mirai_temperature_inlet_water
        device_class: temperature
        unit_of_measurement: "°C"
        state: >
          {% set raw = states('sensor.mirai_l161_inlet_water_temp') %}
          {% if raw in ['unknown','unavailable','none','None',''] %}
            unknown
          {% else %}
            {% set v = raw | float %}
            {% set scaled = (v * 10) | round(0) | int %}
            {% if scaled in [-32768, 32767] %}
              unknown
            {% else %}
              {{ v }}
            {% endif %}
          {% endif %}

      - name: "MIRAI temperature outlet water"
        unique_id: mirai_temperature_outlet_water
        device_class: temperature
        unit_of_measurement: "°C"
        state: >
          {% set raw = states('sensor.mirai_l162_outlet_water_temp') %}
          {% if raw in ['unknown','unavailable','none','None',''] %}
            unknown
          {% else %}
            {% set v = raw | float %}
            {% set scaled = (v * 10) | round(0) | int %}
            {% if scaled in [-32768, 32767] %}
              unknown
            {% else %}
              {{ v }}
            {% endif %}
          {% endif %}

      - name: "MIRAI temperature outdoor air"
        unique_id: mirai_temperature_outdoor_air
        device_class: temperature
        unit_of_measurement: "°C"
        state: >
          {% set raw = states('sensor.mirai_l163_outdoor_temp') %}
          {% if raw in ['unknown','unavailable','none','None',''] %}
            unknown
          {% else %}
            {% set v = raw | float %}
            {% set scaled = (v * 10) | round(0) | int %}
            {% if scaled in [-32768, 32767] %}
              unknown
            {% else %}
              {{ v }}
            {% endif %}
          {% endif %}

      - name: "MIRAI status bits ON"
        unique_id: mirai_status_bits_on
        icon: mdi:format-list-bulleted
        availability: >
          {{ states('sensor.mirai_status_word_raw') not in ['unknown','unavailable','none','None',''] }}
        state: >
          {% set v = states('sensor.mirai_status_word_raw') | int(0) %}
          {% set bits = [] %}
          {% for i in range(0,16) %}
            {% if (v | bitwise_and(2**i)) != 0 %}
              {% set bits = bits + [i] %}
            {% endif %}
          {% endfor %}
          {{ bits | join(',') }}

      - name: "MIRAI snapshot"
        unique_id: mirai_snapshot
        icon: mdi:clipboard-text
        state: >
          {% set a = states %}
          TIME: {{ now() }}

          STATUS_WORD_RAW: {{ a('sensor.mirai_status_word_raw') }}
          STATUS_BITS_ON: {{ a('sensor.mirai_status_bits_on') }}
          STATUS_CODE_RAW: {{ a('sensor.mirai_status_code_raw') }}
          FAULT_CODE_RAW: {{ a('sensor.mirai_fault_code_raw') }}

          L243_INTERNAL_CIRCULATOR: {{ a('sensor.mirai_l243_internal_circulator') }}
          L244_RELAUNCH_PUMP: {{ a('sensor.mirai_l244_relaunch_pump') }}
          L261_COMPRESSOR_STEP: {{ a('sensor.mirai_l261_compressor_step') }}
          L241_ANTIFREEZE_LVL1: {{ a('sensor.mirai_l241_antifreeze_lvl1') }}
          L242_ANTIFREEZE_LVL2: {{ a('sensor.mirai_l242_antifreeze_lvl2') }}

          L161_INLET_WATER_TEMP: {{ a('sensor.mirai_l161_inlet_water_temp') }}
          L162_OUTLET_WATER_TEMP: {{ a('sensor.mirai_l162_outlet_water_temp') }}
          L163_OUTDOOR_TEMP: {{ a('sensor.mirai_l163_outdoor_temp') }}

      - name: "MIRAI snapshot compact"
        unique_id: mirai_snapshot_compact
        icon: mdi:clipboard-text-outline
        state: >
          step={{ states('sensor.mirai_l261_compressor_step') }}
          circ={{ states('sensor.mirai_l243_internal_circulator') }}
          tin={{ states('sensor.mirai_temperature_inlet_water') }}
          tout={{ states('sensor.mirai_temperature_outlet_water') }}
          tOut={{ states('sensor.mirai_temperature_outdoor_air') }}
          af1={{ states('sensor.mirai_l241_antifreeze_lvl1') }}
          af2={{ states('sensor.mirai_l242_antifreeze_lvl2') }}

  - binary_sensor:
      - name: "MIRAI compressore attivo"
        unique_id: mirai_compressore_attivo
        state: >
          {{ states('sensor.mirai_l261_compressor_step') | int(0) > 0 }}

      - name: "MIRAI circolatore attivo"
        unique_id: mirai_circolatore_attivo
        state: >
          {{ states('sensor.mirai_l243_internal_circulator') | int(0) == 1 }}

      - name: "MIRAI status word bit 00"
        unique_id: mirai_status_word_bit_00
        availability: >
          {{ states('sensor.mirai_status_word_raw') not in ['unknown','unavailable','none','None',''] }}
        state: >
          {% set v = states('sensor.mirai_status_word_raw') | int(0) %}
          {{ (v | bitwise_and(2**0)) != 0 }}
      - name: "MIRAI status word bit 01"
        unique_id: mirai_status_word_bit_01
        availability: >
          {{ states('sensor.mirai_status_word_raw') not in ['unknown','unavailable','none','None',''] }}
        state: >
          {% set v = states('sensor.mirai_status_word_raw') | int(0) %}
          {{ (v | bitwise_and(2**1)) != 0 }}
      - name: "MIRAI status word bit 02"
        unique_id: mirai_status_word_bit_02
        availability: >
          {{ states('sensor.mirai_status_word_raw') not in ['unknown','unavailable','none','None',''] }}
        state: >
          {% set v = states('sensor.mirai_status_word_raw') | int(0) %}
          {{ (v | bitwise_and(2**2)) != 0 }}
      - name: "MIRAI status word bit 03"
        unique_id: mirai_status_word_bit_03
        availability: >
          {{ states('sensor.mirai_status_word_raw') not in ['unknown','unavailable','none','None',''] }}
        state: >
          {% set v = states('sensor.mirai_status_word_raw') | int(0) %}
          {{ (v | bitwise_and(2**3)) != 0 }}
      - name: "MIRAI status word bit 04"
        unique_id: mirai_status_word_bit_04
        availability: >
          {{ states('sensor.mirai_status_word_raw') not in ['unknown','unavailable','none','None',''] }}
        state: >
          {% set v = states('sensor.mirai_status_word_raw') | int(0) %}
          {{ (v | bitwise_and(2**4)) != 0 }}
      - name: "MIRAI status word bit 05"
        unique_id: mirai_status_word_bit_05
        availability: >
          {{ states('sensor.mirai_status_word_raw') not in ['unknown','unavailable','none','None',''] }}
        state: >
          {% set v = states('sensor.mirai_status_word_raw') | int(0) %}
          {{ (v | bitwise_and(2**5)) != 0 }}
      - name: "MIRAI status word bit 06"
        unique_id: mirai_status_word_bit_06
        availability: >
          {{ states('sensor.mirai_status_word_raw') not in ['unknown','unavailable','none','None',''] }}
        state: >
          {% set v = states('sensor.mirai_status_word_raw') | int(0) %}
          {{ (v | bitwise_and(2**6)) != 0 }}
      - name: "MIRAI status word bit 07"
        unique_id: mirai_status_word_bit_07
        availability: >
          {{ states('sensor.mirai_status_word_raw') not in ['unknown','unavailable','none','None',''] }}
        state: >
          {% set v = states('sensor.mirai_status_word_raw') | int(0) %}
          {{ (v | bitwise_and(2**7)) != 0 }}
      - name: "MIRAI status word bit 08"
        unique_id: mirai_status_word_bit_08
        availability: >
          {{ states('sensor.mirai_status_word_raw') not in ['unknown','unavailable','none','None',''] }}
        state: >
          {% set v = states('sensor.mirai_status_word_raw') | int(0) %}
          {{ (v | bitwise_and(2**8)) != 0 }}
      - name: "MIRAI status word bit 09"
        unique_id: mirai_status_word_bit_09
        availability: >
          {{ states('sensor.mirai_status_word_raw') not in ['unknown','unavailable','none','None',''] }}
        state: >
          {% set v = states('sensor.mirai_status_word_raw') | int(0) %}
          {{ (v | bitwise_and(2**9)) != 0 }}
      - name: "MIRAI status word bit 10"
        unique_id: mirai_status_word_bit_10
        availability: >
          {{ states('sensor.mirai_status_word_raw') not in ['unknown','unavailable','none','None',''] }}
        state: >
          {% set v = states('sensor.mirai_status_word_raw') | int(0) %}
          {{ (v | bitwise_and(2**10)) != 0 }}
      - name: "MIRAI status word bit 11"
        unique_id: mirai_status_word_bit_11
        availability: >
          {{ states('sensor.mirai_status_word_raw') not in ['unknown','unavailable','none','None',''] }}
        state: >
          {% set v = states('sensor.mirai_status_word_raw') | int(0) %}
          {{ (v | bitwise_and(2**11)) != 0 }}
      - name: "MIRAI status word bit 12"
        unique_id: mirai_status_word_bit_12
        availability: >
          {{ states('sensor.mirai_status_word_raw') not in ['unknown','unavailable','none','None',''] }}
        state: >
          {% set v = states('sensor.mirai_status_word_raw') | int(0) %}
          {{ (v | bitwise_and(2**12)) != 0 }}
      - name: "MIRAI status word bit 13"
        unique_id: mirai_status_word_bit_13
        availability: >
          {{ states('sensor.mirai_status_word_raw') not in ['unknown','unavailable','none','None',''] }}
        state: >
          {% set v = states('sensor.mirai_status_word_raw') | int(0) %}
          {{ (v | bitwise_and(2**13)) != 0 }}
      - name: "MIRAI status word bit 14"
        unique_id: mirai_status_word_bit_14
        availability: >
          {{ states('sensor.mirai_status_word_raw') not in ['unknown','unavailable','none','None',''] }}
        state: >
          {% set v = states('sensor.mirai_status_word_raw') | int(0) %}
          {{ (v | bitwise_and(2**14)) != 0 }}
      - name: "MIRAI status word bit 15"
        unique_id: mirai_status_word_bit_15
        availability: >
          {{ states('sensor.mirai_status_word_raw') not in ['unknown','unavailable','none','None',''] }}
        state: >
          {% set v = states('sensor.mirai_status_word_raw') | int(0) %}
          {{ (v | bitwise_and(2**15)) != 0 }}

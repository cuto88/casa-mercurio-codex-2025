modbus:
  - name: ehw_modbus
    type: tcp
    host: !secret ehw_modbus_host
    port: !secret ehw_modbus_port
    delay: 1
    timeout: 3
    retries: 1
    message_wait_milliseconds: 30

    sensors:
      - name: "EHW reg56 status"
        unique_id: ehw_reg56_status
        address: 56
        input_type: holding
        data_type: uint16
        scan_interval: 15
        slave: !secret ehw_modbus_slave

      - name: "EHW reg57 runtime"
        unique_id: ehw_reg57_runtime
        address: 57
        input_type: holding
        data_type: uint16
        scan_interval: 30
        slave: !secret ehw_modbus_slave

      - name: "EHW reg60 value"
        unique_id: ehw_reg60_value
        address: 60
        input_type: holding
        data_type: uint16
        scan_interval: 30
        slave: !secret ehw_modbus_slave

      # T01..T06 RAW (A = doc_reg - 1, B = doc_reg)
      - name: "EHW T01 raw A"
        unique_id: ehw_t01_raw_a
        address: 2018
        input_type: holding
        data_type: uint16
        unit_of_measurement: "raw"
        scan_interval: 60
        slave: !secret ehw_modbus_slave

      - name: "EHW T01 raw B"
        unique_id: ehw_t01_raw_b
        address: 2019
        input_type: holding
        data_type: uint16
        unit_of_measurement: "raw"
        scan_interval: 60
        slave: !secret ehw_modbus_slave

      - name: "EHW T02 raw A"
        unique_id: ehw_t02_raw_a
        address: 2019
        input_type: holding
        data_type: uint16
        unit_of_measurement: "raw"
        scan_interval: 60
        slave: !secret ehw_modbus_slave

      - name: "EHW T02 raw B"
        unique_id: ehw_t02_raw_b
        address: 2020
        input_type: holding
        data_type: uint16
        unit_of_measurement: "raw"
        scan_interval: 60
        slave: !secret ehw_modbus_slave

      - name: "EHW T03 raw A"
        unique_id: ehw_t03_raw_a
        address: 2020
        input_type: holding
        data_type: uint16
        unit_of_measurement: "raw"
        scan_interval: 60
        slave: !secret ehw_modbus_slave

      - name: "EHW T03 raw B"
        unique_id: ehw_t03_raw_b
        address: 2021
        input_type: holding
        data_type: uint16
        unit_of_measurement: "raw"
        scan_interval: 60
        slave: !secret ehw_modbus_slave

      - name: "EHW T04 raw A"
        unique_id: ehw_t04_raw_a
        address: 2021
        input_type: holding
        data_type: uint16
        unit_of_measurement: "raw"
        scan_interval: 60
        slave: !secret ehw_modbus_slave

      - name: "EHW T04 raw B"
        unique_id: ehw_t04_raw_b
        address: 2022
        input_type: holding
        data_type: uint16
        unit_of_measurement: "raw"
        scan_interval: 60
        slave: !secret ehw_modbus_slave

      - name: "EHW T05 raw A"
        unique_id: ehw_t05_raw_a
        address: 2022
        input_type: holding
        data_type: uint16
        unit_of_measurement: "raw"
        scan_interval: 60
        slave: !secret ehw_modbus_slave

      - name: "EHW T05 raw B"
        unique_id: ehw_t05_raw_b
        address: 2023
        input_type: holding
        data_type: uint16
        unit_of_measurement: "raw"
        scan_interval: 60
        slave: !secret ehw_modbus_slave

      - name: "EHW T06 raw A"
        unique_id: ehw_t06_raw_a
        address: 2023
        input_type: holding
        data_type: uint16
        unit_of_measurement: "raw"
        scan_interval: 60
        slave: !secret ehw_modbus_slave

      - name: "EHW T06 raw B"
        unique_id: ehw_t06_raw_b
        address: 2024
        input_type: holding
        data_type: uint16
        unit_of_measurement: "raw"
        scan_interval: 60
        slave: !secret ehw_modbus_slave

      # Setpoint RAW (1104/1105, A = doc_reg - 1, B = doc_reg)
      - name: "EHW setpoint 1104 raw A"
        unique_id: ehw_setpoint_1104_raw_a
        address: 1103
        input_type: holding
        data_type: uint16
        unit_of_measurement: "raw"
        scan_interval: 60
        slave: !secret ehw_modbus_slave

      - name: "EHW setpoint 1104 raw B"
        unique_id: ehw_setpoint_1104_raw_b
        address: 1104
        input_type: holding
        data_type: uint16
        unit_of_measurement: "raw"
        scan_interval: 60
        slave: !secret ehw_modbus_slave

      - name: "EHW setpoint 1105 raw A"
        unique_id: ehw_setpoint_1105_raw_a
        address: 1104
        input_type: holding
        data_type: uint16
        unit_of_measurement: "raw"
        scan_interval: 60
        slave: !secret ehw_modbus_slave

      - name: "EHW setpoint 1105 raw B"
        unique_id: ehw_setpoint_1105_raw_b
        address: 1105
        input_type: holding
        data_type: uint16
        unit_of_measurement: "raw"
        scan_interval: 60
        slave: !secret ehw_modbus_slave

input_select:
  "ehw_address_mode":
    name: EHW address mode
    options:
      - doc_1_based
      - doc_0_based
    initial: doc_1_based

input_boolean:
  "ehw_swap_top_bottom":
    name: EHW swap top/bottom
    icon: mdi:swap-vertical
    initial: false

input_number:
  "ehw_temp_scale":
    name: EHW temp scale
    min: 0.01
    max: 5
    step: 0.01
    mode: slider
    initial: 0.3
  "ehw_temp_offset":
    name: EHW temp offset
    min: -20
    max: 20
    step: 0.1
    mode: slider
    initial: 0.0
  "ehw_setpoint_scale":
    name: EHW setpoint scale
    min: 0.01
    max: 5
    step: 0.01
    mode: slider
    initial: 0.3
  "ehw_setpoint_offset":
    name: EHW setpoint offset
    min: -20
    max: 20
    step: 0.1
    mode: slider
    initial: 0.0

template:
  - sensor:
      - name: "EHW status word hex"
        unique_id: ehw_status_word_hex
        state: >-
          {{ '0x%04X' | format(states('sensor.ehw_reg56_status') | int(0)) }}
        availability: >-
          {{ states('sensor.ehw_reg56_status') not in ['unknown', 'unavailable', 'none'] }}

      - name: "EHW runtime word hex"
        unique_id: ehw_runtime_word_hex
        state: >-
          {{ '0x%04X' | format(states('sensor.ehw_reg57_runtime') | int(0)) }}
        availability: >-
          {{ states('sensor.ehw_reg57_runtime') not in ['unknown', 'unavailable', 'none'] }}

  - binary_sensor:
      - name: "CM Modbus ready"
        unique_id: cm_modbus_ready
        icon: mdi:check-network
        state: >-
          {{ is_number(states('sensor.ehw_reg56_status')) }}

      - name: "EHW status bit 0x0100"
        unique_id: ehw_status_bit_0100
        state: >-
          {{ (states('sensor.ehw_reg56_status') | int(0)) | bitwise_and(256) > 0 }}
        availability: >-
          {{ states('sensor.ehw_reg56_status') not in ['unknown', 'unavailable', 'none'] }}

      - name: "EHW status bit 0x0200"
        unique_id: ehw_status_bit_0200
        state: >-
          {{ (states('sensor.ehw_reg56_status') | int(0)) | bitwise_and(512) > 0 }}
        availability: >-
          {{ states('sensor.ehw_reg56_status') not in ['unknown', 'unavailable', 'none'] }}

  - sensor:
      - name: "EHW T01 raw"
        unique_id: ehw_t01_raw
        availability: >-
          {{ is_state('binary_sensor.cm_modbus_ready', 'on') }}
        unit_of_measurement: "raw"
        state: >-
          {% if is_state('input_select.ehw_address_mode', 'doc_1_based') %}
            {{ states('sensor.ehw_t01_raw_a') }}
          {% else %}
            {{ states('sensor.ehw_t01_raw_b') }}
          {% endif %}
      - name: "EHW T02 raw"
        unique_id: ehw_t02_raw
        availability: >-
          {{ is_state('binary_sensor.cm_modbus_ready', 'on') }}
        unit_of_measurement: "raw"
        state: >-
          {% if is_state('input_select.ehw_address_mode', 'doc_1_based') %}
            {{ states('sensor.ehw_t02_raw_a') }}
          {% else %}
            {{ states('sensor.ehw_t02_raw_b') }}
          {% endif %}
      - name: "EHW T03 raw"
        unique_id: ehw_t03_raw
        availability: >-
          {{ is_state('binary_sensor.cm_modbus_ready', 'on') }}
        unit_of_measurement: "raw"
        state: >-
          {% if is_state('input_select.ehw_address_mode', 'doc_1_based') %}
            {{ states('sensor.ehw_t03_raw_a') }}
          {% else %}
            {{ states('sensor.ehw_t03_raw_b') }}
          {% endif %}
      - name: "EHW T04 raw"
        unique_id: ehw_t04_raw
        availability: >-
          {{ is_state('binary_sensor.cm_modbus_ready', 'on') }}
        unit_of_measurement: "raw"
        state: >-
          {% if is_state('input_select.ehw_address_mode', 'doc_1_based') %}
            {{ states('sensor.ehw_t04_raw_a') }}
          {% else %}
            {{ states('sensor.ehw_t04_raw_b') }}
          {% endif %}
      - name: "EHW T05 raw"
        unique_id: ehw_t05_raw
        availability: >-
          {{ is_state('binary_sensor.cm_modbus_ready', 'on') }}
        unit_of_measurement: "raw"
        state: >-
          {% if is_state('input_select.ehw_address_mode', 'doc_1_based') %}
            {{ states('sensor.ehw_t05_raw_a') }}
          {% else %}
            {{ states('sensor.ehw_t05_raw_b') }}
          {% endif %}
      - name: "EHW T06 raw"
        unique_id: ehw_t06_raw
        availability: >-
          {{ is_state('binary_sensor.cm_modbus_ready', 'on') }}
        unit_of_measurement: "raw"
        state: >-
          {% if is_state('input_select.ehw_address_mode', 'doc_1_based') %}
            {{ states('sensor.ehw_t06_raw_a') }}
          {% else %}
            {{ states('sensor.ehw_t06_raw_b') }}
          {% endif %}
      - name: "EHW setpoint raw A"
        unique_id: ehw_setpoint_raw_a
        availability: >-
          {{ is_state('binary_sensor.cm_modbus_ready', 'on') }}
        unit_of_measurement: "raw"
        state: >-
          {% if is_state('input_select.ehw_address_mode', 'doc_1_based') %}
            {{ states('sensor.ehw_setpoint_1104_raw_a') }}
          {% else %}
            {{ states('sensor.ehw_setpoint_1104_raw_b') }}
          {% endif %}
      - name: "EHW setpoint raw B"
        unique_id: ehw_setpoint_raw_b
        availability: >-
          {{ is_state('binary_sensor.cm_modbus_ready', 'on') }}
        unit_of_measurement: "raw"
        state: >-
          {% if is_state('input_select.ehw_address_mode', 'doc_1_based') %}
            {{ states('sensor.ehw_setpoint_1105_raw_a') }}
          {% else %}
            {{ states('sensor.ehw_setpoint_1105_raw_b') }}
          {% endif %}
      - name: "EHW tank top raw"
        unique_id: ehw_tank_top_raw
        availability: >-
          {{ is_state('binary_sensor.cm_modbus_ready', 'on') }}
        unit_of_measurement: "raw"
        state: >-
          {% if is_state('input_boolean.ehw_swap_top_bottom', 'on') %}
            {{ states('sensor.ehw_t03_raw') }}
          {% else %}
            {{ states('sensor.ehw_t02_raw') }}
          {% endif %}
      - name: "EHW tank bottom raw"
        unique_id: ehw_tank_bottom_raw
        availability: >-
          {{ is_state('binary_sensor.cm_modbus_ready', 'on') }}
        unit_of_measurement: "raw"
        state: >-
          {% if is_state('input_boolean.ehw_swap_top_bottom', 'on') %}
            {{ states('sensor.ehw_t02_raw') }}
          {% else %}
            {{ states('sensor.ehw_t03_raw') }}
          {% endif %}
      - name: "EHW setpoint raw"
        unique_id: ehw_setpoint_raw
        availability: >-
          {{ is_state('binary_sensor.cm_modbus_ready', 'on') }}
        unit_of_measurement: "raw"
        state: >-
          {% if is_state('input_select.ehw_address_mode', 'doc_1_based') %}
            {{ states('sensor.ehw_setpoint_raw_a') }}
          {% else %}
            {{ states('sensor.ehw_setpoint_raw_b') }}
          {% endif %}
      - name: "EHW tank top"
        unique_id: ehw_tank_top
        availability: >-
          {{ is_state('binary_sensor.cm_modbus_ready', 'on') }}
        device_class: temperature
        unit_of_measurement: "째C"
        state_class: measurement
        state: >-
          {% set raw = states('sensor.ehw_tank_top_raw') | float(none) %}
          {% set scale = states('input_number.ehw_temp_scale') | float(0) %}
          {% if scale == 0 or scale is none %}
            {% set scale = 0.3 %}
          {% endif %}
          {% set offset = states('input_number.ehw_temp_offset') | float(0) %}
          {% if raw is none %}
            unknown
          {% else %}
            {% set val = raw * scale + offset %}
            {% if val < 0 or val > 90 %}
              unknown
            {% else %}
              {{ val | round(1) }}
            {% endif %}
          {% endif %}
      - name: "EHW tank bottom"
        unique_id: ehw_tank_bottom
        availability: >-
          {{ is_state('binary_sensor.cm_modbus_ready', 'on') }}
        device_class: temperature
        unit_of_measurement: "째C"
        state_class: measurement
        state: >-
          {% set raw = states('sensor.ehw_tank_bottom_raw') | float(none) %}
          {% set scale = states('input_number.ehw_temp_scale') | float(0) %}
          {% if scale == 0 or scale is none %}
            {% set scale = 0.3 %}
          {% endif %}
          {% set offset = states('input_number.ehw_temp_offset') | float(0) %}
          {% if raw is none %}
            unknown
          {% else %}
            {% set val = raw * scale + offset %}
            {% if val < 0 or val > 90 %}
              unknown
            {% else %}
              {{ val | round(1) }}
            {% endif %}
          {% endif %}
      - name: "EHW setpoint"
        unique_id: ehw_setpoint
        availability: >-
          {{ is_state('binary_sensor.cm_modbus_ready', 'on') }}
        device_class: temperature
        unit_of_measurement: "째C"
        state_class: measurement
        state: >-
          {% set raw = states('sensor.ehw_setpoint_raw') | float(none) %}
          {% set scale = states('input_number.ehw_setpoint_scale') | float(0) %}
          {% if scale == 0 or scale is none %}
            {% set scale = 0.3 %}
          {% endif %}
          {% set offset = states('input_number.ehw_setpoint_offset') | float(0) %}
          {% if raw is none %}
            unknown
          {% else %}
            {% set val = raw * scale + offset %}
            {% if val < 0 or val > 90 %}
              unknown
            {% else %}
              {{ val | round(1) }}
            {% endif %}
          {% endif %}
      - name: "EHW delta stratificazione"
        unique_id: ehw_delta_stratificazione
        availability: >-
          {{ is_state('binary_sensor.cm_modbus_ready', 'on') }}
        unit_of_measurement: "째C"
        state_class: measurement
        state: >-
          {% if is_number(states('sensor.ehw_tank_top')) and is_number(states('sensor.ehw_tank_bottom')) %}
            {{
              (
                (states('sensor.ehw_tank_top') | float(0))
                - (states('sensor.ehw_tank_bottom') | float(0))
              ) | round(1)
            }}
          {% else %}
            unknown
          {% endif %}
      - name: "EHW status"
        unique_id: ehw_status
        availability: >-
          {{ is_state('binary_sensor.cm_modbus_ready', 'on') }}
        state: >-
          {% if is_state('binary_sensor.ehw_running', 'on') %}
            In funzione
          {% else %}
            Spento
          {% endif %}
  - binary_sensor:
      - name: "EHW running"
        unique_id: ehw_running
        availability: >-
          {{ is_state('binary_sensor.cm_modbus_ready', 'on') }}
        state: >-
          {% set has_raw = is_number(states('sensor.ehw_setpoint_raw')) and is_number(states('sensor.ehw_tank_top_raw')) %}
          {% set has_scaled = is_number(states('sensor.ehw_setpoint')) and is_number(states('sensor.ehw_tank_top')) %}
          {% if has_raw and has_scaled %}
            {{ (states('sensor.ehw_setpoint') | float(0)) - (states('sensor.ehw_tank_top') | float(0)) >= 1.0 }}
          {% else %}
            false
          {% endif %}

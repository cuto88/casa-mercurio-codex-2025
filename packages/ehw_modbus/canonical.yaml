template:
  - sensor:
      - name: "EHW status word hex"
        unique_id: ehw_status_word_hex
        state: >-
          {{ '0x%04X' | format(states('sensor.ehw_reg56_status') | int(0)) }}
        availability: >-
          {{ states('sensor.ehw_reg56_status') not in ['unknown', 'unavailable', 'none'] }}
  
      - name: "EHW runtime word hex"
        unique_id: ehw_runtime_word_hex
        state: >-
          {{ '0x%04X' | format(states('sensor.ehw_reg57_runtime') | int(0)) }}
        availability: >-
          {{ states('sensor.ehw_reg57_runtime') not in ['unknown', 'unavailable', 'none'] }}
  
    binary_sensor:
      - name: "EHW status bit 0x0100"
        unique_id: ehw_status_bit_0100
        state: >-
          {{ (states('sensor.ehw_reg56_status') | int(0)) | bitwise_and(256) > 0 }}
        availability: >-
          {{ states('sensor.ehw_reg56_status') not in ['unknown', 'unavailable', 'none'] }}
  
      - name: "EHW status bit 0x0200"
        unique_id: ehw_status_bit_0200
        state: >-
          {{ (states('sensor.ehw_reg56_status') | int(0)) | bitwise_and(512) > 0 }}
        availability: >-
          {{ states('sensor.ehw_reg56_status') not in ['unknown', 'unavailable', 'none'] }}
  
  - sensor:
      - name: "EHW T01 raw"
        unique_id: ehw_t01_raw
        unit_of_measurement: "raw"
        state: >-
          {% if is_state('input_select.ehw_address_mode', 'doc_1_based') %}
            {{ states('sensor.ehw_t01_raw_a') }}
          {% else %}
            {{ states('sensor.ehw_t01_raw_b') }}
          {% endif %}
      - name: "EHW T02 raw"
        unique_id: ehw_t02_raw
        unit_of_measurement: "raw"
        state: >-
          {% if is_state('input_select.ehw_address_mode', 'doc_1_based') %}
            {{ states('sensor.ehw_t02_raw_a') }}
          {% else %}
            {{ states('sensor.ehw_t02_raw_b') }}
          {% endif %}
      - name: "EHW T03 raw"
        unique_id: ehw_t03_raw
        unit_of_measurement: "raw"
        state: >-
          {% if is_state('input_select.ehw_address_mode', 'doc_1_based') %}
            {{ states('sensor.ehw_t03_raw_a') }}
          {% else %}
            {{ states('sensor.ehw_t03_raw_b') }}
          {% endif %}
      - name: "EHW T04 raw"
        unique_id: ehw_t04_raw
        unit_of_measurement: "raw"
        state: >-
          {% if is_state('input_select.ehw_address_mode', 'doc_1_based') %}
            {{ states('sensor.ehw_t04_raw_a') }}
          {% else %}
            {{ states('sensor.ehw_t04_raw_b') }}
          {% endif %}
      - name: "EHW T05 raw"
        unique_id: ehw_t05_raw
        unit_of_measurement: "raw"
        state: >-
          {% if is_state('input_select.ehw_address_mode', 'doc_1_based') %}
            {{ states('sensor.ehw_t05_raw_a') }}
          {% else %}
            {{ states('sensor.ehw_t05_raw_b') }}
          {% endif %}
      - name: "EHW T06 raw"
        unique_id: ehw_t06_raw
        unit_of_measurement: "raw"
        state: >-
          {% if is_state('input_select.ehw_address_mode', 'doc_1_based') %}
            {{ states('sensor.ehw_t06_raw_a') }}
          {% else %}
            {{ states('sensor.ehw_t06_raw_b') }}
          {% endif %}
      - name: "EHW setpoint raw A"
        unique_id: ehw_setpoint_raw_a
        unit_of_measurement: "raw"
        state: >-
          {% if is_state('input_select.ehw_address_mode', 'doc_1_based') %}
            {{ states('sensor.ehw_setpoint_1104_raw_a') }}
          {% else %}
            {{ states('sensor.ehw_setpoint_1104_raw_b') }}
          {% endif %}
      - name: "EHW setpoint raw B"
        unique_id: ehw_setpoint_raw_b
        unit_of_measurement: "raw"
        state: >-
          {% if is_state('input_select.ehw_address_mode', 'doc_1_based') %}
            {{ states('sensor.ehw_setpoint_1105_raw_a') }}
          {% else %}
            {{ states('sensor.ehw_setpoint_1105_raw_b') }}
          {% endif %}
      - name: "EHW tank top raw"
        unique_id: ehw_tank_top_raw
        unit_of_measurement: "raw"
        state: >-
          {% if is_state('input_boolean.ehw_swap_top_bottom', 'on') %}
            {{ states('sensor.ehw_t03_raw') }}
          {% else %}
            {{ states('sensor.ehw_t02_raw') }}
          {% endif %}
      - name: "EHW tank bottom raw"
        unique_id: ehw_tank_bottom_raw
        unit_of_measurement: "raw"
        state: >-
          {% if is_state('input_boolean.ehw_swap_top_bottom', 'on') %}
            {{ states('sensor.ehw_t02_raw') }}
          {% else %}
            {{ states('sensor.ehw_t03_raw') }}
          {% endif %}
      - name: "EHW setpoint raw"
        unique_id: ehw_setpoint_raw
        unit_of_measurement: "raw"
        state: >-
          {% if is_state('input_select.ehw_address_mode', 'doc_1_based') %}
            {{ states('sensor.ehw_setpoint_raw_a') }}
          {% else %}
            {{ states('sensor.ehw_setpoint_raw_b') }}
          {% endif %}
      - name: "EHW tank top"
        unique_id: ehw_tank_top
        device_class: temperature
        unit_of_measurement: "째C"
        state_class: measurement
        state: >-
          {% set raw = states('sensor.ehw_tank_top_raw') | float(none) %}
          {% set scale = states('input_number.ehw_temp_scale') | float(0) %}
          {% if scale == 0 or scale is none %}
            {% set scale = 0.3 %}
          {% endif %}
          {% set offset = states('input_number.ehw_temp_offset') | float(0) %}
          {% if raw is none %}
            unknown
          {% else %}
            {% set val = raw * scale + offset %}
            {% if val < 0 or val > 90 %}
              unknown
            {% else %}
              {{ val | round(1) }}
            {% endif %}
          {% endif %}
      - name: "EHW tank bottom"
        unique_id: ehw_tank_bottom
        device_class: temperature
        unit_of_measurement: "째C"
        state_class: measurement
        state: >-
          {% set raw = states('sensor.ehw_tank_bottom_raw') | float(none) %}
          {% set scale = states('input_number.ehw_temp_scale') | float(0) %}
          {% if scale == 0 or scale is none %}
            {% set scale = 0.3 %}
          {% endif %}
          {% set offset = states('input_number.ehw_temp_offset') | float(0) %}
          {% if raw is none %}
            unknown
          {% else %}
            {% set val = raw * scale + offset %}
            {% if val < 0 or val > 90 %}
              unknown
            {% else %}
              {{ val | round(1) }}
            {% endif %}
          {% endif %}
      - name: "EHW setpoint"
        unique_id: ehw_setpoint
        device_class: temperature
        unit_of_measurement: "째C"
        state_class: measurement
        state: >-
          {% set raw = states('sensor.ehw_setpoint_raw') | float(none) %}
          {% set scale = states('input_number.ehw_setpoint_scale') | float(0) %}
          {% if scale == 0 or scale is none %}
            {% set scale = 0.3 %}
          {% endif %}
          {% set offset = states('input_number.ehw_setpoint_offset') | float(0) %}
          {% if raw is none %}
            unknown
          {% else %}
            {% set val = raw * scale + offset %}
            {% if val < 0 or val > 90 %}
              unknown
            {% else %}
              {{ val | round(1) }}
            {% endif %}
          {% endif %}
      - name: "EHW delta stratificazione"
        unique_id: ehw_delta_stratificazione
        unit_of_measurement: "째C"
        state_class: measurement
        state: >-
          {% if is_number(states('sensor.ehw_tank_top')) and is_number(states('sensor.ehw_tank_bottom')) %}
            {{
              (
                (states('sensor.ehw_tank_top') | float(0))
                - (states('sensor.ehw_tank_bottom') | float(0))
              ) | round(1)
            }}
          {% else %}
            unknown
          {% endif %}
      - name: "EHW status"
        unique_id: ehw_status
        state: >-
          {% if is_state('binary_sensor.ehw_running', 'on') %}
            In funzione
          {% else %}
            Spento
          {% endif %}
    binary_sensor:
      - name: "EHW running"
        unique_id: ehw_running
        state: >-
          {% set has_raw = is_number(states('sensor.ehw_setpoint_raw')) and is_number(states('sensor.ehw_tank_top_raw')) %}
          {% set has_scaled = is_number(states('sensor.ehw_setpoint')) and is_number(states('sensor.ehw_tank_top')) %}
          {% if has_raw and has_scaled %}
            {{ (states('sensor.ehw_setpoint') | float(0)) - (states('sensor.ehw_tank_top') | float(0)) >= 1.0 }}
          {% else %}
            false
          {% endif %}

###############################################################################
# 9_global_energy.yaml — Global Energy (senza helper) 
#
# SCOPO
#   KPI e bilanci giornalieri con supporto **pinze** e **SolarEdge**.
#   Questo file NON dichiara helper: usa quelli definiti in 0_helpers_energy.yaml
#   (vedi blocco da incollare più sotto in chat).
#
# Dipendenze attese dai tuoi pacchetti esistenti:
#   - Import rete (oggi): sensor.a_prelevata_kwh_norm
#   - Export rete (oggi): sensor.a_immessa_kwh_norm
#   - FV (oggi, pinza B): sensor.b_produzione_kwh_norm (opzionale, come fallback)
#   - SolarEdge: sensor.solaredge_energy_today (Wh), sensor.solaredge_lifetime_energy (Wh)
###############################################################################

# -----------------------------------------------------------------------------
# 1) SOLAREDGE — normalizzazioni utili
# -----------------------------------------------------------------------------
# A) energy_today (Wh) → kWh
# B) lifetime (Wh cumulativi) → kWh + utility_meter giornaliero
# Entrambe disponibili come possibili sorgenti FV.
# -----------------------------------------------------------------------------

template:
  - sensor:
      - name: "GE — PV kWh oggi (SolarEdge — energy_today norm)"
        unique_id: ge_pv_today_solaredge_norm
        unit_of_measurement: "kWh"
        device_class: energy
        state_class: measurement
        icon: mdi:solar-power
        state: >-
          {% set s = states('sensor.solaredge_energy_today') %}
          {% if s not in ['unknown','unavailable','none',''] %}
            {{ (s|float(0) / 1000) | round(3) }}
          {% else %}
            unknown
          {% endif %}

      - name: "PV — SolarEdge lifetime kWh (norm)"
        unique_id: pv_solaredge_lifetime_kwh_norm
        unit_of_measurement: "kWh"
        device_class: energy
        state_class: total_increasing
        icon: mdi:counter
        state: >-
          {% set s = states('sensor.solaredge_lifetime_energy') %}
          {% if s not in ['unknown','unavailable','none',''] %}
            {{ (s|float(0) / 1000) | round(3) }}
          {% else %}
            unknown
          {% endif %}

utility_meter:
  ge_pv_solaredge_today:
    source: sensor.pv_solaredge_lifetime_kwh_norm
    name: "GE — PV kWh oggi (SolarEdge)"
    cycle: daily
    net_consumption: false

# -----------------------------------------------------------------------------
# 2) SORGENTI AUTO/SCELTA — Import/Export/PV
# -----------------------------------------------------------------------------
# Import/Export: mappate via input_text.* (vedi helpers). Se vuoti → fallback.
# PV: selezione tramite input_select.ge_pv_source_preference (auto/pinza/solaredge)
#     con cascata di fallback robusta.
# -----------------------------------------------------------------------------

template:
  - sensor:
      # -------------------- Import / Export (kWh oggi) -----------------------
      - name: "GE — Import kWh (auto)"
        unique_id: ge_import_kwh_auto
        unit_of_measurement: "kWh"
        device_class: energy
        state_class: measurement
        state: >-
          {% set cfg = states('input_text.ge_grid_import_kwh_entity') %}
          {% set cands = [cfg|lower,
                          'sensor.a_prelevata_kwh_norm',
                          'sensor.grid_import_today',
                          'sensor.energy_imported_today',
                          'sensor.grid_import_kwh']
                        | select('string') | list %}
          {% set v = namespace(val='unknown') %}
          {% for e in cands if e %}
            {% set s = states(e) %}
            {% if s not in ['unknown','unavailable','none',''] %}
              {% set v.val = s %}
              {% break %}
            {% endif %}
          {% endfor %}
          {{ v.val }}

      - name: "GE — Export kWh (auto)"
        unique_id: ge_export_kwh_auto
        unit_of_measurement: "kWh"
        device_class: energy
        state_class: measurement
        state: >-
          {% set cfg = states('input_text.ge_grid_export_kwh_entity') %}
          {% set cands = [cfg|lower,
                          'sensor.a_immessa_kwh_norm',
                          'sensor.grid_export_today',
                          'sensor.energy_exported_today',
                          'sensor.grid_export_kwh']
                        | select('string') | list %}
          {% set v = namespace(val='unknown') %}
          {% for e in cands if e %}
            {% set s = states(e) %}
            {% if s not in ['unknown','unavailable','none',''] %}
              {% set v.val = s %}
              {% break %}
            {% endif %}
          {% endfor %}
          {{ v.val }}

      # -------------------- FV (kWh oggi) con preferenza ---------------------
      - name: "GE — FV kWh (scelto)"
        unique_id: ge_pv_kwh_chosen
        unit_of_measurement: "kWh"
        device_class: energy
        state_class: measurement
        icon: mdi:solar-power
        state: >-
          {% set pref = states('input_select.ge_pv_source_preference') %}
          {% set helper = states('input_text.ge_pv_production_kwh_entity') %}
          {% set sol_um = 'sensor.ge_pv_kwh_oggi_solaredge' %}
          {% set sol_et = 'sensor.ge_pv_today_solaredge_norm' %}
          {% set pinza  = 'sensor.b_produzione_kwh_norm' %}

          {% macro good(e) -%}
            {{ (states(e) not in ['unknown','unavailable','none','']) and (states(e)|float(0) >= 0) }}
          {%- endmacro %}

          {# 1) Se helper specificato e valido → usa quello #}
          {% if helper|length > 0 and (states(helper) not in ['unknown','unavailable','none','']) %}
            {{ states(helper) }}
          {% else %}
            {# 2) Altrimenti usa la preferenza #}
            {% if pref == 'SolarEdge' and (good(sol_um) or good(sol_et)) %}
              {{ (states(sol_um) if good(sol_um) else states(sol_et)) }}
            {% elif pref == 'Pinza' and good(pinza) %}
              {{ states(pinza) }}
            {% else %}
              {# 3) AUTO fallback: SolarEdge UM → energy_today → pinza #}
              {% if good(sol_um) %}
                {{ states(sol_um) }}
              {% elif good(sol_et) %}
                {{ states(sol_et) }}
              {% elif good(pinza) %}
                {{ states(pinza) }}
              {% else %}
                unknown
              {% endif %}
            {% endif %}
          {% endif %}

      # ------------------------- KPI derivati -------------------------------
      - name: "GE — Casa kWh (auto/calc)"
        unique_id: ge_home_kwh_calc
        unit_of_measurement: "kWh"
        device_class: energy
        state_class: measurement
        icon: mdi:home-lightning-bolt
        state: >-
          {% set cfg = states('input_text.ge_home_kwh_entity') %}
          {% if cfg|length > 0 and states(cfg) not in ['unknown','unavailable',''] %}
            {{ states(cfg) }}
          {% else %}
            {% set imp = states('sensor.ge_import_kwh_auto')|float(0) %}
            {% set exp = states('sensor.ge_export_kwh_auto')|float(0) %}
            {% set pv  = states('sensor.ge_pv_kwh_chosen')|float(0) %}
            {{ (pv - exp + imp) | round(3) }}
          {% endif %}

      - name: "GE — Autoconsumo kWh"
        unique_id: ge_selfcons_kwh
        unit_of_measurement: "kWh"
        device_class: energy
        state_class: measurement
        icon: mdi:transmission-tower-export
        state: >-
          {% set pv = states('sensor.ge_pv_kwh_chosen')|float(0) %}
          {% set exp = states('sensor.ge_export_kwh_auto')|float(0) %}
          {{ [pv - exp, 0]|max | round(3) }}

      - name: "GE — Autoconsumo %"
        unique_id: ge_selfcons_pct
        unit_of_measurement: "%"
        state_class: measurement
        icon: mdi:percent
        state: >-
          {% set pv = states('sensor.ge_pv_kwh_chosen')|float(0) %}
          {% set self = states('sensor.ge_autoconsumo_kwh')|float(0) %}
          {% if pv > 0 %}{{ (100*self/pv)|round(1) }}{% else %}0{% endif %}

      - name: "GE — Indipendenza (Autarky) %"
        unique_id: ge_autarky_pct
        unit_of_measurement: "%"
        state_class: measurement
        icon: mdi:shield-home
        state: >-
          {% set home = states('sensor.ge_casa_kwh_auto_calc')|float(0) %}
          {% set self = states('sensor.ge_autoconsumo_kwh')|float(0) %}
          {% if home > 0 %}{{ (100*self/home)|round(1) }}{% else %}0{% endif %}

      - name: "GE — Bilancio rete kWh (import−export)"
        unique_id: ge_grid_balance_kwh
        unit_of_measurement: "kWh"
        device_class: energy
        state_class: measurement
        icon: mdi:scale-balance
        state: >-
          {% set imp = states('sensor.ge_import_kwh_auto')|float(0) %}
          {% set exp = states('sensor.ge_export_kwh_auto')|float(0) %}
          {{ (imp - exp) | round(3) }}

      - name: "GE — CO2 evitata (kg)"
        unique_id: ge_co2_avoided_kg
        unit_of_measurement: "kg"
        state_class: measurement
        icon: mdi:molecule-co2
        state: >-
          {% set self = states('sensor.ge_autoconsumo_kwh')|float(0) %}
          {% set f = states('input_number.ge_co2_factor_kg_per_kwh')|float(0.4) %}
          {{ (self * f) | round(2) }}

  - binary_sensor:
      - name: "GE — Net exporter oggi"
        unique_id: ge_is_net_exporter_today
        device_class: power
        state: >-
          {% set imp = states('sensor.ge_import_kwh_auto')|float(0) %}
          {% set exp = states('sensor.ge_export_kwh_auto')|float(0) %}
          {{ exp > imp }}
        icon: >-
          {% if is_state('binary_sensor.ge_is_net_exporter_today','on') %}
            mdi:transmission-tower-export
          {% else %}
            mdi:transmission-tower-import
          {% endif %}

# -----------------------------------------------------------------------------
# 3) DIAGNOSTICA — quali sorgenti sono state usate
# -----------------------------------------------------------------------------

template:
  - sensor:
      - name: "GE — Sorgente Import (entity)"
        unique_id: ge_src_import_entity
        state: >-
          {% set cfg = states('input_text.ge_grid_import_kwh_entity') %}
          {% set cands = [cfg|lower,
                          'sensor.a_prelevata_kwh_norm',
                          'sensor.grid_import_today',
                          'sensor.energy_imported_today',
                          'sensor.grid_import_kwh']
                        | select('string') | list %}
          {% set v = namespace(ent='unknown') %}
          {% for e in cands if e %}
            {% if states(e) not in ['unknown','unavailable','none',''] %}
              {% set v.ent = e %}
              {% break %}
            {% endif %}
          {% endfor %}
          {{ v.ent }}

      - name: "GE — Sorgente Export (entity)"
        unique_id: ge_src_export_entity
        state: >-
          {% set cfg = states('input_text.ge_grid_export_kwh_entity') %}
          {% set cands = [cfg|lower,
                          'sensor.a_immessa_kwh_norm',
                          'sensor.grid_export_today',
                          'sensor.energy_exported_today',
                          'sensor.grid_export_kwh']
                        | select('string') | list %}
          {% set v = namespace(ent='unknown') %}
          {% for e in cands if e %}
            {% if states(e) not in ['unknown','unavailable','none',''] %}
              {% set v.ent = e %}
              {% break %}
            {% endif %}
          {% endfor %}
          {{ v.ent }}

      - name: "GE — Sorgente FV (entity effettiva)"
        unique_id: ge_src_pv_entity
        state: >-
          {% set pref = states('input_select.ge_pv_source_preference') %}
          {% set helper = states('input_text.ge_pv_production_kwh_entity') %}
          {% set sol_um = 'sensor.ge_pv_kwh_oggi_solaredge' %}
          {% set sol_et = 'sensor.ge_pv_today_solaredge_norm' %}
          {% set pinza  = 'sensor.b_produzione_kwh_norm' %}
          {% macro good(e) -%}
            {{ (states(e) not in ['unknown','unavailable','none','']) and (states(e)|float(0) >= 0) }}
          {%- endmacro %}
          {% if helper|length > 0 and (states(helper) not in ['unknown','unavailable','none','']) %}
            {{ helper|lower }}
          {% else %}
            {% if pref == 'SolarEdge' and (good(sol_um) or good(sol_et)) %}
              {{ (sol_um if good(sol_um) else sol_et) }}
            {% elif pref == 'Pinza' and good(pinza) %}
              {{ pinza }}
            {% else %}
              {% if good(sol_um) %}
                {{ sol_um }}
              {% elif good(sol_et) %}
                {{ sol_et }}
              {% elif good(pinza) %}
                {{ pinza }}
              {% else %}
                unknown
              {% endif %}
            {% endif %}
          {% endif %}

      - name: "GE — Sorgente Casa (entity)"
        unique_id: ge_src_home_entity
        state: >-
          {% set cfg = states('input_text.ge_home_kwh_entity') %}
          {% if cfg|length > 0 %}
            {{ cfg|lower }}
          {% else %}
            "calcolato: pv - export + import"
          {% endif %}

# FINE FILE
###############################################################################

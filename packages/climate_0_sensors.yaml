# FILE: packages/0_sensors.yaml
---
###############################################################################
# 0_sensors.yaml — Sensori climatici canonici e KPI base (ΔT / ΔAH)
# - sensori media interna T/UR
# - AH interna / esterna
# - ΔT in-out
# - ΔAH in-out
###############################################################################

template:
  - sensor:
      # -----------------------------------------------------------------------
      # SENSORI AMBIENTALI CANONICI (alias ai sensori fisici reali)
      # TODO: sostituire gli ID *_hw con i sensori fisici effettivi
      # -----------------------------------------------------------------------
      - name: "T interna — Zona giorno"
        unique_id: t_in_giorno
        object_id: t_in_giorno
        unit_of_measurement: "°C"
        device_class: temperature
        state_class: measurement
        icon: mdi:thermometer
        availability: >-
          {{ states('sensor.t_in_giorno_hw') not in ['unknown','unavailable',''] }}
        state: >-
          {% set raw = states('sensor.t_in_giorno_hw') %}
          {% if raw not in ['unknown','unavailable',''] %}
            {{ raw|float }}
          {% else %}
            unknown
          {% endif %}

      - name: "T interna — Zona notte 1"
        unique_id: t_in_notte1
        object_id: t_in_notte1
        unit_of_measurement: "°C"
        device_class: temperature
        state_class: measurement
        icon: mdi:thermometer
        availability: >-
          {{ states('sensor.t_in_notte1_hw') not in ['unknown','unavailable',''] }}
        state: >-
          {% set raw = states('sensor.t_in_notte1_hw') %}
          {% if raw not in ['unknown','unavailable',''] %}
            {{ raw|float }}
          {% else %}
            unknown
          {% endif %}

      - name: "T interna — Zona notte 2"
        unique_id: t_in_notte2
        object_id: t_in_notte2
        unit_of_measurement: "°C"
        device_class: temperature
        state_class: measurement
        icon: mdi:thermometer
        availability: >-
          {{ states('sensor.t_in_notte2_hw') not in ['unknown','unavailable',''] }}
        state: >-
          {% set raw = states('sensor.t_in_notte2_hw') %}
          {% if raw not in ['unknown','unavailable',''] %}
            {{ raw|float }}
          {% else %}
            unknown
          {% endif %}

      - name: "T interna — Bagno"
        unique_id: t_in_bagno
        object_id: t_in_bagno
        unit_of_measurement: "°C"
        device_class: temperature
        state_class: measurement
        icon: mdi:thermometer
        availability: >-
          {{ states('sensor.t_in_bagno_hw') not in ['unknown','unavailable',''] }}
        state: >-
          {% set raw = states('sensor.t_in_bagno_hw') %}
          {% if raw not in ['unknown','unavailable',''] %}
            {{ raw|float }}
          {% else %}
            unknown
          {% endif %}

      - name: "Temperatura esterna"
        unique_id: t_out
        object_id: t_out
        unit_of_measurement: "°C"
        device_class: temperature
        state_class: measurement
        icon: mdi:thermometer
        availability: >-
          {{ states('sensor.t_out_hw') not in ['unknown','unavailable',''] }}
        state: >-
          {% set raw = states('sensor.t_out_hw') %}
          {% if raw not in ['unknown','unavailable',''] %}
            {{ raw|float }}
          {% else %}
            unknown
          {% endif %}

      - name: "UR interna — Zona giorno"
        unique_id: ur_in_giorno
        object_id: ur_in_giorno
        unit_of_measurement: "%"
        device_class: humidity
        state_class: measurement
        icon: mdi:water-percent
        availability: >-
          {{ states('sensor.ur_in_giorno_hw') not in ['unknown','unavailable',''] }}
        state: >-
          {% set raw = states('sensor.ur_in_giorno_hw') %}
          {% if raw not in ['unknown','unavailable',''] %}
            {{ raw|float }}
          {% else %}
            unknown
          {% endif %}

      - name: "UR interna — Zona notte 1"
        unique_id: ur_in_notte1
        object_id: ur_in_notte1
        unit_of_measurement: "%"
        device_class: humidity
        state_class: measurement
        icon: mdi:water-percent
        availability: >-
          {{ states('sensor.ur_in_notte1_hw') not in ['unknown','unavailable',''] }}
        state: >-
          {% set raw = states('sensor.ur_in_notte1_hw') %}
          {% if raw not in ['unknown','unavailable',''] %}
            {{ raw|float }}
          {% else %}
            unknown
          {% endif %}

      - name: "UR interna — Zona notte 2"
        unique_id: ur_in_notte2
        object_id: ur_in_notte2
        unit_of_measurement: "%"
        device_class: humidity
        state_class: measurement
        icon: mdi:water-percent
        availability: >-
          {{ states('sensor.ur_in_notte2_hw') not in ['unknown','unavailable',''] }}
        state: >-
          {% set raw = states('sensor.ur_in_notte2_hw') %}
          {% if raw not in ['unknown','unavailable',''] %}
            {{ raw|float }}
          {% else %}
            unknown
          {% endif %}

      - name: "UR interna — Bagno"
        unique_id: ur_in_bagno
        object_id: ur_in_bagno
        unit_of_measurement: "%"
        device_class: humidity
        state_class: measurement
        icon: mdi:water-percent
        availability: >-
          {{ states('sensor.ur_in_bagno_hw') not in ['unknown','unavailable',''] }}
        state: >-
          {% set raw = states('sensor.ur_in_bagno_hw') %}
          {% if raw not in ['unknown','unavailable',''] %}
            {{ raw|float }}
          {% else %}
            unknown
          {% endif %}

      - name: "UR esterna"
        unique_id: ur_out
        object_id: ur_out
        unit_of_measurement: "%"
        device_class: humidity
        state_class: measurement
        icon: mdi:water-percent
        availability: >-
          {{ states('sensor.ur_out_hw') not in ['unknown','unavailable',''] }}
        state: >-
          {% set raw = states('sensor.ur_out_hw') %}
          {% if raw not in ['unknown','unavailable',''] %}
            {{ raw|float }}
          {% else %}
            unknown
          {% endif %}

      # -----------------------------------------------------------------------
      # TEMPERATURE / UMIDITÀ ESTERNE CANONICHE
      # -----------------------------------------------------------------------
      - name: "Temperatura esterna (canonico)"
        unique_id: t_out_canonico
        unit_of_measurement: "°C"
        device_class: temperature
        state_class: measurement
        icon: mdi:thermometer
        state: >-
          {% set t_real = states('sensor.t_out') %}
          {% if t_real not in ['unknown','unavailable',''] %}
            {{ t_real|float }}
          {% else %}
            unknown
          {% endif %}

      - name: "UR esterna (canonico)"
        unique_id: ur_out_canonico
        unit_of_measurement: "%"
        device_class: humidity
        state_class: measurement
        icon: mdi:water-percent
        state: >-
          {% set rh_real = states('sensor.ur_out') %}
          {% if rh_real not in ['unknown','unavailable',''] %}
            {{ rh_real|float }}
          {% else %}
            unknown
          {% endif %}

      # -----------------------------------------------------------------------
      # MEDIE INTERNE (T / UR)
      # -----------------------------------------------------------------------
      - name: "T interna media"
        unique_id: t_in_media
        unit_of_measurement: "°C"
        device_class: temperature
        state_class: measurement
        icon: mdi:thermometer
        state: >-
          {% set vals = [
            states('sensor.t_in_giorno'),
            states('sensor.t_in_notte1'),
            states('sensor.t_in_notte2'),
            states('sensor.t_in_bagno')
          ] %}
          {% set valid = vals
             | reject('in', ['unknown','unavailable',''])
             | map('float') | list %}
          {% if valid | length > 0 %}
            {{ (valid | sum / (valid | length)) | round(2) }}
          {% else %}
            {{ states('input_number.vent_backup_t_in') }}
          {% endif %}

      - name: "UR interna media"
        unique_id: ur_in_media
        unit_of_measurement: "%"
        device_class: humidity
        state_class: measurement
        icon: mdi:water-percent
        state: >-
          {% set vals = [
            states('sensor.ur_in_giorno'),
            states('sensor.ur_in_notte1'),
            states('sensor.ur_in_notte2'),
            states('sensor.ur_in_bagno')
          ] %}
          {% set valid = vals
             | reject('in', ['unknown','unavailable',''])
             | map('float') | list %}
          {% if valid | length > 0 %}
            {{ (valid | sum / (valid | length)) | round(1) }}
          {% else %}
            {{ states('input_number.vent_backup_ur_in') }}
          {% endif %}

      - name: "UR interna minima"
        unique_id: ur_in_min
        unit_of_measurement: "%"
        device_class: humidity
        state_class: measurement
        icon: mdi:water-percent-alert
        availability: >-
          {% set vals = [
            states('sensor.ur_in_giorno'),
            states('sensor.ur_in_notte1'),
            states('sensor.ur_in_notte2'),
            states('sensor.ur_in_bagno')
          ] %}
          {{ vals | reject('in', ['unknown','unavailable','']) | list | count > 0 }}
        state: >-
          {% set vals = [
            states('sensor.ur_in_giorno'),
            states('sensor.ur_in_notte1'),
            states('sensor.ur_in_notte2'),
            states('sensor.ur_in_bagno')
          ] %}
          {% set valid = vals
             | reject('in', ['unknown','unavailable',''])
             | map('float') | list %}
          {% if valid | length > 0 %}
            {{ (valid | min) | round(1) }}
          {% else %}
            unknown
          {% endif %}

      # -----------------------------------------------------------------------
      # AH INTERNA / ESTERNA (canoniche)
      # -----------------------------------------------------------------------
      - name: "AH interna"
        unique_id: ah_in
        unit_of_measurement: "g/m³"
        state_class: measurement
        icon: mdi:water
        state: >-
          {% set T = states('sensor.t_in_media')|float(default=none) %}
          {% set RH = states('sensor.ur_in_media')|float(default=none) %}
          {% if T is number and RH is number %}
            {% set RHc = [ [RH, 100]|min, 1]|max %}
            {% set es = 6.112 * (2.718281828 ** ((17.67*T)/(T+243.5))) %}
            {% set pv = (RHc/100) * es %}
            {{ (216.7 * pv / (T + 273.15)) | round(2) }}
          {% else %}
            unknown
          {% endif %}

      - name: "AH esterna"
        unique_id: ah_out
        unit_of_measurement: "g/m³"
        state_class: measurement
        icon: mdi:water-outline
        state: >-
          {% set T = states('sensor.t_out')|float(default=none) %}
          {% set RH = states('sensor.ur_out')|float(default=none) %}
          {% if T is number and RH is number %}
            {% set RHc = [ [RH, 100]|min, 1]|max %}
            {% set exponent = (17.67*T)/(T+243.5) %}
            {% set es = 6.112 * (2.718281828 ** exponent) %}
            {% set pv = RHc/100 * es %}
            {{ (216.7 * pv / (T + 273.15)) | round(2) }}
          {% else %}
            unknown
          {% endif %}
        availability: >-
          {{ states('sensor.t_out') not in ['unknown','unavailable',''] and
             states('sensor.ur_out') not in ['unknown','unavailable',''] }}

      # -----------------------------------------------------------------------
      # KPI ΔT / ΔAH
      # -----------------------------------------------------------------------
      - name: "Delta T in-out"
        unique_id: delta_t_in_out
        unit_of_measurement: "°C"
        device_class: temperature
        state_class: measurement
        icon: mdi:thermometer-chevron-up
        state: >-
          {% set tin = states('sensor.t_in_media')|float(default=none) %}
          {% set tout = states('sensor.t_out')|float(default=none) %}
          {% if tin is number and tout is number %}
            {{ (tin - tout) | round(2) }}
          {% else %}
            unknown
          {% endif %}

      - name: "Delta AH in-out"
        unique_id: delta_ah_in_out
        unit_of_measurement: "g/m³"
        state_class: measurement
        icon: mdi:water-percent
        state: >-
          {% set ah_i = states('sensor.ah_in')|float(default=none) %}
          {% set ah_o = states('sensor.ah_out')|float(default=none) %}
          {% if ah_i is number and ah_o is number %}
            {{ (ah_i - ah_o) | round(2) }}
          {% else %}
            unknown
          {% endif %}

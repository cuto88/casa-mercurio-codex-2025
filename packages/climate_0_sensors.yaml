template:
  - sensor:
      - name: "T interna media"
        unique_id: t_in_media
        unit_of_measurement: "°C"
        device_class: temperature
        state_class: measurement
        icon: mdi:thermometer
        state: >-
          {% set vals = [
            states('sensor.t_in_giorno'),
            states('sensor.t_in_notte1'),
            states('sensor.t_in_notte2'),
            states('sensor.t_in_bagno')
          ] %}
          {% set valid = vals | reject('in', ['unknown','unavailable','']) | map('float') | list %}
          {% if valid | length > 0 %}
            {{ (valid | sum / (valid | length)) | round(2) }}
          {% else %}
            {{ states('input_number.vent_backup_t_in') }}
          {% endif %}

      - name: "UR interna media"
        unique_id: ur_in_media
        unit_of_measurement: "%"
        device_class: humidity
        state_class: measurement
        state: >-
          {% set vals = [
            states('sensor.ur_in_giorno'),
            states('sensor.ur_in_notte1'),
            states('sensor.ur_in_notte2'),
            states('sensor.ur_in_bagno')
          ] %}
          {% set valid = vals | reject('in', ['unknown','unavailable','']) | map('float') | list %}
          {% if valid | length > 0 %}
            {{ (valid | sum / (valid | length)) | round(1) }}
          {% else %}
            {{ states('input_number.vent_backup_ur_in') }}
          {% endif %}

      - name: "UR interna minima"
        unique_id: ur_in_min
        unit_of_measurement: "%"
        device_class: humidity
        state_class: measurement
        state: >-
          {% set values = [
            states('sensor.ur_in_giorno')|float(default=none),
            states('sensor.ur_in_notte1')|float(default=none),
            states('sensor.ur_in_notte2')|float(default=none),
            states('sensor.ur_in_bagno')|float(default=none)
          ] | select('ne', none) | list %}
          {% if values %}
            {{ (values | min) | round(1) }}
          {% else %}
            unknown
          {% endif %}

      - name: "AH interna"
        unique_id: ah_in
        unit_of_measurement: "g/m³"
        state_class: measurement
        state: >-
          {% set T = states('sensor.t_in_media')|float(default=none) %}
          {% set RH = states('sensor.ur_in_media')|float(default=none) %}
          {% if T is number and RH is number %}
            {% set RHc = [[RH, 100]|min, 1]|max %}
            {% set es = 6.112 * (2.718281828 ** ((17.67*T)/(T+243.5))) %}
            {% set pv = (RHc/100) * es %}
            {{ (216.7 * pv / (T + 273.15)) | round(2) }}
          {% else %}
            unknown
          {% endif %}

      - name: "AH esterna"
        unique_id: ah_out
        unit_of_measurement: "g/m³"
        state_class: measurement
        state: >-
          {% set T = states('sensor.t_out')|float(default=none) %}
          {% set RH = states('sensor.ur_out')|float(default=none) %}
          {% if T is number and RH is number %}
            {% set RHc = [[RH, 100]|min, 1]|max %}
            {% set es = 6.112 * (2.718281828 ** ((17.67*T)/(T+243.5))) %}
            {% set pv = (RHc/100) * es %}
            {{ (216.7 * pv / (T + 273.15)) | round(2) }}
          {% else %}
            unknown
          {% endif %}

      - name: "Delta T in-out"
        unique_id: delta_t_in_out
        unit_of_measurement: "°C"
        device_class: temperature
        state_class: measurement
        state: >-
          {% set tin = states('sensor.t_in_media')|float(default=none) %}
          {% set tout = states('sensor.t_out')|float(default=none) %}
          {% if tin is number and tout is number %}
            {{ (tin - tout) | round(2) }}
          {% else %}
            unknown
          {% endif %}

      - name: "Delta AH in-out"
        unique_id: delta_ah_in_out
        unit_of_measurement: "g/m³"
        state_class: measurement
        state: >-
          {% set ah_i = states('sensor.ah_in')|float(default=none) %}
          {% set ah_o = states('sensor.ah_out')|float(default=none) %}
          {% if ah_i is number and ah_o is number %}
            {{ (ah_i - ah_o) | round(2) }}
          {% else %}
            unknown
          {% endif %}

###############################################################################
# 1_ventilation_core.yaml — LOGICA CLIMA PASSIVHAUS (VMC + KPI)
# - Priorità e reason globali (clima)
# - Failsafe sensori
# - KPI per free-cooling e ventilazione naturale
# - Hook/eventi per Heating/AC/Windows
###############################################################################

timer:
  vmc_anti_secco_lock:
    name: "VMC lock anti-secco"
    duration: "00:15:00"

  vmc_boost_lock:
    name: "VMC lock bagno boost"
    duration: "00:12:00"

  vmc_freecooling_max_run:
    name: "VMC max-run free-cooling"
    duration: "02:00:00"

  vmc_freecooling_cooldown:
    name: "VMC cooldown free-cooling"
    duration: "00:20:00"

# Helper locali (soglie)
input_number:
  vmc_bagno_on:
    name: "Bagno — UR ON"
    min: 40
    max: 90
    step: 1
    unit_of_measurement: "%"
    mode: slider
    icon: mdi:water-percent
    initial: 75

  vmc_bagno_off:
    name: "Bagno — UR OFF"
    min: 40
    max: 90
    step: 1
    unit_of_measurement: "%"
    mode: slider
    icon: mdi:water-percent
    initial: 65

  vmc_fc_ph_tin_on:
    name: "FC (PH) — T_in ON"
    min: 18
    max: 28
    step: 0.5
    unit_of_measurement: "°C"
    mode: slider
    icon: mdi:thermometer
    initial: 24

  vmc_fc_macchina_tout_min:
    name: "FC (Macchina) — T_out min"
    min: 5
    max: 25
    step: 0.5
    unit_of_measurement: "°C"
    mode: slider
    icon: mdi:thermometer-low
    initial: 20

  vmc_freecooling_delta:
    name: "FC — ΔT minimo"
    min: 0.5
    max: 5
    step: 0.1
    unit_of_measurement: "°C"
    mode: slider
    icon: mdi:thermometer-chevron-down
    initial: 2

  vmc_freecooling_delta_ah:
    name: "FC — ΔAH minimo"
    min: 0.1
    max: 5
    step: 0.1
    unit_of_measurement: "g/m³"
    mode: slider
    icon: mdi:water-percent
    initial: 2

  vmc_anti_secco_ur_min:
    name: "Anti-secco — UR_min"
    min: 20
    max: 60
    step: 1
    unit_of_measurement: "%"
    mode: slider
    icon: mdi:water-percent-alert
    initial: 40

input_text:
  vmc_last_event:
    name: "VMC — Last Event"
    max: 120
    mode: text

template:
  - binary_sensor:
      - name: "VMC failsafe — sensori non ok"
        unique_id: vmc_failsafe_sensors_bad
        icon: mdi:alert-circle
        state: >
          {% set specs = {
            'sensor.t_in_media': [-20, 50],
            'sensor.t_out': [-20, 50],
            'sensor.ur_in_media': [0, 100],
            'sensor.ur_out': [0, 100],
            'sensor.ah_in': [0, none],
            'sensor.ah_out': [0, none],
            'sensor.ur_in_bagno': [0, 100]
          } %}
          {% set bad = namespace(items=[]) %}
          {% for key, limits in specs.items() %}
            {% set raw = states(key) %}
            {% set val = raw|float(default=none) if raw not in ['unknown','unavailable','', none] else none %}
            {% if val is none %}
              {% set bad.items = bad.items + [key] %}
            {% else %}
              {% if (limits[0] is not none and val < limits[0]) or (limits[1] is not none and val > limits[1]) %}
                {% set bad.items = bad.items + [key] %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {{ bad.items | count > 0 }}
        attributes:
          problematic_sensors: >
            {% set specs = {
              'sensor.t_in_media': [-20, 50],
              'sensor.t_out': [-20, 50],
              'sensor.ur_in_media': [0, 100],
              'sensor.ur_out': [0, 100],
              'sensor.ah_in': [0, none],
              'sensor.ah_out': [0, none],
              'sensor.ur_in_bagno': [0, 100]
            } %}
            {% set bad = [] %}
            {% for key, limits in specs.items() %}
              {% set raw = states(key) %}
              {% set val = raw|float(default=none) if raw not in ['unknown','unavailable','', none] else none %}
              {% if val is none %}
                {% set bad = bad + [key] %}
              {% else %}
                {% if (limits[0] is not none and val < limits[0]) or (limits[1] is not none and val > limits[1]) %}
                  {% set bad = bad + [key] %}
                {% endif %}
              {% endif %}
            {% endfor %}
            {{ bad }}

      - name: "VMC Override AC notte = DRY"
        unique_id: vmc_override_ac_dry
        icon: mdi:shield-refresh
        state: >
          {{ is_state('switch.ac_notte','on') and is_state('switch.vmc_vel_0','on') }}

      - name: "VMC Bagno Boost attivo"
        unique_id: vmc_bagno_boost
        icon: mdi:fan-speed-3
        state: >
          {% set ur_b_raw = states('sensor.ur_in_bagno') %}
          {% set ur_b = ur_b_raw|float(default=none) if ur_b_raw not in ['unknown','unavailable','', none] else none %}
          {% set ur_o_raw = states('sensor.ur_out') %}
          {% set ur_o = ur_o_raw|float(default=none) if ur_o_raw not in ['unknown','unavailable','', none] else none %}
          {% set ur_m_raw = states('sensor.ur_in_media') %}
          {% set ur_m = ur_m_raw|float(default=none) if ur_m_raw not in ['unknown','unavailable','', none] else none %}
          {% set soglia_raw = states('input_number.vmc_bagno_on') %}
          {% set soglia = soglia_raw|float(75) if soglia_raw not in ['unknown','unavailable','', none] else 75 %}
          {% set delta = (ur_b - ur_o) if (ur_b is not none and ur_o is not none) else none %}
          {% set main_boost = (ur_b is not none and ur_b >= soglia) or (delta is not none and delta >= 10) %}
          {% set lite = ur_m is not none and ur_o is not none and ur_m > 50 and (ur_m - ur_o) >= 10 %}
          {% set soft = is_state('switch.vmc_vel_2','on') and main_boost and lite and (ur_b is none or ur_o < ur_b) %}
          {{ is_state('switch.vmc_vel_3','on') or soft }}

      - name: "VMC Free-cooling PH attivo"
        unique_id: vmc_free_cooling_ph
        icon: mdi:snowflake-thermometer
        state: >
          {% set Tin_raw  = states('sensor.t_in_media') %}
          {% set Tin = Tin_raw|float(default=none) if Tin_raw not in ['unknown','unavailable','', none] else none %}
          {% set Tout_raw = states('sensor.t_out') %}
          {% set Tout = Tout_raw|float(default=none) if Tout_raw not in ['unknown','unavailable','', none] else none %}
          {% set AHin_raw  = states('sensor.ah_in') %}
          {% set AHin = AHin_raw|float(default=none) if AHin_raw not in ['unknown','unavailable','', none] else none %}
          {% set AHout_raw = states('sensor.ah_out') %}
          {% set AHout = AHout_raw|float(default=none) if AHout_raw not in ['unknown','unavailable','', none] else none %}
          {% set T_on_raw = states('input_number.vmc_fc_ph_tin_on') %}
          {% set T_on = T_on_raw|float(24) if T_on_raw not in ['unknown','unavailable','', none] else 24 %}
          {{ Tin is not none and Tout is not none and AHin is not none and AHout is not none and
             Tin > T_on and Tout < Tin and AHout < AHin and
             is_state('switch.vmc_vel_3','off') and is_state('switch.ac_notte','off') and is_state('switch.ac_giorno','off') and
             is_state('switch.vmc_vel_2','on') }}

      - name: "VMC Free-cooling Macchina attivo"
        unique_id: vmc_free_cooling_machine
        icon: mdi:home-thermometer-outline
        state: >
          {% set Tin_raw  = states('sensor.t_in_media') %}
          {% set Tin = Tin_raw|float(default=none) if Tin_raw not in ['unknown','unavailable','', none] else none %}
          {% set Tout_raw = states('sensor.t_out') %}
          {% set Tout = Tout_raw|float(default=none) if Tout_raw not in ['unknown','unavailable','', none] else none %}
          {% set T_on_raw = states('input_number.vmc_fc_ph_tin_on') %}
          {% set T_on = T_on_raw|float(24) if T_on_raw not in ['unknown','unavailable','', none] else 24 %}
          {% set T_min_raw = states('input_number.vmc_fc_macchina_tout_min') %}
          {% set T_min = T_min_raw|float(20) if T_min_raw not in ['unknown','unavailable','', none] else 20 %}
          {% set AHin_raw  = states('sensor.ah_in') %}
          {% set AHin = AHin_raw|float(default=none) if AHin_raw not in ['unknown','unavailable','', none] else none %}
          {% set AHout_raw = states('sensor.ah_out') %}
          {% set AHout = AHout_raw|float(default=none) if AHout_raw not in ['unknown','unavailable','', none] else none %}
          {% set ph = Tin is not none and Tout is not none and AHin is not none and AHout is not none and
                     Tin > T_on and Tout < Tin and AHout < AHin %}
          {% set macchina = Tin is not none and Tout is not none and Tin > T_on and Tout < Tin and Tout > T_min %}
          {{ macchina and not ph and is_state('switch.vmc_vel_3','off') and
             is_state('switch.ac_notte','off') and is_state('switch.ac_giorno','off') and is_state('switch.vmc_vel_2','on') }}

      - name: "VMC Anti-secco attivo"
        unique_id: vmc_anti_secco
        icon: mdi:water-percent-alert
        state: >
          {% set m = now().month %}
          {% set notte = now().hour >= 23 or now().hour < 7 %}
          {% set ur_min_raw = states('sensor.ur_in_min') %}
          {% set ur_min = ur_min_raw|float(default=none) if ur_min_raw not in ['unknown','unavailable','', none] else none %}
          {% set soglia_raw = states('input_number.vmc_anti_secco_ur_min') %}
          {% set soglia = soglia_raw|float(40) if soglia_raw not in ['unknown','unavailable','', none] else 40 %}
          {{ (m in [11,12,1,2,3]) and notte and ur_min is not none and (ur_min <= soglia) and is_state('switch.vmc_vel_0','on') }}

      - name: "VMC DRY attivo (P1B)"
        unique_id: vmc_dry_active
        icon: mdi:water-remove
        state: >
          {{ is_state('switch.ac_notte','on') or is_state('switch.ac_giorno','on') }}
        attributes:
          started_minutes_ago: >
            {% set ns = namespace(times=[]) %}
            {% set ent_n = states.get('switch.ac_notte') %}
            {% set ent_g = states.get('switch.ac_giorno') %}
            {% for obj in [ent_n, ent_g] %}
              {% if obj is not none and obj.last_changed is defined %}
                {% set ns.times = ns.times + [obj.last_changed] %}
              {% endif %}
            {% endfor %}
            {% if ns.times %}
              {{ ((now() - (ns.times | max)).total_seconds() / 60) | round(0) }}
            {% else %}
              0
            {% endif %}

      - name: "Stagione calda"
        unique_id: stagione_calda
        state: >
          {{ now().month in [5,6,7,8,9] }}

      - name: "Stagione fredda"
        unique_id: stagione_fredda
        state: >
          {{ now().month in [11,12,1,2,3] }}

  - sensor:
      - name: "UR interna minima"
        unique_id: ur_in_min
        unit_of_measurement: "%"
        icon: mdi:water-percent
        state_class: measurement
        state: >
          {% set sensors = [
            'sensor.ur_in_giorno',
            'sensor.ur_in_notte1',
            'sensor.ur_in_notte2',
            'sensor.ur_in_notte3',
            'sensor.ur_in_bagno',
            'sensor.ur_lavanderia'
          ] %}
          {% set values = [] %}
          {% for s in sensors %}
            {% set raw = states(s) %}
            {% if raw not in ['unknown','unavailable','', none] %}
              {% set values = values + [ raw | float ] %}
            {% endif %}
          {% endfor %}
          {{ (values | min | round(1)) if values | length > 0 else 'unknown' }}

      - name: "VMC Vel target"
        unique_id: vmc_vel_target
        icon: mdi:fan
        state: >
          {% if is_state('switch.vmc_vel_3','on') %}vel_3
          {% elif is_state('switch.vmc_vel_2','on') %}vel_2
          {% elif is_state('switch.vmc_vel_1','on') %}vel_1
          {% elif is_state('switch.vmc_vel_0','on') %}vel_0
          {% else %}off{% endif %}

      - name: "VMC velocità indice"
        unique_id: vmc_vel_index
        unit_of_measurement: "step"
        icon: mdi:fan-speed-1
        state_class: measurement
        state: >
          {% if is_state('switch.vmc_vel_3','on') %}3
          {% elif is_state('switch.vmc_vel_2','on') %}2
          {% elif is_state('switch.vmc_vel_1','on') %}1
          {% elif is_state('switch.vmc_vel_0','on') %}0
          {% else %}0{% endif %}

      - name: "VMC Freecooling Status"
        unique_id: vmc_freecooling_status
        icon: mdi:weather-night
        state: >
          {% set free = is_state('switch.vmc_vel_2','on') and state_attr('sensor.vmc_reason','reason') == 'P3_freecooling' %}
          {% set cooldown = is_state('timer.vmc_freecooling_cooldown','active') %}
          {% set maxrun_lock = (not is_state('timer.vmc_freecooling_max_run','active')) and (state_attr('sensor.vmc_reason','reason') == 'P3_freecooling') and (not cooldown) and (not free) %}
          {% if cooldown %}cooldown
          {% elif free %}active
          {% elif maxrun_lock %}maxrun_lock
          {% else %}off
          {% endif %}
        attributes:
          last_mode: "{{ state_attr('sensor.vmc_reason','reason') }}"
          cooldown_remaining: "{{ state_attr('timer.vmc_freecooling_cooldown','remaining') }}"

      - name: "VMC Reason"
        unique_id: vmc_reason
        icon: mdi:text
        state: >
          {% set attr_reason = state_attr('sensor.vmc_reason','reason') %}
          {% set failsafe = is_state('binary_sensor.vmc_failsafe_sensors_bad','on') %}
          {% set manual = is_state('input_boolean.vmc_manual','on') %}
          {% set boost = is_state('switch.vmc_vel_3','on') or is_state('timer.vmc_boost_lock','active') or attr_reason == 'P2_boost_bagno' %}
          {% set anti_secco = is_state('timer.vmc_anti_secco_lock','active') or attr_reason == 'P1_anti_secco' %}
          {% set freecooling_trigger = is_state('switch.vmc_vel_2','on') or is_state('timer.vmc_freecooling_max_run','active') or is_state('timer.vmc_freecooling_cooldown','active') %}
          {% set freecooling_attr = attr_reason == 'P3_freecooling' %}
          {% set freecooling = (freecooling_trigger and (attr_reason in ['P3_freecooling', none, 'idle'] or is_state('binary_sensor.stagione_calda','on'))) or freecooling_attr %}

          {% if failsafe %}
            P0_failsafe
          {% elif manual %}
            manual
          {% elif boost %}
            P2_boost_bagno
          {% elif anti_secco %}
            P1_anti_secco
          {% elif freecooling %}
            P3_freecooling
          {% else %}
            idle
          {% endif %}
        attributes:
          reason: "{{ state_attr('sensor.vmc_reason','reason') }}"

      - name: "VMC Last Event"
        unique_id: vmc_last_event
        icon: mdi:clock-outline
        state: "{{ states('input_text.vmc_last_event') if states('input_text.vmc_last_event') not in ['unknown','unavailable'] else '—' }}"

      - name: "VMC Priority"
        unique_id: vmc_priority
        icon: mdi:arrow-top-right-bold-outline
        state: >
          {% set URb_raw = states('sensor.ur_in_bagno') %}
          {% set URb = URb_raw|float(default=none) if URb_raw not in ['unknown','unavailable','', none] else none %}
          {% set URo_raw = states('sensor.ur_out') %}
          {% set URo = URo_raw|float(default=none) if URo_raw not in ['unknown','unavailable','', none] else none %}
          {% set URm_raw = states('sensor.ur_in_media') %}
          {% set URm = URm_raw|float(default=none) if URm_raw not in ['unknown','unavailable','', none] else none %}
          {% set soglia_raw = states('input_number.vmc_bagno_on') %}
          {% set soglia = soglia_raw|float(75) if soglia_raw not in ['unknown','unavailable','', none] else 75 %}
          {% set delta_ur = (URb - URo) if (URb is not none and URo is not none) else none %}
          {% set soft_boost = is_state('binary_sensor.vmc_bagno_boost','on') and is_state('switch.vmc_vel_2','on') %}
          {% set lite_ok = URm is not none and URo is not none and URm > 50 and (URm - URo) >= 10 %}
          {% set fc_ph = is_state('binary_sensor.vmc_free_cooling_ph','on') %}
          {% set fc_mac = is_state('binary_sensor.vmc_free_cooling_machine','on') %}
          {% set p1_lite = is_state('switch.vmc_vel_2','on') and not soft_boost and lite_ok and not fc_ph and not fc_mac %}
          {% if is_state('binary_sensor.vmc_bagno_boost','on') %}P1 — Bagno/BOOST
          {% elif p1_lite %}P1-Lite — ΔUR interno vs esterno
          {% elif is_state('switch.vmc_vel_2','on') %}P2 — Free-cooling
          {% elif is_state('binary_sensor.vmc_anti_secco','on') %}P3 — Anti-secco
          {% elif is_state('switch.ac_notte','on') and is_state('switch.vmc_vel_0','on') %}OV — AC notte = DRY
          {% elif is_state('switch.vmc_vel_1','on') %}P4 — Baseline
          {% elif is_state('switch.vmc_vel_0','on') %}P0 — Failsafe/Stop
          {% else %}—{% endif %}

      - name: "Clima Priority"
        unique_id: clima_priority
        icon: mdi:arrow-top-right-bold-outline
        state: >
          {% if is_state('binary_sensor.vmc_failsafe_sensors_bad','on') %}
            P0_failsafe
          {% elif is_state('binary_sensor.vmc_bagno_boost','on') or is_state('switch.vmc_vel_3','on') %}
            P1_boost_bagno
          {% elif is_state('sensor.vmc_freecooling_status','on') or is_state('sensor.vmc_freecooling_status','active') %}
            P2_freecooling
          {% elif is_state('binary_sensor.clima_open_windows_recommended','on') %}
            P3_vent_naturale
          {% else %}
            idle
          {% endif %}
        attributes:
          vmc_priority: "{{ states('sensor.vmc_priority') }}"
          vmc_reason: "{{ state_attr('sensor.vmc_reason','reason') }}"

      - name: "Clima Reason"
        unique_id: clima_reason
        icon: mdi:text
        state: "{{ states('sensor.clima_priority') }}"
        attributes:
          vmc_reason: "{{ state_attr('sensor.vmc_reason','reason') }}"
          freecooling_status: "{{ states('sensor.vmc_freecooling_status') }}"
          vent_window_open: "{{ is_state('binary_sensor.clima_open_windows_recommended','on') }}"

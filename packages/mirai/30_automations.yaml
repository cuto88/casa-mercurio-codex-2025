- alias: "MIRAI Modbus debug logger"
  id: mirai_modbus_debug_logger
  mode: queued
  max: 5
  trigger:
    - platform: state
      entity_id:
        - sensor.mirai_status_word_raw
        - sensor.mirai_status_code_raw
  condition:
    - condition: template
      value_template: "{{ trigger.to_state is not none and trigger.from_state is not none and trigger.to_state.state != trigger.from_state.state }}"
    - condition: template
      value_template: >-
        {% set last = state_attr('automation.mirai_modbus_debug_logger', 'last_triggered') %}
        {{ last is none or (as_timestamp(now()) - as_timestamp(last)) > 2 }}
  action:
    - service: shell_command.mirai_ensure_log_dir
    - service: notify.mirai_modbus_log
      data:
        message: >-
          {{ now().isoformat() }},{{ states('sensor.mirai_status_word_raw')|int(0) }},{{ states('sensor.mirai_status_word_hex') }},{{ states('sensor.mirai_status_word_bits_on') }},{{ states('sensor.mirai_status_word_bits_changed') }},{{ states('sensor.mirai_status_code_raw')|int(0) }},{{ states('sensor.mirai_status_code_hex') }},{{ states('sensor.mirai_status_code_bits_on') }},{{ states('sensor.mirai_status_code_bits_changed') }}
    - service: notify.telegram_davide
      data:
        message: >-
          MIRAI Modbus change | 4000={{ states('sensor.mirai_status_word_raw')|int(0) }}({{ states('sensor.mirai_status_word_hex') }}) bits_on=[{{ states('sensor.mirai_status_word_bits_on') }}] Δ=[{{ states('sensor.mirai_status_word_bits_changed') }}] | 4001={{ states('sensor.mirai_status_code_raw')|int(0) }}({{ states('sensor.mirai_status_code_hex') }}) bits_on=[{{ states('sensor.mirai_status_code_bits_on') }}] Δ=[{{ states('sensor.mirai_status_code_bits_changed') }}]
    # Replace notify.telegram_davide with the correct service if different in this installation.

---
###############################################################################
# 1_ventilation.yaml — Modulo VMC (auto/manual/off, boost bagno, freecooling,
# anti-secco) e suggerimenti ventilazione naturale.
# Riferimenti: README_ClimaSystem.md, logica/1_vent/1_vent.txt,
#              logica/1_vent/1_vent_plancia_regole.txt
###############################################################################

homeassistant:
  customize: {}

# ======================
# HELPERS — MODALITÀ E SOGLIE
# ======================
input_select:
  vmc_mode:
    name: "VMC — Modalità"
    options:
      - auto
      - manual
      - off
    icon: mdi:fan-auto
  vmc_manual_speed:
    name: "VMC — Velocità manuale"
    options:
      - off
      - vel_0
      - vel_1
      - vel_2
      - vel_3
    icon: mdi:fan

input_boolean:
  vmc_manual:
    name: "VMC — Abilita manuale"
    icon: mdi:hand
  vmc_boost_bagno:
    name: "VMC — Boost bagno"
    icon: mdi:fan-speed-3
  vent_override_estate:
    name: "Ventilazione — Forza stagione estiva"
    icon: mdi:weather-sunny
  vent_notifiche_attive:
    name: "Ventilazione — Notifiche abilitate"
    icon: mdi:bell-alert
    initial: true

input_number:
  vmc_bagno_on:
    name: "Bagno — UR ON"
    min: 40
    max: 90
    step: 1
    unit_of_measurement: "%"
    mode: slider
    icon: mdi:water-percent
    initial: 75
  vmc_bagno_off:
    name: "Bagno — UR OFF"
    min: 40
    max: 90
    step: 1
    unit_of_measurement: "%"
    mode: slider
    icon: mdi:water-percent
    initial: 65
  vmc_freecooling_delta:
    name: "FC — ΔT minimo"
    min: 0.5
    max: 5
    step: 0.1
    unit_of_measurement: "°C"
    mode: slider
    icon: mdi:thermometer-chevron-down
    initial: 2
  vmc_freecooling_delta_ah:
    name: "FC — ΔAH minimo"
    min: 0.1
    max: 5
    step: 0.1
    unit_of_measurement: "g/m³"
    mode: slider
    icon: mdi:water-percent
    initial: 2
  vmc_anti_secco_ur_min:
    name: "Anti-secco — UR_min"
    min: 20
    max: 60
    step: 1
    unit_of_measurement: "%"
    mode: slider
    icon: mdi:water-percent-alert
    initial: 40
  vent_deltat_min:
    name: "Ventilazione — ΔT minimo"
    min: 0.5
    max: 5
    step: 0.1
    unit_of_measurement: "°C"
    mode: slider
    icon: mdi:thermometer-chevron-down
    initial: 1.5
  vent_deltaah_min:
    name: "Ventilazione — ΔAH minimo"
    min: 0.1
    max: 5
    step: 0.1
    unit_of_measurement: "g/m³"
    mode: slider
    icon: mdi:water-percent
    initial: 1.0
  vent_vento_max:
    name: "Ventilazione — Vento massimo"
    min: 1
    max: 20
    step: 0.5
    unit_of_measurement: "m/s"
    mode: slider
    icon: mdi:weather-windy
    initial: 6.0
  vent_pm25_max:
    name: "Ventilazione — PM2.5 massimo"
    min: 5
    max: 100
    step: 1
    unit_of_measurement: "µg/m³"
    mode: slider
    icon: mdi:chemical-weapon
    initial: 25
  vent_backup_t_in:
    name: "Ventilazione — Backup T interna"
    min: 10
    max: 35
    step: 0.5
    unit_of_measurement: "°C"
    mode: slider
    icon: mdi:thermometer
    initial: 26
  vent_backup_ur_in:
    name: "Ventilazione — Backup UR interna"
    min: 20
    max: 90
    step: 1
    unit_of_measurement: "%"
    mode: slider
    icon: mdi:water-percent
    initial: 55

input_text:
  vmc_last_event:
    name: "VMC — Last Event"
    max: 120
    mode: text
  vent_messaggio_consiglio:
    name: "Ventilazione — Messaggio di consiglio"
    max: 255
    initial: "Sistema inizializzato: in attesa dati sensori."

input_datetime:
  vent_night_flush_start:
    name: "Ventilazione — Night flush start"
    has_date: false
    has_time: true
    icon: mdi:weather-night
    initial: "21:00"
  vent_night_flush_end:
    name: "Ventilazione — Night flush end"
    has_date: false
    has_time: true
    icon: mdi:weather-sunset-up
    initial: "08:00"

# Timers
timer:
  vmc_manual_timeout:
    name: Timeout modalità manuale
    duration: "01:00:00"
  vmc_anti_secco_lock:
    name: "VMC lock anti-secco"
    duration: "00:15:00"
  vmc_boost_lock:
    name: "VMC lock bagno boost"
    duration: "00:12:00"
  vmc_freecooling_max_run:
    name: "VMC max-run free-cooling"
    duration: "02:00:00"
  vmc_freecooling_cooldown:
    name: "VMC cooldown free-cooling"
    duration: "00:20:00"

# =============================
# METEO ESTERNO (Open-Meteo)
# =============================
rest:
  - resource: "https://api.open-meteo.com/v1/forecast?latitude=45.611133&longitude=12.356051&hourly=temperature_2m,relative_humidity_2m,precipitation,wind_speed_10m&forecast_days=1&windspeed_unit=ms&timezone=auto"
    scan_interval: 900
    timeout: 30
    sensor:
      - name: "Vent Meteo Temp"
        unique_id: vent_meteo_temp
        unit_of_measurement: "°C"
        device_class: temperature
        state_class: measurement
        icon: mdi:thermometer
        value_template: >-
          {% set root = value_json if value_json is defined else {} %}
          {% set arr = root.get('hourly', {}).get('temperature_2m', []) %}
          {% if arr | length > 0 %}
            {{ arr[0] }}
          {% else %}
            {{ states('sensor.vent_meteo_temp') }}
          {% endif %}
      - name: "Vent Meteo RH"
        unique_id: vent_meteo_rh
        unit_of_measurement: "%"
        device_class: humidity
        state_class: measurement
        icon: mdi:water-percent
        value_template: >-
          {% set root = value_json if value_json is defined else {} %}
          {% set arr = root.get('hourly', {}).get('relative_humidity_2m', []) %}
          {% if arr | length > 0 %}
            {{ arr[0] }}
          {% else %}
            {{ states('sensor.vent_meteo_rh') }}
          {% endif %}
      - name: "Vent Meteo Precip"
        unique_id: vent_meteo_precip
        unit_of_measurement: "mm"
        state_class: measurement
        icon: mdi:weather-rainy
        value_template: >-
          {% set root = value_json if value_json is defined else {} %}
          {% set arr = root.get('hourly', {}).get('precipitation', []) %}
          {% if arr | length > 0 %}
            {{ arr[0] }}
          {% else %}
            {{ states('sensor.vent_meteo_precip') }}
          {% endif %}
      - name: "Vent Meteo Vento"
        unique_id: vent_meteo_vento
        unit_of_measurement: "m/s"
        state_class: measurement
        icon: mdi:weather-windy
        value_template: >-
          {% set root = value_json if value_json is defined else {} %}
          {% set arr = root.get('hourly', {}).get('wind_speed_10m', []) %}
          {% if arr | length > 0 %}
            {{ arr[0] }}
          {% else %}
            {{ states('sensor.vent_meteo_vento') }}
          {% endif %}
  - resource: "https://air-quality-api.open-meteo.com/v1/air-quality?latitude=45.611133&longitude=12.356051&hourly=pm2_5&timezone=auto"
    scan_interval: 1800
    timeout: 30
    sensor:
      - name: "Vent Meteo PM2.5"
        unique_id: vent_meteo_pm25
        unit_of_measurement: "µg/m³"
        state_class: measurement
        icon: mdi:blur
        value_template: >-
          {% set root = value_json if value_json is defined else {} %}
          {% set data = root.get('hourly', {}).get('pm2_5', []) %}
          {% if data | length > 0 %}
            {{ data[0] }}
          {% else %}
            {{ states('sensor.vent_meteo_pm25') }}
          {% endif %}

# =============================
# TEMPLATE — KPI, PRIORITÀ E CONSIGLI
# =============================
template:
  - binary_sensor:
      - name: "VMC failsafe — sensori non ok"
        unique_id: vmc_failsafe_sensors_bad
        icon: mdi:alert-circle
        state: >-
          {% set specs = {
            'sensor.t_in_media': [-20, 50],
            'sensor.t_out': [-20, 50],
            'sensor.ur_in_media': [0, 100],
            'sensor.ur_out': [0, 100],
            'sensor.ah_in': [0, None],
            'sensor.ah_out': [0, None],
            'sensor.ur_in_bagno': [0, 100]
          } %}

          {% for sid, limits in specs.items() %}
            {% set s = states(sid) %}
            {% if s in ['unknown','unavailable','none',''] %}
              true
              {% break %}
            {% else %}
              {% set val = s|float(default=None) %}
              {% if val is none %}
                true
                {% break %}
              {% endif %}
              {% if (limits[0] is not none and val < limits[0]) or (limits[1] is not none and val > limits[1]) %}
                true
                {% break %}
              {% endif %}
            {% endif %}
          {% else %}
            false
          {% endfor %}
        attributes:
          problematic_sensors: >-
            {% set specs = {
              'sensor.t_in_media': [-20, 50],
              'sensor.t_out': [-20, 50],
              'sensor.ur_in_media': [0, 100],
              'sensor.ur_out': [0, 100],
              'sensor.ah_in': [0, None],
              'sensor.ah_out': [0, None],
              'sensor.ur_in_bagno': [0, 100]
            } %}
            {% set bad = [] %}
            {% for sid, limits in specs.items() %}
              {% set s = states(sid) %}
              {% if s in ['unknown','unavailable','', None] %}
                {% set bad = bad + [sid] %}
              {% else %}
                {% set val = s|float(default=None) %}
                {% if val is none %}
                  {% set bad = bad + [sid] %}
                {% elif (limits[0] is not none and val < limits[0]) or (limits[1] is not none and val > limits[1]) %}
                  {% set bad = bad + [sid] %}
                {% endif %}
              {% endif %}
            {% endfor %}
            {{ bad }}

      - name: "Stagione calda"
        unique_id: stagione_calda
        state: >
          {{ now().month in [5,6,7,8,9] or is_state('input_boolean.vent_override_estate','on') }}

      - name: "Stagione fredda"
        unique_id: stagione_fredda
        state: >
          {{ now().month in [11,12,1,2,3] }}

      - name: "VMC anti-secco attivo"
        unique_id: vmc_anti_secco
        icon: mdi:water-percent-alert
        state: >
          {% set ur_min_raw = states('sensor.ur_in_min') %}
          {% set ur_min = ur_min_raw|float(default=none) if ur_min_raw not in ['unknown','unavailable','', none] else none %}
          {% set soglia_raw = states('input_number.vmc_anti_secco_ur_min') %}
          {% set soglia = soglia_raw|float(40) if soglia_raw not in ['unknown','unavailable','', none] else 40 %}
          {% set notte = now().hour >= 23 or now().hour < 7 %}
          {{ is_state('binary_sensor.stagione_fredda','on') and notte and ur_min is not none and ur_min <= soglia }}

      - name: "VMC bagno boost auto"
        unique_id: vmc_bagno_boost_auto
        icon: mdi:fan-speed-3
        state: >
          {% set ur_b = states('sensor.ur_in_bagno')|float(default=none) %}
          {% set soglia_on = states('input_number.vmc_bagno_on')|float(75) %}
          {% set soglia_off = states('input_number.vmc_bagno_off')|float(65) %}
          {% if ur_b is none %}
            false
          {% else %}
            {% if is_state('binary_sensor.vmc_bagno_boost_auto','on') %}
              {{ ur_b >= soglia_off }}
            {% else %}
              {{ ur_b >= soglia_on }}
            {% endif %}
          {% endif %}

      - name: "VMC boost attivo"
        unique_id: vmc_boost_active
        icon: mdi:fan-speed-3
        state: >
          {{ is_state('input_boolean.vmc_boost_bagno','on') or is_state('binary_sensor.vmc_bagno_boost_auto','on') or is_state('timer.vmc_boost_lock','active') }}

      - name: "VMC freecooling candidato"
        unique_id: vmc_freecooling_candidate
        icon: mdi:snowflake-thermometer
        state: >
          {% set Tin = states('sensor.t_in_media')|float(default=none) %}
          {% set Tout = states('sensor.t_out')|float(default=none) %}
          {% set AHin = states('sensor.ah_in')|float(default=none) %}
          {% set AHout = states('sensor.ah_out')|float(default=none) %}
          {% set dt = states('sensor.delta_t_in_out')|float(default=none) %}
          {% set dah = states('sensor.delta_ah_in_out')|float(default=none) %}
          {% set dt_min = states('input_number.vmc_freecooling_delta')|float(2) %}
          {% set dah_min = states('input_number.vmc_freecooling_delta_ah')|float(2) %}
          {{ is_state('binary_sensor.stagione_calda','on')
             and Tin is number and Tout is number and AHin is number and AHout is number
             and Tout < Tin and AHout < AHin
             and dt is number and dt >= dt_min
             and dah is number and dah >= dah_min
             and is_state('switch.ac_notte','off') and is_state('switch.ac_giorno','off') }}

      - name: "vent_deltat_ok"
        unique_id: vent_deltat_ok
        state: >-
          {% set delta = states('sensor.delta_t_in_out')|float(default=none) %}
          {% set soglia = states('input_number.vent_deltat_min')|float(default=none) %}
          {{ delta is number and soglia is number and delta >= soglia }}
        availability: >-
          {{ states('sensor.delta_t_in_out') not in ['unknown','unavailable',''] and states('input_number.vent_deltat_min') not in ['unknown','unavailable',''] }}

      - name: "vent_deltaah_ok"
        unique_id: vent_deltaah_ok
        state: >-
          {% set delta = states('sensor.delta_ah_in_out')|float(default=none) %}
          {% set soglia = states('input_number.vent_deltaah_min')|float(default=none) %}
          {{ delta is number and soglia is number and delta >= soglia }}
        availability: >-
          {{ states('sensor.delta_ah_in_out') not in ['unknown','unavailable',''] and states('input_number.vent_deltaah_min') not in ['unknown','unavailable',''] }}

      - name: "vent_pioggia"
        unique_id: vent_pioggia
        device_class: moisture
        state: >
          {{ states('sensor.vent_meteo_precip')|float(0) > 0 }}

      - name: "vent_vento_blocco"
        unique_id: vent_vento_blocco
        state: >
          {% set vento = states('sensor.vent_meteo_vento')|float(default=0) %}
          {% set soglia = states('input_number.vent_vento_max')|float(6) %}
          {{ vento >= soglia }}

      - name: "vent_air_quality_ok"
        unique_id: vent_air_quality_ok
        state: >
          {% set pm = states('sensor.vent_meteo_pm25')|float(default=0) %}
          {% set soglia = states('input_number.vent_pm25_max')|float(25) %}
          {{ pm <= soglia }}

      - name: "vent_condizioni_meteo_ok"
        unique_id: vent_condizioni_meteo_ok
        state: >-
          {{ is_state('binary_sensor.vent_pioggia','off') and is_state('binary_sensor.vent_vento_blocco','off') and is_state('binary_sensor.vent_air_quality_ok','on') }}

      - name: "vent_condizioni_termiche_ok"
        unique_id: vent_condizioni_termiche_ok
        state: >-
          {{ is_state('binary_sensor.vent_deltat_ok','on') and is_state('binary_sensor.vent_deltaah_ok','on') }}

      - name: "vent_recommend_open"
        unique_id: vent_recommend_open
        device_class: opening
        state: >-
          {{ is_state('binary_sensor.stagione_calda','on') and is_state('binary_sensor.vent_condizioni_meteo_ok','on') and is_state('binary_sensor.vent_condizioni_termiche_ok','on') }}

      - name: "vent_recommend_close"
        unique_id: vent_recommend_close
        device_class: opening
        state: >-
          {{ not is_state('binary_sensor.vent_recommend_open','on') }}

      - name: "Clima — Apri finestre raccomandato"
        unique_id: clima_open_windows_recommended
        device_class: opening
        state: >
          {% set open_ok = is_state('binary_sensor.vent_recommend_open','on') %}
          {% set vmc_busy = is_state('sensor.vmc_freecooling_status','active') %}
          {{ open_ok and not vmc_busy }}

      - name: "vent_weather_block"
        unique_id: vent_weather_block
        icon: mdi:alert-octagon
        state: >-
          {{ not is_state('binary_sensor.vent_condizioni_meteo_ok','on') }}

      - name: "ventilation_priority"
        unique_id: ventilation_priority
        icon: mdi:arrow-top-right-bold-outline
        state: >
          {% if is_state('binary_sensor.vmc_failsafe_sensors_bad','on') %}
            P0_failsafe
          {% elif is_state('binary_sensor.vmc_boost_active','on') %}
            P1_boost_bagno
          {% elif is_state('binary_sensor.vmc_anti_secco','on') and is_state('timer.vmc_anti_secco_lock','active') %}
            P2_anti_secco
          {% elif is_state('sensor.vmc_freecooling_status','active') %}
            P3_freecooling
          {% elif is_state('input_select.vmc_mode','off') %}
            off
          {% elif is_state('input_select.vmc_mode','manual') %}
            manual
          {% else %}
            idle
          {% endif %}

  - sensor:
      - name: "VMC velocità target"
        unique_id: vmc_vel_target
        state: >
          {% if is_state('switch.vmc_vel_3','on') %}vel_3
          {% elif is_state('switch.vmc_vel_2','on') %}vel_2
          {% elif is_state('switch.vmc_vel_1','on') %}vel_1
          {% elif is_state('switch.vmc_vel_0','on') %}vel_0
          {% else %}off{% endif %}
        attributes:
          mode: "{{ states('input_select.vmc_mode') }}"

      - name: "VMC velocità index"
        unique_id: vmc_vel_index
        unit_of_measurement: "index"
        state: >
          {% if is_state('switch.vmc_vel_3','on') %}3
          {% elif is_state('switch.vmc_vel_2','on') %}2
          {% elif is_state('switch.vmc_vel_1','on') %}1
          {% elif is_state('switch.vmc_vel_0','on') %}0
          {% else %}0{% endif %}

      - name: "VMC reason"
        unique_id: vmc_reason
        state: >
          {% if is_state('binary_sensor.vmc_failsafe_sensors_bad','on') %}
            failsafe_sensori
          {% elif is_state('binary_sensor.vmc_boost_active','on') %}
            boost_bagno
          {% elif is_state('binary_sensor.vmc_anti_secco','on') and is_state('timer.vmc_anti_secco_lock','active') %}
            anti_secco
          {% elif is_state('sensor.vmc_freecooling_status','active') %}
            freecooling
          {% elif is_state('input_select.vmc_mode','manual') %}
            manual_user
          {% elif is_state('input_select.vmc_mode','off') %}
            spento
          {% else %}
            idle_auto
          {% endif %}
        attributes:
          priority: "{{ states('sensor.vmc_priority') }}"
          reason: "{{ this.state }}"

      - name: "VMC priority"
        unique_id: vmc_priority
        state: >
          {% if is_state('binary_sensor.vmc_failsafe_sensors_bad','on') %}P0_failsafe
          {% elif is_state('binary_sensor.vmc_boost_active','on') %}P1_boost_bagno
          {% elif is_state('binary_sensor.vmc_anti_secco','on') and is_state('timer.vmc_anti_secco_lock','active') %}P2_anti_secco
          {% elif is_state('sensor.vmc_freecooling_status','active') %}P3_freecooling
          {% elif is_state('input_select.vmc_mode','manual') %}manual
          {% elif is_state('input_select.vmc_mode','off') %}off
          {% else %}idle{% endif %}

      - name: "VMC freecooling status"
        unique_id: vmc_freecooling_status
        state: >
          {% set candidate = is_state('binary_sensor.vmc_freecooling_candidate','on') %}
          {% set maxrun = is_state('timer.vmc_freecooling_max_run','active') %}
          {% set cool = is_state('timer.vmc_freecooling_cooldown','active') %}
          {% if not candidate %}off
          {% elif cool %}cooldown
          {% elif maxrun %}active
          {% else %}maxrun_lock{% endif %}

      - name: "vent_ah_in"
        unique_id: vent_ah_in
        unit_of_measurement: "g/m³"
        state_class: measurement
        icon: mdi:water
        state: >-
          {% set ah_in = states('sensor.ah_in') %}
          {% if ah_in not in ['unknown','unavailable',''] %}
            {{ ah_in|float|round(2) }}
          {% else %}
            {% set T = states('input_number.vent_backup_t_in')|float(default=none) %}
            {% set RH = states('input_number.vent_backup_ur_in')|float(default=none) %}
            {% if T is number and RH is number %}
              {% set RHc = [ [RH, 100]|min, 1]|max %}
              {% set exponent = (17.67*T)/(T+243.5) %}
              {% set es = 6.112 * (2.718281828 ** exponent) %}
              {% set pv = RHc/100 * es %}
              {{ (216.7 * pv / (T + 273.15)) | round(2) }}
            {% else %}unavailable{% endif %}
          {% endif %}
        availability: >-
          {{ states('sensor.ah_in') not in ['unknown','unavailable',''] or (states('input_number.vent_backup_t_in') not in ['unknown','unavailable',''] and states('input_number.vent_backup_ur_in') not in ['unknown','unavailable','']) }}

      - name: "vent_ah_out"
        unique_id: vent_ah_out
        unit_of_measurement: "g/m³"
        state_class: measurement
        icon: mdi:water-outline
        state: "{{ states('sensor.ah_out') if states('sensor.ah_out') not in ['unknown','unavailable',''] else 'unavailable' }}"
        availability: >-
          {{ states('sensor.ah_out') not in ['unknown','unavailable',''] }}

      - name: "vent_weather_label"
        unique_id: vent_weather_label
        icon: mdi:weather-cloudy
        state: >-
          {% if is_state('binary_sensor.vent_pioggia','on') %}Pioggia
          {% elif is_state('binary_sensor.vent_vento_blocco','on') %}Vento forte
          {% elif is_state('binary_sensor.vent_air_quality_ok','off') %}Qualità aria non ok
          {% else %}OK{% endif %}

      - name: "ventilation_reason"
        unique_id: ventilation_reason
        icon: mdi:text
        state: "{{ states('sensor.ventilation_priority') }}"

# =============================
# AUTOMAZIONI — Controller VMC + boost + freecooling
# =============================
automation:
  - id: ventilation_vmc_controller
    alias: "Ventilazione — Controllo VMC"
    mode: restart
    trigger:
      - platform: time_pattern
        minutes: "/5"
      - platform: state
        entity_id:
          - input_select.vmc_mode
          - input_select.vmc_manual_speed
          - input_boolean.vmc_manual
          - input_boolean.vmc_boost_bagno
          - binary_sensor.vmc_bagno_boost_auto
          - binary_sensor.vmc_anti_secco
          - binary_sensor.vmc_failsafe_sensors_bad
          - binary_sensor.vmc_freecooling_candidate
          - timer.vmc_boost_lock
          - timer.vmc_anti_secco_lock
          - timer.vmc_freecooling_max_run
          - timer.vmc_freecooling_cooldown
    action:
      - variables:
          mode: "{{ states('input_select.vmc_mode') }}"
          manual_flag: "{{ is_state('input_boolean.vmc_manual','on') }}"
          failsafe: "{{ is_state('binary_sensor.vmc_failsafe_sensors_bad','on') }}"
          boost: "{{ is_state('binary_sensor.vmc_boost_active','on') }}"
          anti_secco: "{{ is_state('binary_sensor.vmc_anti_secco','on') }}"
          freecool: "{{ is_state('binary_sensor.vmc_freecooling_candidate','on') }}"
      - choose:
          - conditions:
              - condition: or
                conditions:
                  - condition: template
                    value_template: "{{ mode == 'off' }}"
                  - condition: template
                    value_template: "{{ failsafe }}"
            sequence:
              - service: switch.turn_off
                target:
                  entity_id:
                    - switch.vmc_vel_0
                    - switch.vmc_vel_1
                    - switch.vmc_vel_2
                    - switch.vmc_vel_3
          - conditions:
              - condition: or
                conditions:
                  - condition: template
                    value_template: "{{ mode == 'manual' }}"
                  - condition: template
                    value_template: "{{ manual_flag }}"
            sequence:
              - service: timer.start
                target:
                  entity_id: timer.vmc_manual_timeout
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ states('input_select.vmc_manual_speed') == 'vel_3' }}"
                    sequence:
                      - service: switch.turn_on
                        target:
                          entity_id: switch.vmc_vel_3
                      - service: switch.turn_off
                        target:
                          entity_id:
                            - switch.vmc_vel_0
                            - switch.vmc_vel_1
                            - switch.vmc_vel_2
                  - conditions:
                      - condition: template
                        value_template: "{{ states('input_select.vmc_manual_speed') == 'vel_2' }}"
                    sequence:
                      - service: switch.turn_on
                        target:
                          entity_id: switch.vmc_vel_2
                      - service: switch.turn_off
                        target:
                          entity_id:
                            - switch.vmc_vel_0
                            - switch.vmc_vel_1
                            - switch.vmc_vel_3
                  - conditions:
                      - condition: template
                        value_template: "{{ states('input_select.vmc_manual_speed') == 'vel_1' }}"
                    sequence:
                      - service: switch.turn_on
                        target:
                          entity_id: switch.vmc_vel_1
                      - service: switch.turn_off
                        target:
                          entity_id:
                            - switch.vmc_vel_0
                            - switch.vmc_vel_2
                            - switch.vmc_vel_3
                  - conditions:
                      - condition: template
                        value_template: "{{ states('input_select.vmc_manual_speed') == 'vel_0' }}"
                    sequence:
                      - service: switch.turn_on
                        target:
                          entity_id: switch.vmc_vel_0
                      - service: switch.turn_off
                        target:
                          entity_id:
                            - switch.vmc_vel_1
                            - switch.vmc_vel_2
                            - switch.vmc_vel_3
                  - conditions:
                      - condition: template
                        value_template: "{{ states('input_select.vmc_manual_speed') == 'off' }}"
                    sequence:
                      - service: switch.turn_off
                        target:
                          entity_id:
                            - switch.vmc_vel_0
                            - switch.vmc_vel_1
                            - switch.vmc_vel_2
                            - switch.vmc_vel_3
              - stop: "Manual mode engaged"
          - conditions:
              - condition: template
                value_template: "{{ boost }}"
            sequence:
              - service: switch.turn_on
                target:
                  entity_id: switch.vmc_vel_3
              - service: switch.turn_off
                target:
                  entity_id:
                    - switch.vmc_vel_0
                    - switch.vmc_vel_1
                    - switch.vmc_vel_2
              - service: timer.start
                target:
                  entity_id: timer.vmc_boost_lock
          - conditions:
              - condition: template
                value_template: "{{ anti_secco }}"
              - condition: state
                entity_id: timer.vmc_anti_secco_lock
                state: "active"
            sequence:
              - service: switch.turn_on
                target:
                  entity_id: switch.vmc_vel_0
              - service: switch.turn_off
                target:
                  entity_id:
                    - switch.vmc_vel_1
                    - switch.vmc_vel_2
                    - switch.vmc_vel_3
          - conditions:
              - condition: template
                value_template: "{{ freecool }}"
              - condition: state
                entity_id: timer.vmc_freecooling_cooldown
                state: "idle"
            sequence:
              - service: switch.turn_on
                target:
                  entity_id: switch.vmc_vel_2
              - service: switch.turn_off
                target:
                  entity_id:
                    - switch.vmc_vel_0
                    - switch.vmc_vel_1
                    - switch.vmc_vel_3
              - service: timer.start
                target:
                  entity_id: timer.vmc_freecooling_max_run
        default:
          - service: switch.turn_on
            target:
              entity_id: switch.vmc_vel_1
          - service: switch.turn_off
            target:
              entity_id:
                - switch.vmc_vel_0
                - switch.vmc_vel_2
                - switch.vmc_vel_3

  - id: ventilation_vmc_manual_timeout
    alias: "Ventilazione — Timeout manuale"
    trigger:
      - platform: event
        event_type: timer.finished
        event_data:
          entity_id: timer.vmc_manual_timeout
    action:
      - service: input_select.select_option
        target:
          entity_id: input_select.vmc_mode
        data:
          option: auto
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.vmc_manual

  - id: ventilation_vmc_boost_reset
    alias: "Ventilazione — Fine boost bagno"
    trigger:
      - platform: event
        event_type: timer.finished
        event_data:
          entity_id: timer.vmc_boost_lock
    action:
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.vmc_boost_bagno

  - id: ventilation_vmc_anti_secco_lock
    alias: "Ventilazione — Lock anti-secco"
    trigger:
      - platform: state
        entity_id: binary_sensor.vmc_anti_secco
        to: 'on'
    action:
      - service: timer.start
        target:
          entity_id: timer.vmc_anti_secco_lock

  - id: ventilation_vmc_freecooling_lifecycle
    alias: "Ventilazione — Ciclo freecooling"
    mode: restart
    trigger:
      - platform: state
        entity_id: binary_sensor.vmc_freecooling_candidate
      - platform: event
        event_type: timer.finished
        event_data:
          entity_id: timer.vmc_freecooling_max_run
      - platform: event
        event_type: timer.finished
        event_data:
          entity_id: timer.vmc_freecooling_cooldown
    action:
      - choose:
          - conditions:
              - condition: state
                entity_id: binary_sensor.vmc_freecooling_candidate
                state: 'on'
              - condition: state
                entity_id: timer.vmc_freecooling_max_run
                state: 'idle'
              - condition: state
                entity_id: timer.vmc_freecooling_cooldown
                state: 'idle'
            sequence:
              - service: timer.start
                target:
                  entity_id: timer.vmc_freecooling_max_run
          - conditions:
              - condition: template
                value_template: "{{ trigger.event.data.entity_id == 'timer.vmc_freecooling_max_run' }}"
            sequence:
              - service: timer.start
                target:
                  entity_id: timer.vmc_freecooling_cooldown
          - conditions:
              - condition: state
                entity_id: binary_sensor.vmc_freecooling_candidate
                state: 'off'
            sequence:
              - service: timer.cancel
                target:
                  entity_id:
                    - timer.vmc_freecooling_max_run
                    - timer.vmc_freecooling_cooldown

  - id: ventilation_vent_message
    alias: "Ventilazione — Messaggio consigli"
    trigger:
      - platform: state
        entity_id:
          - binary_sensor.vent_recommend_open
          - binary_sensor.vent_recommend_close
          - binary_sensor.vent_weather_block
          - binary_sensor.vmc_freecooling_candidate
          - binary_sensor.vmc_failsafe_sensors_bad
    action:
      - choose:
          - conditions:
              - condition: state
                entity_id: binary_sensor.vmc_failsafe_sensors_bad
                state: 'on'
            sequence:
              - service: input_text.set_value
                target:
                  entity_id: input_text.vent_messaggio_consiglio
                data:
                  value: "Sensori non disponibili: controllo VMC in failsafe."
          - conditions:
              - condition: state
                entity_id: binary_sensor.vent_recommend_open
                state: 'on'
            sequence:
              - service: input_text.set_value
                target:
                  entity_id: input_text.vent_messaggio_consiglio
                data:
                  value: "Apri le finestre: ΔT/ΔAH favorevoli e meteo ok."
          - conditions:
              - condition: state
                entity_id: binary_sensor.vent_recommend_close
                state: 'on'
              - condition: state
                entity_id: binary_sensor.vent_weather_block
                state: 'on'
            sequence:
              - service: input_text.set_value
                target:
                  entity_id: input_text.vent_messaggio_consiglio
                data:
                  value: "Chiudi finestre: meteo/PM/vento non ok."
          - conditions:
              - condition: state
                entity_id: binary_sensor.vmc_freecooling_candidate
                state: 'on'
            sequence:
              - service: input_text.set_value
                target:
                  entity_id: input_text.vent_messaggio_consiglio
                data:
                  value: "Freecooling attivo: VMC in raffrescamento passivo."
        default:
          - service: input_text.set_value
            target:
              entity_id: input_text.vent_messaggio_consiglio
            data:
              value: "Monitoraggio attivo: nessun consiglio specifico."

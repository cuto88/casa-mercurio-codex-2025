# ===============================
# FILE: config/packages/2_heating.yaml
# ===============================
###############################################################################
# Riscaldamento a pavimento — logica, helper e automazioni
# Sensori reali: sensor.t_in_giorno, _notte1, _notte2, _bagno, sensor.t_out
###############################################################################

# ---------------------------------------------------------------------------
# PERSONALIZZAZIONI
# ---------------------------------------------------------------------------
homeassistant:
  customize:
    switch.4_ch_interrutore_3:
      friendly_name: "Riscaldamento — Interruttore Generale"
      icon: mdi:radiator

# ---------------------------------------------------------------------------
# TOGGLE DI ZONA + OVERRIDE
# ---------------------------------------------------------------------------
input_boolean:
  # Inclusione delle stanze nel calcolo
  heating_use_giorno:
    name: Usa Zona Giorno
    icon: mdi:home
  heating_use_notte1:
    name: Usa Notte1
    icon: mdi:bed
  heating_use_notte2:
    name: Usa Notte2
    icon: mdi:bed
  heating_use_bagno:
    name: Usa Bagno
    icon: mdi:shower

  # Logica generale e override
  heating_enable:
    name: Abilita logica riscaldamento
    icon: mdi:radiator
  heating_force_on:
    name: Forza ON (override)
    icon: mdi:flash
  heating_force_off:
    name: Forza OFF (override)
    icon: mdi:cancel
  heating_manual:
    name: Controllo manuale riscaldamento
    icon: mdi:hand-back-right
  heating_manual_active:
    name: Modalità manuale attiva
    icon: mdi:hand-back-right

input_select:
  heating_manual_mode:
    name: Riscaldamento — Modalità manuale
    options: ["OFF", "ECO", "COMFORT", "BOOST"]
    icon: mdi:tune-variant
    initial: "COMFORT"

# ---------------------------------------------------------------------------
# PARAMETRI / SOGLIE
# ---------------------------------------------------------------------------
input_number:
  temp_target_risc:
    name: Target comfort (°C)
    min: 18
    max: 23
    step: 0.1
    unit_of_measurement: "°C"
    icon: mdi:home-thermometer
  heating_tolerance:
    name: Isteresi sotto-target (°C)
    min: 0.2
    max: 1.0
    step: 0.1
    unit_of_measurement: "°C"
    icon: mdi:axis-x-arrow
  heating_ext_cold_threshold:
    name: Soglia esterna "freddo" (°C)
    min: -10
    max: 20
    step: 0.5
    unit_of_measurement: "°C"
    icon: mdi:snowflake
  heating_min_on_minutes:
    name: Min ON (min)
    min: 5
    max: 120
    step: 5
    unit_of_measurement: "min"
    icon: mdi:timer-play
  heating_min_off_minutes:
    name: Min OFF (min)
    min: 5
    max: 120
    step: 5
    unit_of_measurement: "min"
    icon: mdi:timer-off
  heating_hours_on_daily:
    name: "Riscaldamento — Ore ON / giorno"
    unit_of_measurement: "h"
    min: 0
    max: 24
    step: 0.1
    icon: mdi:timeline-clock
  heating_setpoint_night:
    name: Setpoint notte (°C)
    min: 16
    max: 21
    step: 0.1
    unit_of_measurement: "°C"
    icon: mdi:weather-night
  heating_boost_delta:
    name: Delta boost FV (°C)
    min: 0
    max: 1.0
    step: 0.1
    unit_of_measurement: "°C"
    icon: mdi:flash
  heating_antifreeze_threshold:
    name: Soglia anti-gelo (°C)
    min: 5
    max: 18
    step: 0.5
    unit_of_measurement: "°C"
    icon: mdi:snowflake-alert

input_datetime:
  heating_window_start:
    name: Fascia start (orario)
    has_time: true
    has_date: false
  heating_window_end:
    name: Fascia end (orario)
    has_time: true
    has_date: false

# ---------------------------------------------------------------------------
# TIMER
# ---------------------------------------------------------------------------
timer:
  heating_manual_timeout:
    name: Riscaldamento — Timeout manuale
    duration: "01:00:00"

# ---------------------------------------------------------------------------
# TEMPLATE (SENSORI E BINARI)
# ---------------------------------------------------------------------------
template:
  - sensor:
      # Elenco delle stanze attive (solo quelle abilitate)
      - name: "Heating — stanze attive"
        unique_id: heating_rooms_active
        availability: "true"
        state: >-
          {% set rooms = [
            ('Zona Giorno', 'sensor.t_in_giorno', 'input_boolean.heating_use_giorno'),
            ('Notte1', 'sensor.t_in_notte1', 'input_boolean.heating_use_notte1'),
            ('Notte2', 'sensor.t_in_notte2', 'input_boolean.heating_use_notte2'),
            ('Bagno', 'sensor.t_in_bagno', 'input_boolean.heating_use_bagno')
          ] %}
          {% set active = [] %}
          {% for label, sid, tog in rooms %}
            {% if is_state(tog, 'on') %}
              {% set active = active + [label] %}
            {% endif %}
          {% endfor %}
          {{ active | join(', ') if active | length > 0 else 'Nessuna (⚠️)' }}

      # Temperatura interna minima fra le stanze attive
      - name: "Heating — T interna minima"
        unique_id: heating_t_in_min
        unit_of_measurement: "°C"
        device_class: temperature
        availability: >-
          {% set rooms = [
            ('sensor.t_in_giorno', 'input_boolean.heating_use_giorno'),
            ('sensor.t_in_notte1', 'input_boolean.heating_use_notte1'),
            ('sensor.t_in_notte2', 'input_boolean.heating_use_notte2'),
            ('sensor.t_in_bagno', 'input_boolean.heating_use_bagno')
          ] %}
          {% set vals = [] %}
          {% for sid, tog in rooms %}
            {% set ent = states.get(sid) %}
            {% if is_state(tog, 'on') and ent is not none and ent.state not in ['unknown', 'unavailable', ''] %}
              {% set vals = vals + [ent.state | float] %}
            {% endif %}
          {% endfor %}
          {{ vals | length > 0 }}
        state: >-
          {% set rooms = [
            ('sensor.t_in_giorno', 'input_boolean.heating_use_giorno'),
            ('sensor.t_in_notte1', 'input_boolean.heating_use_notte1'),
            ('sensor.t_in_notte2', 'input_boolean.heating_use_notte2'),
            ('sensor.t_in_bagno', 'input_boolean.heating_use_bagno')
          ] %}
          {% set vals = [] %}
          {% for sid, tog in rooms %}
            {% set ent = states.get(sid) %}
            {% if is_state(tog, 'on') and ent is not none and ent.state not in ['unknown', 'unavailable', ''] %}
              {% set vals = vals + [ent.state | float] %}
            {% endif %}
          {% endfor %}
          {% if vals | length > 0 %}{{ (vals | min) | round(2) }}{% else %}unknown{% endif %}

      # Numero stanze conteggiate e quante sono sotto-target
      - name: "Heating — stanze sotto target"
        unique_id: heating_rooms_below_target
        unit_of_measurement: "stanze"
        availability: "{{ states('input_number.temp_target_risc') not in ['unknown', 'unavailable', ''] and states('input_number.heating_tolerance') not in ['unknown', 'unavailable', ''] }}"
        state: >-
          {% set rooms = [
            ('sensor.t_in_giorno', 'input_boolean.heating_use_giorno'),
            ('sensor.t_in_notte1', 'input_boolean.heating_use_notte1'),
            ('sensor.t_in_notte2', 'input_boolean.heating_use_notte2'),
            ('sensor.t_in_bagno', 'input_boolean.heating_use_bagno')
          ] %}
          {% set t_target = states('input_number.temp_target_risc') | float(21) %}
          {% set tol = states('input_number.heating_tolerance') | float(0.5) %}
          {% set below = [] %}
          {% for sid, tog in rooms %}
            {% set ent = states.get(sid) %}
            {% if is_state(tog, 'on') and ent is not none and ent.state not in ['unknown', 'unavailable', ''] %}
              {% if ent.state | float < (t_target - tol) %}
                {% set below = below + [sid] %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {{ below | length }}
        attributes:
          stanze_conteggiate: >-
            {% set rooms = [
              ('sensor.t_in_giorno', 'input_boolean.heating_use_giorno'),
              ('sensor.t_in_notte1', 'input_boolean.heating_use_notte1'),
              ('sensor.t_in_notte2', 'input_boolean.heating_use_notte2'),
              ('sensor.t_in_bagno', 'input_boolean.heating_use_bagno')
            ] %}
            {% set count = 0 %}
            {% for sid, tog in rooms %}
              {% set ent = states.get(sid) %}
              {% if is_state(tog, 'on') and ent is not none and ent.state not in ['unknown', 'unavailable', ''] %}
                {% set count = count + 1 %}
              {% endif %}
            {% endfor %}
            {{ count }}

      # Minuti dall'ultimo cambio dello switch generale (ON↔OFF)
      - name: "Heating — minuti da ultimo cambio"
        unique_id: heating_minutes_since_change
        object_id: heating_minuti_da_ultimo_cambio
        unit_of_measurement: "min"
        state_class: measurement
        state: >-
          {% set entity_id = 'switch.4_ch_interrutore_3' %}
          {% set ent = states[entity_id] if entity_id in states else None %}
          {% if ent is none or ent.last_changed is none or ent.state in ['unknown', 'unavailable'] %}
            unknown
          {% else %}
            {{ ((as_timestamp(now()) - as_timestamp(ent.last_changed)) / 60) | round(1) }}
          {% endif %}

      - name: "Heating Priority"
        unique_id: heating_priority
        icon: mdi:arrow-top-right-bold-outline
        state: >-
          {% set attr = state_attr('sensor.heating_reason', 'priority') %}
          {% if attr not in [none, ''] %}
            {{ attr }}
          {% elif is_state('binary_sensor.heating_failsafe_sensors_bad', 'on') %}
            P0_failsafe
          {% elif is_state('input_boolean.heating_manual', 'on') %}
            manual
          {% else %}
            idle
          {% endif %}
        attributes:
          reason: "{{ state_attr('sensor.heating_reason', 'reason') or '—' }}"
          action: "{{ state_attr('sensor.heating_reason', 'action') or '—' }}"

      - name: "Heating Reason"
        unique_id: heating_reason
        icon: mdi:text
        state: >-
          {{ state_attr('sensor.heating_reason', 'priority') if state_attr('sensor.heating_reason', 'priority') not in [none, ''] else 'idle' }}
        attributes:
          priority: "{{ state_attr('sensor.heating_reason','priority') or 'idle' }}"
          reason: "{{ state_attr('sensor.heating_reason','reason') or '—' }}"
          action: "{{ state_attr('sensor.heating_reason','action') or '—' }}"

      - name: "Heating — errore zona giorno"
        unique_id: heating_error_zona_giorno
        unit_of_measurement: "°C"
        state_class: measurement
        device_class: temperature
        availability: >-
          {{ states('sensor.t_in_giorno') not in ['unknown','unavailable',''] }}
        state: >-
          {% set setp = states('input_number.temp_target_risc')|float(21) %}
          {% set temp = states('sensor.t_in_giorno')|float(0) %}
          {{ (setp - temp) | round(2) }}

      - name: "Heating — errore zona notte"
        unique_id: heating_error_zona_notte
        unit_of_measurement: "°C"
        state_class: measurement
        device_class: temperature
        availability: >-
          {{ states('sensor.t_in_notte1') not in ['unknown','unavailable',''] }}
        state: >-
          {% set setp = states('input_number.temp_target_risc')|float(21) %}
          {% set temp = states('sensor.t_in_notte1')|float(0) %}
          {{ (setp - temp) | round(2) }}

  - binary_sensor:
      - name: "Heating failsafe — sensori non ok"
        unique_id: heating_failsafe_sensors_bad
        icon: mdi:alert-circle
        state: >
          {% set specs = {
            'sensor.t_in_giorno': [-20, 40],
            'sensor.t_in_notte1': [-20, 40],
            'sensor.t_in_notte2': [-20, 40],
            'sensor.t_in_bagno': [-20, 40],
            'sensor.t_out': [-30, 50]
          } %}
          {% set bad = false %}
          {% for sid, (lo, hi) in specs.items() %}
            {% if bad %}{% break %}{% endif %}
            {% set ent = states[sid] if sid in states else None %}
            {% if ent is none or ent.state in ['unknown','unavailable',''] %}
              {% set bad = true %}
            {% elif ent.state | float(0) < lo or ent.state | float(0) > hi %}
              {% set bad = true %}
            {% endif %}
          {% endfor %}
          {{ bad }}

      - name: "Heating — finestra oraria comfort"
        unique_id: heating_window_comfort
        state: >-
          {% set start = '06:30' %}
          {% set end = '22:30' %}
          {% set nowt = now().strftime('%H:%M') %}
          {{ start <= nowt <= end }}

      - name: "Heating — finestra fotovoltaico"
        unique_id: heating_window_pv
        state: >-
          {% set start = '10:00' %}
          {% set end = '16:00' %}
          {% set nowt = now().strftime('%H:%M') %}
          {{ start <= nowt <= end }}

      - name: "Heating — finestra notte"
        unique_id: heating_window_night
        state: >-
          {% set notte = now().hour >= 22 or now().hour < 6 %}
          {{ notte }}


# ---------------------------------------------------------------------------
# SENSORI STATISTICI — Ore ON oggi/ieri
# ---------------------------------------------------------------------------
sensor:
  - platform: history_stats
    name: "Riscaldamento — Ore ON oggi"
    unique_id: heating_hours_on_today
    entity_id: switch.4_ch_interrutore_3
    state: "on"
    type: time
    start: "{{ today_at('00:00') }}"
    end: "{{ now() }}"

  - platform: history_stats
    name: "Riscaldamento — Ore ON ieri"
    unique_id: heating_hours_on_yesterday
    entity_id: switch.4_ch_interrutore_3
    state: "on"
    type: time
    start: "{{ (today_at('00:00') - timedelta(days=1)) }}"
    end: "{{ today_at('00:00') }}"

# ---------------------------------------------------------------------------
# SCRIPT
# ---------------------------------------------------------------------------
script:
  heating_clear_overrides:
    alias: "Heating — reset override"
    sequence:
      - service: input_boolean.turn_off
        target: { entity_id: input_boolean.heating_force_on }
      - service: input_boolean.turn_off
        target: { entity_id: input_boolean.heating_force_off }
      - service: timer.cancel
        target: { entity_id: timer.heating_manual_timeout }

# ---------------------------------------------------------------------------
# AUTOMAZIONI
# ---------------------------------------------------------------------------
automation:
  # PRIORITÀ CONTROLLER HEATING
  # P0) Failsafe sensori / sicurezza → spegni tutto
  # P1) Protezione gelo → garantisci minima T interna
  # P2) Comfort base → mantieni 21°C in orari standard
  # P3) Spinta con FV → usa surplus 10:00–16:00 per anticipare/estendere
  # P4) Night setback → tollera calo notturno ma evita raffreddamenti eccessivi

  - id: heating_manual_override
    alias: "HEATING — Modalità manuale"
    mode: restart
    triggers:
      - trigger: state
        entity_id:
          - input_boolean.heating_manual
          - input_select.heating_manual_mode
      - trigger: event
        event_type: timer.finished
        event_data:
          entity_id: timer.heating_manual_timeout
    actions:
      - choose:
          - conditions:
              - condition: state
                entity_id: input_boolean.heating_manual
                state: "on"
              - condition: template
                value_template: "{{ trigger.platform != 'event' }}"
            sequence:
              - service: timer.start
                target:
                  entity_id: timer.heating_manual_timeout
              - choose:
                  - conditions: "{{ is_state('input_select.heating_manual_mode','OFF') }}"
                    sequence:
                      - service: switch.turn_off
                        target:
                          entity_id: switch.4_ch_interrutore_3
                      - event: template_event
                        event_data:
                          entity_id: sensor.heating_reason
                          attributes:
                            priority: manual
                            reason: "Manuale OFF"
                            action: "switch.off"
                  - conditions: "{{ is_state('input_select.heating_manual_mode','ECO') }}"
                    sequence:
                      - service: switch.turn_on
                        target:
                          entity_id: switch.4_ch_interrutore_3
                      - event: template_event
                        event_data:
                          entity_id: sensor.heating_reason
                          attributes:
                            priority: manual
                            reason: "Manuale ECO"
                            action: "switch.on (eco)"
                  - conditions: "{{ is_state('input_select.heating_manual_mode','COMFORT') }}"
                    sequence:
                      - service: switch.turn_on
                        target:
                          entity_id: switch.4_ch_interrutore_3
                      - event: template_event
                        event_data:
                          entity_id: sensor.heating_reason
                          attributes:
                            priority: manual
                            reason: "Manuale COMFORT"
                            action: "switch.on"
                  - conditions: "{{ is_state('input_select.heating_manual_mode','BOOST') }}"
                    sequence:
                      - service: switch.turn_on
                        target:
                          entity_id: switch.4_ch_interrutore_3
                      - event: template_event
                        event_data:
                          entity_id: sensor.heating_reason
                          attributes:
                            priority: manual
                            reason: "Manuale BOOST"
                            action: "switch.on (boost)"
        default:
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ trigger.platform == 'event' }}"
                sequence:
                  - service: input_boolean.turn_off
                    target:
                      entity_id: input_boolean.heating_manual
          - service: timer.cancel
            target:
              entity_id: timer.heating_manual_timeout
          # Nessuna azione ulteriore: controller automatico riprende

  - id: heating_p0_failsafe
    alias: "HEATING P0 — Failsafe sensori"
    mode: restart
    triggers:
      - trigger: state
        entity_id: binary_sensor.heating_failsafe_sensors_bad
      - trigger: time_pattern
        minutes: "/5"
    conditions:
      - condition: state
        entity_id: binary_sensor.heating_failsafe_sensors_bad
        state: "on"
    actions:
      - service: switch.turn_off
        target:
          entity_id: switch.4_ch_interrutore_3
      - event: template_event
        event_data:
          entity_id: sensor.heating_reason
          attributes:
            priority: P0_failsafe
            reason: "Sensore non valido (stop di sicurezza)"
            action: "switch.off"

  - id: heating_controller_priority
    alias: "HEATING — Controllo priorità P1–P4"
    mode: restart
    triggers:
      - trigger: time_pattern
        minutes: "/5"
      - trigger: state
        entity_id:
          - binary_sensor.heating_failsafe_sensors_bad
          - binary_sensor.heating_window_comfort
          - binary_sensor.heating_window_pv
          - binary_sensor.heating_window_night
          - binary_sensor.surplus_ok
          - input_boolean.heating_enable
          - input_boolean.heating_use_giorno
          - input_boolean.heating_use_notte1
          - input_boolean.heating_use_notte2
          - input_boolean.heating_use_bagno
          - input_boolean.heating_manual
          - switch.4_ch_interrutore_3
          - sensor.t_in_giorno
          - sensor.t_in_notte1
          - sensor.t_in_notte2
          - sensor.t_in_bagno
          - sensor.t_out
    actions:
      - variables:
          t_min: >-
            {% set raw = states('sensor.heating_t_in_min') %}
            {{ raw|float(0) if raw not in ['unknown','unavailable','', none] else 0 }}
          comfort: "{{ states('input_number.temp_target_risc')|float(21) }}"
          tol: "{{ states('input_number.heating_tolerance')|float(0.5) }}"
          night_sp: "{{ states('input_number.heating_setpoint_night')|float(19) }}"
          anti_frost: "{{ states('input_number.heating_antifreeze_threshold')|float(10) }}"
          boost_delta: "{{ states('input_number.heating_boost_delta')|float(0.3) }}"
          stagione_calda: "{{ is_state('binary_sensor.stagione_calda','on') }}"

      - choose:
          # P0: failsafe → esci
          - conditions:
              - condition: state
                entity_id: binary_sensor.heating_failsafe_sensors_bad
                state: "on"
            sequence: []

          # Manuale attivo → esci
          - conditions:
              - condition: or
                conditions:
                  - condition: state
                    entity_id: input_boolean.heating_manual
                    state: "on"
                  - condition: state
                    entity_id: input_boolean.heating_manual_active
                    state: "on"
            sequence: []

          # P1: antigelo
          - conditions:
              - condition: template
                value_template: "{{ t_min is not none and t_min < anti_frost }}"
            sequence:
              - service: switch.turn_on
                target:
                  entity_id: switch.4_ch_interrutore_3
              - event: template_event
                event_data:
                  entity_id: sensor.heating_reason
                  attributes:
                    priority: P1_anti_frost
                    reason: "T interna {{ t_min }}°C < soglia antigelo"
                    action: "switch.on"

          # P2: comfort base
          - conditions:
              - condition: template
                value_template: >
                  {{
                    is_state('input_boolean.heating_enable','on') and
                    not stagione_calda and
                    is_state('binary_sensor.heating_window_comfort','on') and
                    t_min is not none and
                    t_min < (comfort - tol)
                  }}
            sequence:
              - service: switch.turn_on
                target:
                  entity_id: switch.4_ch_interrutore_3
              - event: template_event
                event_data:
                  entity_id: sensor.heating_reason
                  attributes:
                    priority: P2_comfort
                    reason: "Comfort: T_min {{ t_min }}°C < target {{ comfort - tol }}°C"
                    action: "switch.on"

          # P3: boost FV
          - conditions:
              - condition: template
                value_template: >
                  {{
                    is_state('input_boolean.heating_enable','on') and
                    is_state('binary_sensor.heating_window_pv','on') and
                    is_state('binary_sensor.surplus_ok','on') and
                    t_min is not none and
                    t_min < (comfort - boost_delta)
                  }}
            sequence:
              - service: switch.turn_on
                target:
                  entity_id: switch.4_ch_interrutore_3
              - event: template_event
                event_data:
                  entity_id: sensor.heating_reason
                  attributes:
                    priority: P3_pv_boost
                    reason: "Surplus FV: T_min {{ t_min }}°C < target boost {{ comfort - boost_delta }}°C"
                    action: "switch.on"

          # P4: night setback
          - conditions:
              - condition: template
                value_template: >
                  {{
                    is_state('input_boolean.heating_enable','on') and
                    is_state('binary_sensor.heating_window_night','on') and
                    t_min is not none and
                    t_min < (night_sp - tol)
                  }}
            sequence:
              - service: switch.turn_on
                target:
                  entity_id: switch.4_ch_interrutore_3
              - event: template_event
                event_data:
                  entity_id: sensor.heating_reason
                  attributes:
                    priority: P4_night_setback
                    reason: "Night: T_min {{ t_min }}°C < soglia notte {{ night_sp - tol }}°C"
                    action: "switch.on"

        default:
          - choose:
              - conditions:
                  - condition: state
                    entity_id: switch.4_ch_interrutore_3
                    state: "on"
                sequence:
                  - service: switch.turn_off
                    target:
                      entity_id: switch.4_ch_interrutore_3
          - event: template_event
            event_data:
              entity_id: sensor.heating_reason
              attributes:
                priority: idle
                reason: "Nessuna priorità attiva"
                action: "switch.off"

  # LEGACY AUTOMATIONS (disattivate dopo refactor)
  # - heating_decision_loop
  # - heating_manual_handler

  - id: heating_log_hours_daily
    alias: "Heating — scrivi ore ON di ieri nell'helper giornaliero"
    trigger:
      - platform: time
        at: "00:05:00"
    action:
      - service: input_number.set_value
        target:
          entity_id: input_number.heating_hours_on_daily
        data:
          value: "{{ states('sensor.heating_hours_on_yesterday') | float(0) }}"

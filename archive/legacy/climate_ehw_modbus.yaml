# EHW Modbus package
#
# CHECK RAPIDO (30 minuti)
# 1) Imposta setpoint reale a 45°C e osserva quale raw cambia:
#    - sensor.ehw_setpoint_raw_a (doc_reg 1104)
#    - sensor.ehw_setpoint_raw_b (doc_reg 1105)
# 2) Seleziona il corretto addressing mode in input_select.ehw_address_mode.
# 3) Regola ehw_setpoint_scale con formula: scale = Δ°C / Δraw.
# 4) Se top/bottom sono invertiti, attiva input_boolean.ehw_swap_top_bottom.

modbus:
  - name: mirai_ehw
    type: tcp
    host: !secret ehw_modbus_host
    port: 502
    delay: 1
    message_wait_milliseconds: 30
    timeout: 2
    retries: 0
    sensors:
      # T01..T06 RAW (A = doc_reg - 1, B = doc_reg)
      - name: "EHW T01 raw A"
        unique_id: ehw_t01_raw_a
        address: 2018
        input_type: holding
        data_type: uint16
        unit_of_measurement: "raw"
        scan_interval: 10
        slave: 3

      - name: "EHW T01 raw B"
        unique_id: ehw_t01_raw_b
        address: 2019
        input_type: holding
        data_type: uint16
        unit_of_measurement: "raw"
        scan_interval: 10
        slave: 3

      - name: "EHW T02 raw A"
        unique_id: ehw_t02_raw_a
        address: 2019
        input_type: holding
        data_type: uint16
        unit_of_measurement: "raw"
        scan_interval: 10
        slave: 3

      - name: "EHW T02 raw B"
        unique_id: ehw_t02_raw_b
        address: 2020
        input_type: holding
        data_type: uint16
        unit_of_measurement: "raw"
        scan_interval: 10
        slave: 3

      - name: "EHW T03 raw A"
        unique_id: ehw_t03_raw_a
        address: 2020
        input_type: holding
        data_type: uint16
        unit_of_measurement: "raw"
        scan_interval: 10
        slave: 3

      - name: "EHW T03 raw B"
        unique_id: ehw_t03_raw_b
        address: 2021
        input_type: holding
        data_type: uint16
        unit_of_measurement: "raw"
        scan_interval: 10
        slave: 3

      - name: "EHW T04 raw A"
        unique_id: ehw_t04_raw_a
        address: 2021
        input_type: holding
        data_type: uint16
        unit_of_measurement: "raw"
        scan_interval: 10
        slave: 3

      - name: "EHW T04 raw B"
        unique_id: ehw_t04_raw_b
        address: 2022
        input_type: holding
        data_type: uint16
        unit_of_measurement: "raw"
        scan_interval: 10
        slave: 3

      - name: "EHW T05 raw A"
        unique_id: ehw_t05_raw_a
        address: 2022
        input_type: holding
        data_type: uint16
        unit_of_measurement: "raw"
        scan_interval: 10
        slave: 3

      - name: "EHW T05 raw B"
        unique_id: ehw_t05_raw_b
        address: 2023
        input_type: holding
        data_type: uint16
        unit_of_measurement: "raw"
        scan_interval: 10
        slave: 3

      - name: "EHW T06 raw A"
        unique_id: ehw_t06_raw_a
        address: 2023
        input_type: holding
        data_type: uint16
        unit_of_measurement: "raw"
        scan_interval: 10
        slave: 3

      - name: "EHW T06 raw B"
        unique_id: ehw_t06_raw_b
        address: 2024
        input_type: holding
        data_type: uint16
        unit_of_measurement: "raw"
        scan_interval: 10
        slave: 3

      # Setpoint RAW (1104/1105, A = doc_reg - 1, B = doc_reg)
      - name: "EHW setpoint 1104 raw A"
        unique_id: ehw_setpoint_1104_raw_a
        address: 1103
        input_type: holding
        data_type: uint16
        unit_of_measurement: "raw"
        scan_interval: 10
        slave: 3

      - name: "EHW setpoint 1104 raw B"
        unique_id: ehw_setpoint_1104_raw_b
        address: 1104
        input_type: holding
        data_type: uint16
        unit_of_measurement: "raw"
        scan_interval: 10
        slave: 3

      - name: "EHW setpoint 1105 raw A"
        unique_id: ehw_setpoint_1105_raw_a
        address: 1104
        input_type: holding
        data_type: uint16
        unit_of_measurement: "raw"
        scan_interval: 10
        slave: 3

      - name: "EHW setpoint 1105 raw B"
        unique_id: ehw_setpoint_1105_raw_b
        address: 1105
        input_type: holding
        data_type: uint16
        unit_of_measurement: "raw"
        scan_interval: 10
        slave: 3

input_select:
  ehw_address_mode:
    name: EHW address mode
    options:
      - doc_1_based
      - doc_0_based
    initial: doc_1_based

input_boolean:
  ehw_swap_top_bottom:
    name: EHW swap top/bottom
    icon: mdi:swap-vertical
    initial: false

input_number:
  ehw_temp_scale:
    name: EHW temp scale
    min: 0.01
    max: 5
    step: 0.01
    mode: slider
    initial: 0.3
  ehw_temp_offset:
    name: EHW temp offset
    min: -20
    max: 20
    step: 0.1
    mode: slider
    initial: 0.0
  ehw_setpoint_scale:
    name: EHW setpoint scale
    min: 0.01
    max: 5
    step: 0.01
    mode: slider
    initial: 0.3
  ehw_setpoint_offset:
    name: EHW setpoint offset
    min: -20
    max: 20
    step: 0.1
    mode: slider
    initial: 0.0

template:
  - sensor:
      - name: "EHW T01 raw"
        unique_id: ehw_t01_raw
        unit_of_measurement: "raw"
        state: >-
          {% if is_state('input_select.ehw_address_mode', 'doc_1_based') %}
            {{ states('sensor.ehw_t01_raw_a') }}
          {% else %}
            {{ states('sensor.ehw_t01_raw_b') }}
          {% endif %}
      - name: "EHW T02 raw"
        unique_id: ehw_t02_raw
        unit_of_measurement: "raw"
        state: >-
          {% if is_state('input_select.ehw_address_mode', 'doc_1_based') %}
            {{ states('sensor.ehw_t02_raw_a') }}
          {% else %}
            {{ states('sensor.ehw_t02_raw_b') }}
          {% endif %}
      - name: "EHW T03 raw"
        unique_id: ehw_t03_raw
        unit_of_measurement: "raw"
        state: >-
          {% if is_state('input_select.ehw_address_mode', 'doc_1_based') %}
            {{ states('sensor.ehw_t03_raw_a') }}
          {% else %}
            {{ states('sensor.ehw_t03_raw_b') }}
          {% endif %}
      - name: "EHW T04 raw"
        unique_id: ehw_t04_raw
        unit_of_measurement: "raw"
        state: >-
          {% if is_state('input_select.ehw_address_mode', 'doc_1_based') %}
            {{ states('sensor.ehw_t04_raw_a') }}
          {% else %}
            {{ states('sensor.ehw_t04_raw_b') }}
          {% endif %}
      - name: "EHW T05 raw"
        unique_id: ehw_t05_raw
        unit_of_measurement: "raw"
        state: >-
          {% if is_state('input_select.ehw_address_mode', 'doc_1_based') %}
            {{ states('sensor.ehw_t05_raw_a') }}
          {% else %}
            {{ states('sensor.ehw_t05_raw_b') }}
          {% endif %}
      - name: "EHW T06 raw"
        unique_id: ehw_t06_raw
        unit_of_measurement: "raw"
        state: >-
          {% if is_state('input_select.ehw_address_mode', 'doc_1_based') %}
            {{ states('sensor.ehw_t06_raw_a') }}
          {% else %}
            {{ states('sensor.ehw_t06_raw_b') }}
          {% endif %}
      - name: "EHW setpoint raw A"
        unique_id: ehw_setpoint_raw_a
        unit_of_measurement: "raw"
        state: >-
          {% if is_state('input_select.ehw_address_mode', 'doc_1_based') %}
            {{ states('sensor.ehw_setpoint_1104_raw_a') }}
          {% else %}
            {{ states('sensor.ehw_setpoint_1104_raw_b') }}
          {% endif %}
      - name: "EHW setpoint raw B"
        unique_id: ehw_setpoint_raw_b
        unit_of_measurement: "raw"
        state: >-
          {% if is_state('input_select.ehw_address_mode', 'doc_1_based') %}
            {{ states('sensor.ehw_setpoint_1105_raw_a') }}
          {% else %}
            {{ states('sensor.ehw_setpoint_1105_raw_b') }}
          {% endif %}
      - name: "EHW tank top raw"
        unique_id: ehw_tank_top_raw
        unit_of_measurement: "raw"
        state: >-
          {% if is_state('input_boolean.ehw_swap_top_bottom', 'on') %}
            {{ states('sensor.ehw_t03_raw') }}
          {% else %}
            {{ states('sensor.ehw_t02_raw') }}
          {% endif %}
      - name: "EHW tank bottom raw"
        unique_id: ehw_tank_bottom_raw
        unit_of_measurement: "raw"
        state: >-
          {% if is_state('input_boolean.ehw_swap_top_bottom', 'on') %}
            {{ states('sensor.ehw_t02_raw') }}
          {% else %}
            {{ states('sensor.ehw_t03_raw') }}
          {% endif %}
      - name: "EHW setpoint raw"
        unique_id: ehw_setpoint_raw
        unit_of_measurement: "raw"
        state: >-
          {% if is_state('input_select.ehw_address_mode', 'doc_1_based') %}
            {{ states('sensor.ehw_setpoint_raw_a') }}
          {% else %}
            {{ states('sensor.ehw_setpoint_raw_b') }}
          {% endif %}
      - name: "EHW tank top"
        unique_id: ehw_tank_top
        device_class: temperature
        unit_of_measurement: "°C"
        state_class: measurement
        state: >-
          {% set raw = states('sensor.ehw_tank_top_raw') | float(none) %}
          {% set scale = states('input_number.ehw_temp_scale') | float(0) %}
          {% if scale == 0 or scale is none %}
            {% set scale = 0.3 %}
          {% endif %}
          {% set offset = states('input_number.ehw_temp_offset') | float(0) %}
          {% if raw is none %}
            unknown
          {% else %}
            {% set val = raw * scale + offset %}
            {% if val < 0 or val > 90 %}
              unknown
            {% else %}
              {{ val | round(1) }}
            {% endif %}
          {% endif %}
      - name: "EHW tank bottom"
        unique_id: ehw_tank_bottom
        device_class: temperature
        unit_of_measurement: "°C"
        state_class: measurement
        state: >-
          {% set raw = states('sensor.ehw_tank_bottom_raw') | float(none) %}
          {% set scale = states('input_number.ehw_temp_scale') | float(0) %}
          {% if scale == 0 or scale is none %}
            {% set scale = 0.3 %}
          {% endif %}
          {% set offset = states('input_number.ehw_temp_offset') | float(0) %}
          {% if raw is none %}
            unknown
          {% else %}
            {% set val = raw * scale + offset %}
            {% if val < 0 or val > 90 %}
              unknown
            {% else %}
              {{ val | round(1) }}
            {% endif %}
          {% endif %}
      - name: "EHW setpoint"
        unique_id: ehw_setpoint
        device_class: temperature
        unit_of_measurement: "°C"
        state_class: measurement
        state: >-
          {% set raw = states('sensor.ehw_setpoint_raw') | float(none) %}
          {% set scale = states('input_number.ehw_setpoint_scale') | float(0) %}
          {% if scale == 0 or scale is none %}
            {% set scale = 0.3 %}
          {% endif %}
          {% set offset = states('input_number.ehw_setpoint_offset') | float(0) %}
          {% if raw is none %}
            unknown
          {% else %}
            {% set val = raw * scale + offset %}
            {% if val < 0 or val > 90 %}
              unknown
            {% else %}
              {{ val | round(1) }}
            {% endif %}
          {% endif %}
      - name: "EHW delta stratificazione"
        unique_id: ehw_delta_stratificazione
        unit_of_measurement: "°C"
        state_class: measurement
        state: >-
          {% if is_number(states('sensor.ehw_tank_top')) and is_number(states('sensor.ehw_tank_bottom')) %}
            {{
              (
                (states('sensor.ehw_tank_top') | float(0))
                - (states('sensor.ehw_tank_bottom') | float(0))
              ) | round(1)
            }}
          {% else %}
            unknown
          {% endif %}
      - name: "EHW status"
        unique_id: ehw_status
        state: >-
          {% if is_state('binary_sensor.ehw_running', 'on') %}
            In funzione
          {% else %}
            Spento
          {% endif %}
  - binary_sensor:
      - name: "EHW running"
        unique_id: ehw_running
        state: >-
          {% set has_raw = is_number(states('sensor.ehw_setpoint_raw')) and is_number(states('sensor.ehw_tank_top_raw')) %}
          {% set has_scaled = is_number(states('sensor.ehw_setpoint')) and is_number(states('sensor.ehw_tank_top')) %}
          {% if has_raw and has_scaled %}
            {{ (states('sensor.ehw_setpoint') | float(0)) - (states('sensor.ehw_tank_top') | float(0)) >= 1.0 }}
          {% else %}
            false
          {% endif %}
